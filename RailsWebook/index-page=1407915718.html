<!DOCTYPE html>
<html
  lang="ja"
data-avail-langs="ja en"

data-page="index"
data-static-domain="https://blog.st-hatena.com"
data-blog="ruby-rails.hatenadiary.com"
data-blog-name="Rails Webook"
data-blogs-uri-base="http://ruby-rails.hatenadiary.com"
data-globalheader-color="b"
data-author="nipe880324"
data-version="228df9a6e5a3ae04fdb53d33befa3556"
data-blog-comments-top-is-new=""
data-plus-available=""



data-admin-domain="http://blog.hatena.ne.jp"

data-brand="hatenablog"

data-has-touch-view="1"


itemscope
itemtype="http://schema.org/Blog"


  data-device="pc"
  data-globalheader-type="pc"
  >
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb#">
    
    
    

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=7; IE=9; IE=10; IE=11" />
    <title>Rails Webook</title>

    

    
      <link rel="canonical" href="index.html"/>
    

    
    

<meta itemprop="name" content="Rails Webook"/>

  <meta itemprop="image" content="https://blog.st-hatena.com/images/theme/og-image-1500.png"/>


    <meta property="og:title" content="Rails Webook"/>
<meta property="og:type" content="blog"/>
<meta property="og:url" content="http://ruby-rails.hatenadiary.com/"/>

  
  
  
  <meta property="og:image" content="https://blog.st-hatena.com/images/theme/og-image-1500.png"/>

  <meta property="og:description" content="自社のECを開発している会社で働いています。Rails情報やサービスを成長させる方法を書いていきます" />
<meta property="og:site_name" content="http://ruby-rails.hatenadiary.com/"/>

        <meta name="twitter:card"  content="summary_large_image" />
    <meta name="twitter:image" content="http://f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802105152.png" />
  <meta name="twitter:title" content="Rails Webook" />  <meta name="twitter:description" content="自社のECを開発している会社で働いています。Rails情報やサービスを成長させる方法を書いていきます" />  <meta name="twitter:app:name:iphone" content="はてなブログアプリ" />
  <meta name="twitter:app:id:iphone" content="583299321" />
  <meta name="twitter:app:url:iphone" content="hatenablog:///open?uri=http%3A%2F%2Fruby-rails.hatenadiary.com%2F%3Fpage%3D1407915718" />  <meta name="twitter:site" content="@nipe032488" />
    
    <meta name="description" content="毎週更新。Railsプログラマがソフトウェア開発を効果的・効率的にするために、分かりやすく・使いやすい形でRailsに関する技術情報を記載。">    <meta name="google-site-verification" content="OyOieuLgSrQckqbACTn_Q3G1dPq6LMlTqBRHa6V1XsA">    <meta name="keywords" content="Rails,Ruby on Rails,gem,Webアプリケーション,開発,構築,運用,インフラ">

    
<script type="text/javascript">
// <!--

if (~navigator.userAgent.indexOf('Mac OS X')) {
  document.write('<style type="text/css">html, body { font-family: \x27Helvetica\x27, \x27Arial\x27, \x27ヒラギノ角ゴ Pro W3\x27, \x27Hiragino Kaku Gothic Pro\x27, sans-serif; } </style>');
} else {
  document.write('<style type="text/css">html, body { font-family: \x27Helvetica\x27, \x27Arial\x27, \x27メイリオ\x27, \x27Meiryo\x27, \x27MS PGothic\x27, sans-serif; } </style>');
}

// -->
</script>

<!--[if lt IE 9]>
<script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->




    <link rel="shortcut icon" href="https://blog.st-hatena.com/images/favicon.ico">
<link rel="icon" sizes="192x192" href="https://blog.st-hatena.com/images/common/meta-icon-global.png">

    
<link rel="alternate" type="application/atom+xml" title="Atom" href="feed"/>
<link rel="alternate" type="application/rss+xml" title="RSS2.0" href="rss.rss"/>


      <link rel="author" href="http://www.hatena.ne.jp/nipe880324/">
    

    <link rel="stylesheet" type="text/css" href="https://blog.st-hatena.com/css/blog.css?version=228df9a6e5a3ae04fdb53d33befa3556"/>

    
  <link rel="stylesheet" type="text/css" href="http://blog.hatena.ne.jp/-/blog_style/12921228815727789780/a052dbbef76fd4380abc811c11814f2d9f990b9a"/>

    <script></script>

    
<style>div#google_afc_user,
  div#google_afc_user_container_0,
  div#google_afc_user_container_1,
  div#google_afc_user_container_2,
  div#google_afc_user_container_3,
  div#google_afc_user_container_4,
  div#google_afc_user_container_5,
  div.google_afc_image,
  div.google_afc_blocklink {
      display: block !important;
  }
</style>


    
  </head>

  <body class="page-index enable-top-editarea enable-bottom-editarea">
    <!-- Google Universal Analytics -->
<script id="google-analytics-script">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29716941-6', 'auto', {'name': 'HatenaBlogTracker', 'sampleRate': 1});
  ga('HatenaBlogTracker.require', 'displayfeatures');
  ga('HatenaBlogTracker.send', 'pageview');
  ga('create', 'UA-29716941-26', 'auto', {'name': 'HatenaBlogSeparatedTracker', 'sampleRate': 10});
  ga('HatenaBlogSeparatedTracker.require', 'displayfeatures');
  ga('HatenaBlogSeparatedTracker.send', 'pageview');

    
      ga('create', 'UA-45988509-6', 'auto', {'name': 'HatenaBlogUserTracker'});
      ga('HatenaBlogUserTracker.require', 'displayfeatures');
      ga('HatenaBlogUserTracker.send', 'pageview');
    
  
  ga('create', 'UA-7855606-1', 'auto', {'name': 'HatenaGlobalTracker', 'sampleRate': 1});
  ga('HatenaGlobalTracker.require', 'displayfeatures');
  ga('HatenaGlobalTracker.send', 'pageview');
</script>
<!-- End Google Universal Analytics -->

    
    <div id="header-container">
     <div id="sp-suggest" style="display: none;"><a id="sp-suggest-link" href="index-page=1407915718.html#">スマートフォン用の表示で見る</a></div>
    </div>

    

<div class="quote-box">
  <div class="tooltip-quote tooltip-quote-star">
    <i class="blogicon-star" title="引用スターをつける"></i>
  </div>
  <div class="tooltip-quote tooltip-quote-stock">
    <i class="blogicon-quote" title="引用をストック"></i>
  </div>
</div>

<div class="message-box" id="quote-star-message-box" style="display: none; position: absolute;">
  スターをつけました
</div>

<div class="quote-stock-panel" id="quote-stock-message-box" style="position: absolute; z-index: 3000">
  <div class="message-box" id="quote-stock-succeeded-message" style="display: none">
    <p>引用をストックしました</p>
    <button class="btn btn-primary" id="quote-stock-show-editor-button" data-track-name="curation-quote-edit-button">ストック一覧を見る</button>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="message-box" id="quote-login-required-message" style="display: none">
    <p>引用するにはまずログインしてください</p>
    <button class="btn btn-primary" id="quote-login-button">ログイン</button>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="error-box" id="quote-stock-failed-message" style="display: none">
    <p>引用をストックできませんでした。再度お試しください</p>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="error-box" id="unstockable-quote-message-box" style="display: none; position: absolute; z-index: 3000;">
    <p>限定公開記事のため引用できません。</p>
  </div>
</div>

<script type="x-underscore-template" id="js-requote-button-template">
  <div class="requote-button js-requote-button">
    <button class="requote-button-btn tipsy-top" title="引用する"><i class="blogicon-quote"></i></button>
  </div>
</script>


    <div id="globalheader-container" >
  <iframe id="globalheader" height="37" frameborder="0" allowTransparency="true"></iframe>
</div>


    
    <div id="hidden-subscribe-button">
      <div class="hatena-follow-button-box btn-subscribe js-hatena-follow-button-box"
  
  >

  <a href="index-page=1407915718.html#" class="hatena-follow-button js-hatena-follow-button">
    <span class="subscribing">
      <span class="foreground">読者です</span>
      <span class="background">読者をやめる</span>
    </span>
    <span class="unsubscribing" data-track-name="profile-widget-subscribe-button" data-track-once>
      <span class="foreground">読者になる</span>
      <span class="background">読者になる</span>
    </span>
  </a>
  <div class="subscription-count-box js-subscription-count-box">
    <i></i>
    <u></u>
    <span class="subscription-count js-subscription-count">
    </span>
  </div>
</div>

    </div>

    <div id="container">
      <div id="container-inner">
        <header id="blog-title" data-brand="hatenablog">
  <div id="blog-title-inner" >
    <div id="blog-title-content">
      <h1 id="title"><a href="index.html">Rails Webook</a></h1>
      
        <h2 id="blog-description">自社のECを開発している会社で働いています。Rails情報やサービスを成長させる方法を書いていきます</h2>
      
    </div>
  </div>
</header>

        
          <div id="top-editarea">
            <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
mixpanel.init("16db652100dca0a23c6a55a9205f0824");</script><!-- end Mixpanel -->
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- rails top bar 728 x 90 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-2736751992834286"
     data-ad-slot="6687328050"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

          </div>
        
        
        



<div id="content" class="hfeed"
  
  >
  <div id="content-inner">
    <div id="wrapper">
      <div id="main">
        <div id="main-inner">
          
            
            <!-- google_ad_section_start -->
            <!-- rakuten_ad_target_begin -->
            
              
                <article class="entry hentry js-entry-article date-first autopagerize_page_element chars-11200 words-1000 mode-hatena entry-odd" id="entry-12921228815729890967" data-keyword-campaign="" data-uuid="12921228815729890967">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date first">
        <a href="entries/2014/08/10.html" rel="nofollow">
          <time pubdate datetime="2014-08-10T01:30:00Z" title="2014-08-10T01:30:00Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">10</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140810/1407634200.html" class="entry-title-link bookmark">Railsのmigrationの基本とレシピ集</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%E5%88%9D%E7%B4%9A.html">Rails初級</a>
          
          <a href="archive/category/Rails%20Migration.html">Rails Migration</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p>RailsのMigrationの基本的なことから、カラム追加/削除、インデックス追加、NULL制約、カラム名変更などのレシピ集をまとめました。</p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<div class="section">
    <h4>1. <a href="index-page=1407915718.html#migration-basic">Migrationの基礎</a></h4>
    <p>1.1. <a href="index-page=1407915718.html#migration-create">migrationファイルの作成</a><br />
1.2. <a href="index-page=1407915718.html#migration-migrate">マイグレートの実施 rake db:migrateコマンド</a><br />
1.3. <a href="index-page=1407915718.html#migration-migrate-status">マイグレートの適用状況確認 rake db:migrate:statusコマンド</a><br />
1.4. <a href="index-page=1407915718.html#migration-seeds">データの投入 rake db:seedコマンド</a><br />
1.5. <a href="index-page=1407915718.html#migration-datatypes">マイグレーションで使えるデータ型一覧</a></p>

</div>
<div class="section">
    <h4>2. <a href="index-page=1407915718.html#migration-recipes">Migrationのレシピ集</a></h4>
    <p>2.1. <a href="index-page=1407915718.html#migration-add-column">カラムの追加（add_column）</a><br />
2.2. <a href="index-page=1407915718.html#migration-remove-column">カラムの削除（remove_column）</a><br />
2.3. <a href="index-page=1407915718.html#migration-change-datatype">データ型の変更（change_column）</a><br />
2.4. <a href="index-page=1407915718.html#migration-add-remove-index">インデックスやユニーク制約の追加/削除（add_index/remove_index）</a><br />
2.5. <a href="index-page=1407915718.html#migration-change-column-null">NULL制約の追加/削除（change_column_null)</a><br />
2.6. <a href="index-page=1407915718.html#migration-change-column-default">デフォルト値の追加/削除（change_column_default)</a><br />
2.7. <a href="index-page=1407915718.html#migration-rename-column">カラム名の変更（rename_column）</a><br />
2.8. <a href="index-page=1407915718.html#migration-create-table">テーブルの作成（create_table）</a><br />
2.9. <a href="index-page=1407915718.html#migration-drop-table">テーブルの削除（drop_table）</a><br />
2.10. <a href="index-page=1407915718.html#migration-rename-tabel">テーブル名の変更（rename_table）</a><br />
2.11. <a href="index-page=1407915718.html#migration-add-initial-data">商用リリース後の初期データの投入</a></p><p><h3 id="migration-basic">1. Migrationの基礎</h3><h4 id="migration-create">1.1. migrationファイルの作成</h4>Railsのmigrationはデータベースのスキーマの設定管理を一貫して規則正しく行うための基盤です。<br />
migrationファイルを作成するには、「手動でファイルを作成する方法」と「<code>$ rails generate</code>コマンドで作成する方法」の２つの作成方法があります。<br />
<code>$ rails generate</code>コマンドで作成する方がエラーが発生しづらいためそちらの方法でのファイル作成方法を説明します。</p><p>Railsジェネレートコマンドも<br />
「モデルとマイグレーションファイルを作成する<code>$ rails g model</code>」<br />
「マイグレーションファイルのみを作成する<code>$ rails g migration</code>」<br />
があります。</p><p><i>※<code>g</code>は<code>generate</code>のショートカットです。</i><br />
</p>

<div class="section">
    <h5>モデルとマイグレーションファイルを作成</h5>
    <p>以下のコマンドで<code>Article</code>モデルとマイグレーションファイルを作成します。<br />
また、<code>Article</code>モデルには、String型のtitle、Text型のcontentカラムがあります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g model <span class="synType">Article</span> title<span class="synConstant">:string</span> content<span class="synConstant">:text</span>
      invoke  active_record
      create    db/migrate/20140808181112_create_articles.rb
      create    app/models/article.rb
      invoke    test_unit
      create      test/models/article_test.rb
      create      test/fixtures/articles.yml
</pre><p>マイグレートファイルは<code>db/migrate</code>配下に作成されます。<br />
また、ファイル名には、YYYYMMDDHHmmSSが付与され、ファイル名の重複や、マイグレートファイルがDBに適用済みかどうかを確認するために使われます。</p><p>では、上記のコマンドで作成されたマイグレーションファイルを見てみましょう。<br />
マイグレーションファイルは、<code>ActiveRecord::Migration</code>を継承している必要があります。<br />
メソッドは、<code>change</code>メソッド、もしくは、<code>up</code>と<code>down</code>メソッを定義している必要があります。<br />
その中で、テーブル作成/削除、カラム追加/削除などを行います。今回は、<code>create_table</code>メソッドで<code>articles</code>というテーブルを作成し、ブロック内でカラムを追加しています。</p><p><i>※<code>timestamps</code>は、レコードの作成時刻の<code>created_at</code>と更新時刻の<code>updated_at</code>をカラムを作成してくれます。明示的に追加しなくても自動でマイグレーションファイルに追加され、また、カラムの値は自動で更新されます。</i></p><p>各メソッドの詳細は、本ページのレシピ集に記載してます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808181112_create_articles.rb</span>
<span class="synPreProc">class</span> <span class="synType">CreateArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    create_table <span class="synConstant">:articles</span> <span class="synStatement">do</span> |<span class="synIdentifier">t</span>|
      t.string <span class="synConstant">:title</span>
      t.text <span class="synConstant">:content</span>

      t.timestamps
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><i>※<code>up</code>と<code>down</code>は、<code>change</code>メソッドの代わりに使います。<br />
<code>up</code>は<code>rake db:migrate</code>の実行時に実行され、<code>down</code>は<code>rake db:rollback</code>時に実行されます。<br />
<code>change</code>メソッドのときは、内部的に可逆性を推定して実施しますが、必ずしも推定できない場合は<code>up/down</code>で定義しておくことによりロールバックができるようになります。ロールバックは必須ではないので、わざわざ<code>up/down</code>を実施しなくてもよいです。<br />
上記のマイグレーションファイルをup/downで書き直した例は次の通りです。</i><br />
</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808181112_create_articles.rb</span>
<span class="synPreProc">class</span> <span class="synType">CreateArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">up</span>
    create_table <span class="synConstant">:articles</span> <span class="synStatement">do</span> |<span class="synIdentifier">t</span>|
      t.string <span class="synConstant">:title</span>
      t.text <span class="synConstant">:content</span>

      t.timestamps
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>

  <span class="synPreProc">def</span> <span class="synIdentifier">down</span>
    drop_table <span class="synConstant">:articles</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre>
</div>
<div class="section">
    <h5>マイグレーションファイルのみを作成</h5>
    <p>マイグレーションファイルのみを作成する場合は、<code>rails g migration</code>です。<br />
内容は上記で説明したので省略します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration create_articles title<span class="synConstant">:string</span> content<span class="synConstant">:text</span>
      invoke  active_record
      create    db/migrate/20140808181236_create_articles.rb
</pre><p><br />
作成されたマイグレーションファイルを確認します。<br />
内容は<code>rails g model</code>と同じです。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808181236_create_articles.rb</span>
<span class="synPreProc">class</span> <span class="synType">CreateArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    create_table <span class="synConstant">:articles</span> <span class="synStatement">do</span> |<span class="synIdentifier">t</span>|
      t.string <span class="synConstant">:title</span>
      t.text <span class="synConstant">:content</span>
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p></p><p><h4 id="migration-migrate">1.2. マイグレートの実施 rake db:migrateコマンド</h4><code>rake db:migrate</code>コマンドで適用していないマイグレーションファイルを全て適用することができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:migrate</span>

<span class="synComment"># RAILS_ENV をしていすることでマイグレートする環境を指定できます</span>
$ rake db<span class="synConstant">:migrate</span> <span class="synType">RAILS_ENV</span>=test             <span class="synComment"># test環境に適用</span>
$ rake db<span class="synConstant">:migrate</span> <span class="synType">RAILS_ENV</span>=production  <span class="synComment"># production環境に適用</span>
</pre><p><br />
適用したマイグレートファイル１つだけ未適用状態にする（ロールバック）<br />
<code>down</code>メソッドが定義されていない場合は失敗する場合もあります。詳細は上記を参照して下さい。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:rollback</span>
</pre><p>最初の状態までロールバックする</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:migrate</span> <span class="synType">VERSION</span>=<span class="synConstant">0</span>
</pre><p>全てのテーブルとデータをを削除し、スキーマ(schema.rbの内容)を適用する。ロールバックできない場合に使える。<br />
本当にどうしようもない場合は、直接データベースにアクセスし、テーブルを削除して、マイグレートを適用させましょう。<br />
<i>schema.rbはdb:migrateの結果をマージしたファイルです。</i></p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:reset</span>
</pre><p><br />
<h4 id="migration-migrate-status">1.3. マイグレートの適用状況確認 rake db:migrate:statusコマンド</h4>次のコマンドで、現在データベースに適用されているマイグレーションファイルを確認します。<br />
<code>Migration ID</code>がマイグレーションファイルの<code>YYYYMMDDHHmmSS</code>に対応しています。</p>
<pre class="code" data-lang="" data-unlink>$ rake db:migrate:status 

database: /Users/nipe0324/rails_project/db/development.sqlite3

 Status   Migration ID    Migration Name
--------------------------------------------------
   up     20141008133536  Create pictures
   up     20141008133734  Add attachment photo to pictures</pre><p><br />
<h4 id="migration-seeds">1.4. データの投入 rake db:seedコマンド</h4>初期データをデータベースに投入するために、<code>db/seeds.rb</code>が存在します。<br />
この中はRubyが記載でき、Rubyでモデルを作成します。</p><p><i>※本番環境などデータを削除することができない場合は、この<code>db/seeds.rb</code>を使うことは適切ではありません。「<a href="index-page=1407915718.html#migration-add-initial-data">商用リリース後の初期データの投入</a>」を参照して下さい。</i></p><p><code>seeds.rb</code>を記載したら、<code>rake db:seed</code>コマンドで実行することができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:seed</span>
</pre><p>ここではサンプルとして、３つの記事（Articleオブジェクト）を作成して適用します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment">### モデルとマイグレーションファイルを作成</span>
$ rails g model <span class="synType">Article</span> title<span class="synConstant">:string</span> content<span class="synConstant">:text</span>

<span class="synComment">### マイグレートを実施</span>
$ rails db<span class="synConstant">:migrate</span>

<span class="synComment">### db/seeds.rbに初期データ投入を記載</span>
$ vim db/seeds.rb
<span class="synComment"># 記事を3つ作成</span>
<span class="synType">Article</span>.create!( <span class="synConstant">title</span>: <span class="synSpecial">&quot;</span><span class="synConstant">記事1</span><span class="synSpecial">&quot;</span>, <span class="synConstant">content</span>: <span class="synSpecial">&quot;</span><span class="synConstant">内容1</span><span class="synSpecial">&quot;</span> )
<span class="synType">Article</span>.create!( <span class="synConstant">title</span>: <span class="synSpecial">&quot;</span><span class="synConstant">記事2</span><span class="synSpecial">&quot;</span>, <span class="synConstant">content</span>: <span class="synSpecial">&quot;</span><span class="synConstant">内容2</span><span class="synSpecial">&quot;</span> )
<span class="synType">Article</span>.create!( <span class="synConstant">title</span>: <span class="synSpecial">&quot;</span><span class="synConstant">記事3</span><span class="synSpecial">&quot;</span>, <span class="synConstant">content</span>: <span class="synSpecial">&quot;</span><span class="synConstant">内容3</span><span class="synSpecial">&quot;</span> )

<span class="synComment">### db/seeds.rbを適用</span>
$ rake db<span class="synConstant">:seed</span>

<span class="synComment">### コンソールでデータが入ったことを確認</span>
$ rails c
<span class="synType">Loading</span> development environment (<span class="synType">Rails</span> <span class="synConstant">4.1</span>.<span class="synConstant">4</span>)
&gt; <span class="synType">Article</span>.all
=&gt; <span class="synComment">#&lt;ActiveRecord::Relation [#&lt;Article id: 1, title: &quot;記事1&quot;, content: &quot;内容1&quot;, created_at: &quot;2014-08-08 19:41:31&quot;, updated_at: &quot;2014-08-08 19:41:31&quot;&gt;, #&lt;Article id: 2, title: &quot;記事2&quot;, content: &quot;内容2&quot;, created_at: &quot;2014-08-08 19:41:31&quot;, updated_at: &quot;2014-08-08 19:41:31&quot;&gt;, #&lt;Article id: 3, title: &quot;記事3&quot;, content: &quot;内容3&quot;, created_at: &quot;2014-08-08 19:41:31&quot;, updated_at: &quot;2014-08-08 19:41:31&quot;&gt;]&gt;</span>
</pre><p><br />
<h4 id="migration-datatypes">1.5. マイグレーションで使えるデータ型一覧</h4><code>rails generator model</code>や<code>rails generator migration</code>コマンドで使えるデータ型として以下のものがあります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>integer 整数
float 浮動小数
decimal 制度の高い小数

string 文字列
text  長い文字列
binary バイナリデータ

datetime 日時
timestamp より細かい日時
date 日付
time 時間

boolean <span class="synType">Boolean</span>型(<span class="synConstant">true</span> <span class="synStatement">or</span> <span class="synConstant">false</span>)

primary_key 主キー
references 外部キー
</pre><p></p><p><h3 id="migration-recipes">2. Migrationのレシピ集</h3><h4 id="migration-add-column">2.1 カラムの追加（add_column）</h4><code>articles</code>テーブルに<code>user_id</code>カラムを追加してみます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration add_user_id_to_articles user_id<span class="synConstant">:integer</span>
      invoke  active_record
      create    db/migrate/20140808182214_add_user_id_to_articles.rb
</pre><p>作成されたマイグレーションファイルを確認しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808182214_add_user_id_to_articles.rb </span>
<span class="synPreProc">class</span> <span class="synType">AddColumnToArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    <span class="synComment"># [形式] add_column(テーブル名, カラム名, データ型)</span>
    add_column <span class="synConstant">:articles</span>, <span class="synConstant">:user_id</span>, <span class="synConstant">:integer</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>さらに、<code>add_column</code>には次のオプションを指定できます。</p>

<ul>
<li>null: true  ... NOT NULL制約を削除</li>
<li>null: false ... NOT NULL制約を追加</li>
<li>limit: size ... フィールドのサイズに対する制限を設定</li>
<li>default: [val] ... [val] に設定した値をレコード作成時のカラムのデフォルト値とする</li>
</ul><p>さらにさらに、decimal型の場合は追加で以下のオプションも指定できます。<br />
 - precision: [num], scale: [num] ... precisionは格納される桁数、scaleはその桁数のどこを小数点位置にするかを設定<br />
 　※ 例えば、precision: 5, scale: 2 の場合、 5桁で小数点は2桁目のため、格納できる値は -999.99〜+999.99となる</p><br />
<br />
<p><h4 id="migration-remove-column">2.2. カラムの削除（remove_column）</h4><code>articles</code>テーブルに<code>user_id</code>カラムを削除してみます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration remove_user_id_to_articles user_id
      invoke  active_record
      create    db/migrate/20140808182248_remove_user_id_to_articles.rb
</pre><p>作成されたマイグレーションファイルを見てみましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment">#db/migrate/20140808182248_remove_user_id_to_articles.rb</span>
<span class="synPreProc">class</span> <span class="synType">RemoveColumnToArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    <span class="synComment"># [形式] remove_column(テーブル名, カラム名)</span>
    remove_column <span class="synConstant">:articles</span>, <span class="synConstant">:user_id</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><i>※ ロールバック時にカラムの追加方法が分からないため<code>$ rake db:rollback</code>でエラーになります。もし、rollbackをしたい場合、up/downメソッドを定義し、downメソッド内でテーブルを作成する必要があります。</i></p><br />
<p><h4 id="migration-change-datatype">2.3. データ型の変更（change_column）</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration change_datatype_title_of_articles
      invoke  active_record
      create    db/migrate/20140808183810_change_datatype_title_of_articles.rb
</pre><p>マイグレーションファイルに<code>change_column</code>メソッドを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808183810_change_datatype_title_of_articles.rb</span>
<span class="synPreProc">class</span> <span class="synType">ChangeDatatypeTitleOfArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    <span class="synComment"># [形式] change_column(テーブル名, カラム名, データタイプ, オプション)</span>
    change_column <span class="synConstant">:articles</span>, <span class="synConstant">:title</span>, <span class="synConstant">:text</span>

    <span class="synComment"># オプション</span>
    <span class="synComment"># limit - カラム長の最大数</span>
    <span class="synComment"># change_column :articles, :title, :text, limit: 120</span>

    <span class="synComment"># default - カラムのデフォルト値を設定。NULLにしたい場合は、nilを指定</span>
    <span class="synComment"># change_column :articles, :title, :text, default: &quot;タイトルがありません&quot;</span>

    <span class="synComment"># null - null制約を設定。false -&gt; null制約がON。true -&gt; null制約がOFF</span>
    <span class="synComment"># change_column :articles, :title, :text, null: true</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><h4 id="migration-add-remove-index">2.4. インデックスやユニーク制約の追加/削除（add_index/remove_index）</h4>articlesテーブルのtitleカラムにindexを追加しています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration add_name_index_to_articles
      invoke  active_record
      create    db/migrate/20140808183810_add_name_index_to_articles.rb
</pre><p>マイグレーションファイルに<code>add_index</code>を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ cat db/migrate/20140808183810_add_name_index_to_articles.rb
<span class="synPreProc">class</span> <span class="synType">AddNameIndexToArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    add_index <span class="synConstant">:articles</span>, <span class="synConstant">:name</span>
  <span class="synComment"># add_index :articles, :name, unique: true ユニーク制約も付加可能</span>
  <span class="synComment"># add_index :articles, [:user_id, :created_at] 配列を使うことにより複合インデックスを設定可能</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><br />
<h4 id="migration-change-column-null">2.5. NULL制約の追加/削除（change_column_null)</h4>NULL制約の追加や削除のみを設定するには<code>change_column_null</code>メソッドを使えば簡単です。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># usersテーブルのnicknameを &quot;NULL&quot; を許可しない(NOT NULL制約を追加)</span>
change_column_null <span class="synConstant">:users</span>, <span class="synConstant">:nickname</span>, <span class="synConstant">false</span>

<span class="synComment"># usersテーブルのnicknameを &quot;NULL&quot; を許可する</span>
change_column_null <span class="synConstant">:users</span>, <span class="synConstant">:nickname</span>, <span class="synConstant">true</span>
</pre><p><br />
<h4 id="migration-change-column-default">2.6. デフォルト値の追加/削除（change_column_default)</h4>カラムのデフォルト値の追加や削除のみを設定するには<code>change_column_default</code>メソッドを使えば簡単です。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># suppliersテーブルのqualificationカラムのデフォルト値を 'new' を設定</span>
change_column_default <span class="synConstant">:suppliers</span>, <span class="synConstant">:qualification</span>, <span class="synSpecial">'</span><span class="synConstant">new</span><span class="synSpecial">'</span>

<span class="synComment"># accountsテーブルのauthorizedカラムのデフォルト値を 1 を設定</span>
change_column_default <span class="synConstant">:accounts</span>, <span class="synConstant">:authorized</span>, <span class="synConstant">1</span>

<span class="synComment"># usersテーブルのemailカラムのデフォルト値に NULL を設定</span>
change_column_default <span class="synConstant">:users</span>, <span class="synConstant">:email</span>, <span class="synConstant">nil</span>
</pre><p><h4 id="migration-rename-column">2.7. カラム名の変更（rename_column）</h4>カラム名を "title" から "changed_title" へ変更しています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration rename_title_column_to_articles
      invoke  active_record
      create    db/migrate/20140808184723_rename_title_column_to_articles.rb
</pre><p>マイグレーションファイルに<code>rename_column</code>を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ cat db/migrate/20140808184723_rename_title_column_to_articles.rb
<span class="synPreProc">class</span> <span class="synType">RenameTitleColumnToArticles</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    <span class="synComment"># [形式] rename_column(テーブル名, 変更前のカラム名, 変更後のカラム名)</span>
    rename_column <span class="synConstant">:articles</span>, <span class="synConstant">:title</span>, <span class="synConstant">:changed_title</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><br />
<h4 id="migration-create-table">2.8. テーブルの作成（create_table）</h4>usersテーブルを作成しています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration create_users name<span class="synConstant">:string</span> email<span class="synConstant">:string</span>
      invoke  active_record
      create    db/migrate/20140808185345_create_users.rb
</pre><p><br />
マイグレーションを確認します。<cod>timestamps</code>がない場合は追加して下さい。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ cat  db/migrate/20140808185345_create_users.rb
<span class="synPreProc">class</span> <span class="synType">CreateUsers</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    create_table <span class="synConstant">:users</span> <span class="synStatement">do</span> |<span class="synIdentifier">t</span>|
      t.string <span class="synConstant">:name</span>
      t.string <span class="synConstant">:email</span>

      t.timestamps
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><br />
<h4 id="migration-drop-table">2.9. テーブルの削除（drop_table）</h4>usersテーブルを削除します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration drop_users
      invoke  active_record
      create    db/migrate/20140808185551_drop_users.rb
</pre><p>マイグレーションファイルに<code>drop_table</code>を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ cat db/migrate/20140808185551_drop_users.rb
<span class="synPreProc">class</span> <span class="synType">DropUsers</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    drop_table <span class="synConstant">:users</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><i>※ロールバック時に、テーブルの作成方法が分からないため<code>$ rake db:rollback</code>でエラーになります。もし、rollbackをしたい場合、up/downメソッドを定義し、downメソッド内でテーブルを作成する必要があります。</i></p><br />
<p><h4 id="migration-rename-tabel">2.10. テーブル名の変更（rename_table）</h4>テーブル名を "articles" から "posts" へ変更します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration rename_articles_to_posts
      invoke  active_record
      create    db/migrate/20140808190856_rename_articles_to_posts.rb
</pre><p>マイグレーションに<code>rename_table</code>を追加しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808190856_rename_articles_to_posts.rb</span>
<span class="synPreProc">class</span> <span class="synType">RenameArticlesToPosts</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    rename_table <span class="synConstant">:articles</span>, <span class="synConstant">:posts</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p><br />
<h4 id="migration-add-initial-data">2.11. 商用リリース後の初期データの投入</h4>初回に商用リリースをするときに<code>db/seeds.rb</code>は適用済みであると思います。<br />
そのため、その後にテーブルを追加し、その初期データを投入したいときに<code>db/seeds.rb</code>を使うことができません。</p><p>所用リリース後に初期データを投入するためには、次のようにマイグレートファイルに初期データを投入するコードを作成します。<br />
ここでは、categoriesテーブルを作成したのを前提として、初期のカテゴリーを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration insert_initial_categories_into_categories
      invoke  active_record
      create    db/migrate/20140808190856_insert_initial_categories_into_categories.rb
</pre><p>マイグレーションに<code>rename_table</code>を追加しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140808190856_insert_initial_categories_into_categories.rb</span>
<span class="synPreProc">class</span> <span class="synType">InsertInitialCategoriesIntoCategories</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    names = <span class="synSpecial">%w(</span><span class="synConstant">食費 日用品 交通費 交際費 税金</span><span class="synSpecial">)</span>
    names.each <span class="synStatement">do</span> |<span class="synIdentifier">name</span>|
      <span class="synType">Category</span>.create <span class="synConstant">name</span>: name
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre>
</div>
</div>
</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li><a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html" target="_blank">Rails API - ActiveRecord::ConnectionAdapters::SchemaStatements</a></li>
<li><a href="http://guides.rubyonrails.org/migrations.html" target="_blank">Rails Guide - Migration</a></li>
</ul><p>以上です。<br />
よく分からない箇所や間違いがありましたら、コメントをいただけると直に対応します。</p>

</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140810/1407634200.html"><time data-relative datetime="2014-08-10T01:30:00Z" title="2014-08-10T01:30:00Z" pubdate class="updated">2014-08-10 10:30</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140810/1407634200" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140810%2F1407634200" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407634200" data-count="vertical" data-text="Railsのmigrationの基本とレシピ集 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407634200" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
            
            <div class="google-afc-image test-google-rectangle-ads ">
              
              
                <script>
  var hatenadfp = hatenadfp || {};
  hatenadfp.adUnits = hatenadfp.adUnits || [];
  hatenadfp.adUnits.push(
    
      { unitName: 'blog_user', size: [[300, 250], [336, 280]], divId: 'google_afc_user_container_0', allowContentMatch: true }
    
  );
  hatenadfp.isNGContent = false;
  
</script>

                <div id="google_afc_user_container_0" class="google_afc_blocklink2_5 google_afc_boder"></div>
                
                  <a href="http://blog.hatena.ne.jp/guide/pro" class="open-pro-modal" data-guide-pro-modal-ad-url="http://hatenablog.com/guide/pro/modal/ad">広告を非表示にする</a>
                
                
              
            </div>
          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
                <article class="entry hentry js-entry-article date-middle autopagerize_page_element chars-2400 words-400 mode-hatena entry-even" id="entry-12921228815729883102" data-keyword-campaign="" data-uuid="12921228815729883102">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date middle">
        <a href="entries/2014/08/10.html" rel="nofollow">
          <time pubdate datetime="2014-08-09T22:30:00Z" title="2014-08-09T22:30:00Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">10</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140810/1407623400.html" class="entry-title-link bookmark">Railsのモデルのバリデーションエラー errors や full_messages の使い方</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%E5%88%9D%E7%B4%9A.html">Rails初級</a>
          
          <a href="archive/category/Rails%20Model.html">Rails Model</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p>Railsのモデルのバリデーションエラーの扱い方について説明します。<br />
<code>errors</code>(エラーメッセージオブジェクト)、独自のエラーメッセージの追加、エラーメッセージの表示、日本語化について説明します。<br />
<br />
</p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li><a href="index-page=1407915718.html#erorrs-usage">モデル(model)のエラーメッセージ errors の使い方</a></li>
<li><a href="index-page=1407915718.html#add-error">モデル(model)にエラーメッセージを追加</a></li>
<li><a href="index-page=1407915718.html#view-validation">ビューにモデルのバリデーションエラーを表示</a></li>
<li><a href="index-page=1407915718.html#view-validation-japanese">モデルのバリデーションエラーメッセージを日本語化</a></li>
</ol><p></p><p><h3 id="erorrs-usage">モデル(model)のエラーメッセージ errors の使い方</h3>Railsのモデル(model)でバリデーションエラーが発生した場合に、model の <code>errors</code>にエラーメッセージが設定されます。さらに、<code>full_messages</code>でバリデーションのエラーメッセージの配列を取得できます。</p><p>次のProductモデルが設定されている前提で話を進めます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/product.rb</span>
<span class="synPreProc">class</span> <span class="synType">Product</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  <span class="synComment"># name属性に値が存在しない場合バリデーションエラーになります</span>
  validates <span class="synConstant">:name</span>, <span class="synConstant">presence</span>: <span class="synConstant">true</span>
<span class="synPreProc">end</span>
</pre><p>コンソールで動きを確認します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails console --sandbox

<span class="synComment"># バリデーションエラーが発生する場合</span>
&gt; product = <span class="synType">Product</span>.new
=&gt; <span class="synComment">#&lt;Product id: nil, name: nil, price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span>
&gt; product.valid? <span class="synComment"># バリデーションエラーが発生し、errorsにメッセージが登録される</span>
=&gt; <span class="synConstant">false</span>
&gt; product.errors.messages
=&gt; {<span class="synConstant">:name</span>=&gt;[<span class="synSpecial">&quot;</span><span class="synConstant">can't be blank</span><span class="synSpecial">&quot;</span>]}
&gt; product.errors.full_messages
=&gt; [<span class="synSpecial">&quot;</span><span class="synConstant">Name can't be blank</span><span class="synSpecial">&quot;</span>]
&gt; product.save
=&gt; <span class="synConstant">false</span>

<span class="synComment"># バリデーションエラーが発生しない場合</span>
product = <span class="synType">Product</span>.new( <span class="synConstant">name</span>: <span class="synSpecial">&quot;</span><span class="synConstant">商品名</span><span class="synSpecial">&quot;</span> )
=&gt; <span class="synComment">#&lt;Product id: nil, name: &quot;商品名&quot;, price: nil, discontinued: nil, created_at: nil, updated_at: nil&gt;</span>
irb(main):<span class="synConstant">017</span>:<span class="synConstant">0</span>&gt; product.valid? <span class="synComment"># バリデーションエラーが発生しない。errorsにメッセージが登録されない。</span>
=&gt; <span class="synConstant">true</span>
&gt; product.errors.messages
=&gt; {}
&gt; product.errors.full_messages
=&gt; []
&gt; product.save
=&gt; <span class="synConstant">true</span>
</pre><p><br />
<h3 id="add-error">モデル(model)にエラーメッセージを追加</h3><code>errors.add</code>と<code>errors[:base]</code>を使うことでエラーメッセージを自分で追加することができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">class</span> <span class="synType">Product</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  validate <span class="synConstant">:add_error_sample</span>

  <span class="synPreProc">def</span> <span class="synIdentifier">add_error_sample</span>
    <span class="synComment"># nameが空のときにエラーメッセージを追加する</span>
    <span class="synStatement">if</span> name.empty?
      errors.add(<span class="synConstant">:name</span>, <span class="synSpecial">&quot;</span><span class="synConstant">に関係するエラーを追加</span><span class="synSpecial">&quot;</span>)
      errors[<span class="synConstant">:base</span>] &lt;&lt; <span class="synSpecial">&quot;</span><span class="synConstant">モデル全体に関係するエラーを追加</span><span class="synSpecial">&quot;</span>
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>エラーが発生したときの画面です。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140809/20140809021320.png" alt="f:id:nipe880324:20140809021320p:plain:w380" title="f:id:nipe880324:20140809021320p:plain:w380" class="hatena-fotolife" style="width:380px" itemprop="image"></span></p><br />
<p>逆に、エラーメッセージを削除するメソッドもあります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>product = <span class="synType">Product</span>.new
product.valid? <span class="synComment"># =&gt; false</span>
product.errors.full_messages <span class="synComment"># =&gt; [&quot;Name can't be blank&quot;]</span>
product.errors.clear  <span class="synComment"># エラーメッセージを削除</span>
product.erros.empty? <span class="synComment"># =&gt; true</span>
</pre><p><h3 id="view-validation">ビューにモデルのバリデーションエラーを表示</h3>モデルのバリデーションエラー時に、ビューにバリデーションエラーを表示します。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140809/20140809012601.png" alt="f:id:nipe880324:20140809012601p:plain:w380" title="f:id:nipe880324:20140809012601p:plain:w380" class="hatena-fotolife" style="width:380px" itemprop="image"></span><br />
</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 通常はフォームの表示領域の上部に記載</span>
&lt;% <span class="synStatement">if</span> <span class="synIdentifier">@product</span>.errors.any? %&gt;
  &lt;div id=<span class="synSpecial">&quot;</span><span class="synConstant">error_explanation</span><span class="synSpecial">&quot;</span>&gt;
    &lt;h2&gt;&lt;%= <span class="synIdentifier">@product</span>.errors.count %&gt;件のエラーがあります。&lt;/h2&gt;
 
    &lt;ul&gt;
    &lt;% <span class="synIdentifier">@product</span>.errors.full_messages.each <span class="synStatement">do</span> |<span class="synIdentifier">msg</span>| %&gt;
      &lt;li&gt;&lt;%= msg %&gt;&lt;/li&gt;
    &lt;% <span class="synStatement">end</span> %&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
&lt;% <span class="synStatement">end</span> %&gt;
</pre>
</div>
<div class="section">
    <h3><h3 id="view-validation-japanese">モデルのバリデーションエラーメッセージを日本語化</h3></h3>
    <p>日本語にする場合は次を実施して下さい。</p>

<ol>
<li><a href="https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/ja.yml">ja.yml</a>を<code>config/locales/</code>に追加</li>
<li><code>config/application.rb</code>に<code>config.i18n.default_locale = :ja</code>を追加</li>
<li>サーバーを再起動</li>
</ol><p>さらにモデルの属性名(nameなど)を日本語化する場合は、<code>ja.yml</code>に次のように記載して下さい。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/locales/ja.yml</span>
ja:
  attributes:
    <span class="synConstant">name</span>:   名前
...
</pre>
</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li><a href="http://guides.rubyonrails.org/active_record_validations.html" target="_blank">RailsGuide</a></li>
</ul><p>以上です。<br />
分からない箇所や間違いがある場合は、コメントを頂けると嬉しいです。</p>

</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140810/1407623400.html"><time data-relative datetime="2014-08-09T22:30:00Z" title="2014-08-09T22:30:00Z" pubdate class="updated">2014-08-10 07:30</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140810/1407623400" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140810%2F1407623400" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407623400" data-count="vertical" data-text="Railsのモデルのバリデーションエラー errors や full_messages の使い方 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407623400" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
          <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4438296558807254"
     data-ad-slot="4370884664"
     data-ad-format="horizontal"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
                <article class="entry hentry js-entry-article date-last autopagerize_page_element chars-2800 words-200 mode-hatena entry-odd" id="entry-12921228815729872238" data-keyword-campaign="" data-uuid="12921228815729872238">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date last">
        <a href="entries/2014/08/10.html" rel="nofollow">
          <time pubdate datetime="2014-08-09T17:00:00Z" title="2014-08-09T17:00:00Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">10</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140810/1407603600.html" class="entry-title-link bookmark">Railsでビューのレイアウトを指定する</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%E5%88%9D%E7%B4%9A.html">Rails初級</a>
          
          <a href="archive/category/Rails%20Controller.html">Rails Controller</a>
          
          <a href="archive/category/Rails%20View.html">Rails View</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p>Railsのレイアウトファイルの使い方について説明します。</p><p>ページのヘッダー、ナビゲーションバー、フッターなどの大枠はRailsアプリを通して共通になるのが一般的です。</p><p>Railsではこのような共通の枠組みを記載したファイルを「<b>レイアウトファイル</b>」と呼び、<code>app/views/layouts</code>配下に配置します。</p><p>また、コントローラーやアクションで個別で指定したり、レイアウトファイルを非表示にしたり、レイアウトファイルに動的データを渡すことができます。<br />
<br />
<br />
</p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li><a href="index-page=1407915718.html#ctrl-default-layout">デフォルトのレイアウトファイル</a></li>
<li><a href="index-page=1407915718.html#ctrl-indicate-layout">レイアウトファイルを指定</a></li>
<li><a href="index-page=1407915718.html#ctrl-pass-data">レイアウトファイルにデータを渡す</a></li>
</ol><p></p><br />
<p><h3 id="ctrl-default-layout">1. デフォルトのレイアウトファイル</h3>デフォルトでは、「<b>app/views/layouts/application.html.erb</b>」がレイアウトファイルとして使われます。<br />
そして、<code>yield</code>の箇所が各コントローラーで表示するテンプレートが表示されます。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/layouts/application.html.erb
<span class="synComment">&lt;!DOCTYPE html&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>ControllerTest<span class="synIdentifier">&lt;/</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> stylesheet_link_tag</span><span class="synIdentifier">    </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synType">media</span><span class="synIdentifier">: </span><span class="synConstant">'all'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> javascript_include_tag</span><span class="synIdentifier"> </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> csrf_meta_tags</span><span class="synIdentifier"> %&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> yield</span><span class="synIdentifier"> %&gt;</span>

<span class="synIdentifier">&lt;/</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
</pre><p></p><br />
<p><h3 id="ctrl-indicate-layout">2. レイアウトファイルを指定</h3>コントローラーに<code>layout</code>宣言をすることで、<b>コントローラーが使うレイアウトを指定すること</b>ができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/controllers/products_controller.rb</span>
<span class="synPreProc">class</span> <span class="synType">ProductsController</span> &lt; <span class="synType">ApplicationController</span>
  <span class="synComment"># app/views/layouts/special_layout.html.erbをレイアウトファイルとして使う</span>
  layout <span class="synSpecial">&quot;</span><span class="synConstant">special_layout</span><span class="synSpecial">&quot;</span>
  <span class="synComment"># except(除く)やonly(のみ)を使うことで、レイアウトを指定するアクションを絞ることができる</span>
  <span class="synComment"># layout &quot;special_layout&quot;, except: [:new, :edit]</span>
  ...
<span class="synPreProc">end</span>
</pre><p><br />
また、renderメソッドの<code>layout</code>オプションを指定することで、アクション内でレイアウトを指定できる。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">def</span> <span class="synIdentifier">index</span>
  <span class="synIdentifier">@products</span> = <span class="synType">Product</span>.all

  <span class="synComment"># special_layoutで、index.html.erbを表示する</span>
  render <span class="synConstant">:index</span>, <span class="synConstant">layout</span>: <span class="synSpecial">&quot;</span><span class="synConstant">special_layout</span><span class="synSpecial">&quot;</span>
  <span class="synComment"># レイアウトを使わないで、index.html.erbを表示する</span>
  <span class="synComment"># render :index, layout: false</span>
<span class="synPreProc">end</span>
</pre><p></p><br />
<p><h3 id="ctrl-pass-data">3. レイアウトファイルにデータを渡す</h3></p>

<ul>
<li>レイアウトファイル内では、テンプレートファイルで使用できるインスタンス変数やセッションデータなどすべてのデータにアクセスできます。</li>
<li>さらに、テンプレートファイルで設定されたインスタンス変数にもアクセスすることができます。</li>
</ul><p>これを利用することで、ヘッダー、サイドバー、フッターにページ固有のHTMLを表示することができます。<br />
よくある例として、「ページ固有のタイトル表示」、「ページ固有のコンテンツ表示」の仕方を説明します。<br />
<br />
</p>

<div class="section">
    <h4>ページ固有のタイトルを表示する</h4>
    <p>まず、個々のテンプレートファイルで<code>provide</code>メソッドでタイトルを設定します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># テンプレートファイル
<span class="synIdentifier">&lt;%=</span><span class="synConstant"> provide(:title,</span><span class="synIdentifier"> </span><span class="synConstant">&quot;個別タイトル&quot;</span><span class="synIdentifier">) %&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>個別タイトル<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>
...
</pre><p>レイアウトファイルでは設定された値を<code>yeild</code>で表示します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># レイアウトファイル
<span class="synComment">&lt;!DOCTYPE html&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synComment">&lt;!-- 「Sample Application | 個別タイトル」とタイトルに表示される --&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>Sample Application | <span class="synIdentifier">&lt;%=</span><span class="synConstant"> yield(:title)</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> stylesheet_link_tag</span><span class="synIdentifier">    </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synType">media</span><span class="synIdentifier">: </span><span class="synConstant">'all'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> javascript_include_tag</span><span class="synIdentifier"> </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> csrf_meta_tags</span><span class="synIdentifier"> %&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>
...
</pre>
</div>
<div class="section">
    <h4>ページ固有のコンテンツを表示する</h4>
    <p>まず、個々のテンプレートファイルで<code>content_for</code>メソッドでコンテンツを作成します。<br />
ここでは、サイドバーの表示を設定しています。</p>
<pre class="code lang-html" data-lang="html" data-unlink># テンプレートファイル
<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>テンプレートファイル<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> content_for(:sidebar)</span><span class="synIdentifier">  do %&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>このリストはこのテンプレートが表示された<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>ときだけ表示されます。<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>
</pre><p>レイアウトファイルでは設定されたコンテンツを<code>yeild</code>で表示します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># レイアウトファイル
...
<span class="synIdentifier">&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;main&quot;</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> yield</span><span class="synIdentifier"> %&gt;</span>
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;sidebar&quot;</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span>
      <span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>全てのページに表示されるリスト項目<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>
      <span class="synComment">&lt;!-- テンプレートファイルに定義した sidebar が表示されます。</span>
<span class="synComment">             設定されていない場合はこのli要素は表示されせん --&gt;</span>
      <span class="synIdentifier">&lt;%=</span><span class="synConstant"> yield(:sidebar)</span><span class="synIdentifier"> %&gt;</span>
    <span class="synIdentifier">&lt;/</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
</pre><p><br />
以上です。</p>

</div>
</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li>RailsによるアジャイルWebアプリケーション開発 第4版</li>
</ul>
</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140810/1407603600.html"><time data-relative datetime="2014-08-09T17:00:00Z" title="2014-08-09T17:00:00Z" pubdate class="updated">2014-08-10 02:00</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140810/1407603600" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140810%2F1407603600" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407603600" data-count="vertical" data-text="Railsでビューのレイアウトを指定する - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140810/1407603600" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
            
            <div class="google-afc-image test-google-rectangle-ads ">
              
              
                <script>
  var hatenadfp = hatenadfp || {};
  hatenadfp.adUnits = hatenadfp.adUnits || [];
  hatenadfp.adUnits.push(
    
      { unitName: 'blog_user_2nd', size: [[300, 250], [336, 280]], divId: 'google_afc_user_container_1', allowContentMatch: true }
    
  );
  hatenadfp.isNGContent = false;
  
</script>

                <div id="google_afc_user_container_1" class="google_afc_blocklink2_5 google_afc_boder"></div>
                
                  <a href="http://blog.hatena.ne.jp/guide/pro" class="open-pro-modal" data-guide-pro-modal-ad-url="http://hatenablog.com/guide/pro/modal/ad">広告を非表示にする</a>
                
                
              
            </div>
          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
            
              
                <article class="entry hentry js-entry-article date-first autopagerize_page_element chars-2400 words-100 mode-hatena entry-even" id="entry-12921228815729801985" data-keyword-campaign="" data-uuid="12921228815729801985">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date first">
        <a href="entries/2014/08/08.html" rel="nofollow">
          <time pubdate datetime="2014-08-07T16:04:17Z" title="2014-08-07T16:04:17Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">08</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140808/1407427457.html" class="entry-title-link bookmark">Railsでリダイレクトをするredirect_toメソッドの使い方</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%E5%88%9D%E7%B4%9A.html">Rails初級</a>
          
          <a href="archive/category/Rails%20Controller.html">Rails Controller</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p>Railsのコントローラーで他のURLにリダイレクトをするには、<code>redirect_to</code>メソッドを使います。<br />
リダイレクト(redirect_toメソッド)とレンダー(renderメソッド)の使い分け、<code>redirect_to</code>メソッドの使い方について説明します。</p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li>リダイレクトとは</li>
<li>いつリダイレクト(<code>redirect_to()</code>)し、いつレンダー(<code>render()</code>)をするか</li>
<li><code>redirect_to</code>メソッドの使い方</li>
</ol>
</div>
<div class="section">
    <h3>1. リダイレクトとは</h3>
    <p>HTTPリダイレクトは、「サーバがブラウザからアクセスされたリクエスト(URL)を処理できないけど、できるURLを教えるからそっちへアクセスして」という挙動です。<br />
具体的には、サーバからブラウザにレスポンスとして<b>「リダイレクト先のURL + 永続的（ステータスコード 301）か一時的（ステータスコード 307）かを示すステータス情報」</b>が返され、ブラウザはそのリダイレクト先のURLに自動でアクセスします。そのため、ユーザからはリダイレクトしているかどうかはほぼ画面表示からだけでは分かりません。<br />
<br />
</p>

</div>
<div class="section">
    <h3>2. いつリダイレクト(<code>redirect_to</code>)し、いつレンダー(<code>render</code>)をするか</h3>
    <p>基本的に、</p>

<ul>
<li>データを追加、更新、削除するときは、<b>「リダイレクト」</b></li>
<li>データの取得して表示するときは、<b>「レンダー」</b></li>
</ul><p>をします。</p><p>具体的なソースコードを見てみましょう。<br />
下記は商品登録画面で「登録」ボタンを押されたときの処理です。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink> <span class="synConstant">1</span>: <span class="synComment"># POST /products</span>
 <span class="synConstant">2</span>: <span class="synPreProc">def</span> <span class="synIdentifier">create</span>
 <span class="synConstant">3</span>:   <span class="synIdentifier">@product</span> = <span class="synType">Product</span>.new(product_params)
 <span class="synConstant">4</span>: 
 <span class="synConstant">5</span>:   <span class="synStatement">if</span> <span class="synIdentifier">@product</span>.save  <span class="synComment"># productの保存に成功した場合、商品詳細画面にリダイレクト</span>
 <span class="synConstant">6</span>:       redirect_to <span class="synIdentifier">@product</span>, <span class="synConstant">notice</span>: <span class="synSpecial">'</span><span class="synConstant">商品を登録しました。</span><span class="synSpecial">'</span>
 <span class="synConstant">7</span>:   <span class="synStatement">else</span> <span class="synComment"># productの保存に失敗した場合、商品登録画面をレンダリング</span>
 <span class="synConstant">8</span>:       render <span class="synConstant">:new</span>
 <span class="synConstant">9</span>:   <span class="synStatement">end</span>
<span class="synConstant">10</span>: <span class="synPreProc">end</span>
</pre><p>上記のソースコードでは、６行目でデータの追加（商品の登録）がされたときにリダイレクトしています。<br />
もし、ここでリダイレクトの代わりにレンダリング（renderメソッド）だったらどうなるでしょうか。</p><p>ユーザが遷移先のページでブラウザの更新ボタン（F5）を押した場合、ブラウザが前回と同様のアクセス（POST /products）を繰り返してしまうので、createアクションが実行され、同じ商品がデータベースに登録されてしまいます。<br />
ECサイトの商品購入時にこのようなことが起こったら、余計な代金を払わないといけないことになって大変です。</p><p>そのため、リダイレクトをしています。リダイレクトをすることにより、前回のアクセスが商品の詳細画面への遷移（GET /products/:id）になるので、更新ボタンを押しても、商品データが重複してデータベースに登録されてしまうという問題は発生しません。</p>

</div>
<div class="section">
    <h3>3. <code>redirect_to</code>メソッドの使い方</h3>
    
<div class="section">
    <h4>URLにリダイレクト</h4>
    <p>指定したパスにリダイレクトします。<br />
このとき、<code>*_path</code>ではなく<code>*_url</code>を使います。<br />
さらに、notice, alertというオプションが使え、flash[:notice]、flash[:alert]に値を設定できます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># flash[:notice]にメッセージを設定し、products_urlにリダイレクトする</span>
redirect_to products_url, <span class="synConstant">notice</span>: <span class="synSpecial">'</span><span class="synConstant">noticeメッセージ</span><span class="synSpecial">'</span>

<span class="synComment"># flash[:alert]にメッセージを設定し、products_urlにリダイレクトする</span>
redirect_to products_url, <span class="synConstant">alert</span>: <span class="synSpecial">'</span><span class="synConstant">alertメッセージ</span><span class="synSpecial">'</span>

<span class="synComment"># 商品の詳細画面にリダイレクトする</span>
<span class="synComment"># Railsは@productを、商品の詳細画面へのURLに自動で変換する</span>
redirect_to <span class="synIdentifier">@product</span>
</pre>
</div>
<div class="section">
    <h4>参照元にリダイレクト</h4>
    <p>リクエスト内のRefererヘッダ（HTTP_REFERER）で指定されたURLにリダイレクトします。<br />
基本的にはRefererヘッダには前回アクセスしたURLが格納されています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>redirect_to(<span class="synConstant">:back</span>)
</pre>
</div>
<div class="section">
    <h4>永続的なリダイレクト</h4>
    <p>デフォルトではすべてのリダイレクトが一時的なもの（ステータスコード 307）です。<br />
サイト移動など永続的なリダイレクトを実施したい場合は、ステータスコードを指定する必要があります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>redirect_to(<span class="synSpecial">&quot;</span><span class="synConstant">http://new.home</span><span class="synSpecial">&quot;</span>, <span class="synConstant">status</span>: <span class="synConstant">301</span>)
</pre><p><br />
以上です。<br />
よくわからない箇所や間違っている箇所がありましたら、コメント頂けると助かります。</p>

</div>
</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140808/1407427457.html"><time data-relative datetime="2014-08-07T16:04:17Z" title="2014-08-07T16:04:17Z" pubdate class="updated">2014-08-08 01:04</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140808/1407427457" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140808%2F1407427457" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140808/1407427457" data-count="vertical" data-text="Railsでリダイレクトをするredirect_toメソッドの使い方 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140808/1407427457" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
          <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4438296558807254"
     data-ad-slot="4370884664"
     data-ad-format="horizontal"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
            
              
                <article class="entry hentry js-entry-article date-first autopagerize_page_element chars-2800 words-400 mode-hatena entry-odd" id="entry-12921228815729761679" data-keyword-campaign="" data-uuid="12921228815729761679">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date first">
        <a href="entries/2014/08/07.html" rel="nofollow">
          <time pubdate datetime="2014-08-07T13:43:33Z" title="2014-08-07T13:43:33Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">07</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140807/1407419013.html" class="entry-title-link bookmark">RailsのViewでのrenderメソッドの使い方</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%E5%88%9D%E7%B4%9A.html">Rails初級</a>
          
          <a href="archive/category/Rails%20View.html">Rails View</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p>RailsのViewでの<code>render</code>メソッドの使い方について説明します。<br />
<code>render</code>メソッドは、「コントローラー(Controller)」と「ビュー(View)」それぞれにあります。<br />
ここではビューのrenderメソッドの使い方を示します。</p><p><i>コントローラーのrenderメソッドの使い方を知りたい場合は、<a href="entry/20141125/1416918957.html">こちら</a>へ</i></p><p></p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li><a href="index-page=1407915718.html#render-view-desc">ビュー内での<code>render</code>メソッドについて</a></li>
<li><a href="index-page=1407915718.html#render-view-partial">部分テンプレートを表示するrenderメソッド</a></li>
<li><a href="index-page=1407915718.html#render-view-object">部分テンプレートにオブジェクトを渡すrenderメソッド</a></li>
<li><a href="index-page=1407915718.html#render-view-collection">部分テンプレートでコレクションを表示するrenderメソッド</a></li>
</ol><p><br />
<h3 id="render-view-desc">1. ビュー内での<code>render</code>メソッドについて</h3>ビュー内での<code>render</code>メソッドは、部分テンプレート（partial）を表示するために使います。<br />
部分テンプレートとは、共通のビューの表示を別ファイルに切り出すことができ、様々なビューから呼び出すことができます。</p><br />
<p><h3 id="render-view-partial">2. 部分テンプレートを表示するrenderメソッド</h3>一般的な例として、新規と編集ページのフォーム表示部分は部分テンプレートになっているので、それを説明します。<br />
<b>部分テンプレートは必ずアンダースコア（_）で始まる必要があります。</b></p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 部分テンプレート（呼び出される側）</span>
<span class="synComment"># app/views/products/_form.html.erb</span>

&lt;%= form_for(<span class="synIdentifier">@product</span>) <span class="synStatement">do</span> |<span class="synIdentifier">f</span>| %&gt;
  &lt;div <span class="synPreProc">class</span>=&quot;field&quot;&gt;
    &lt;%= f.label <span class="synConstant">:name</span> %&gt;&lt;br&gt;
    &lt;%= f.text_field <span class="synConstant">:name</span> %&gt;
  &lt;/div&gt;
  &lt;div <span class="synPreProc">class</span>=&quot;actions&quot;&gt;
    &lt;%= f.submit %&gt;
  &lt;/div&gt;
&lt;% <span class="synPreProc">end</span> %&gt;
</pre><p>部分テンプレートを呼び出す側では、renderメソッドと引数にアンダースコア抜きのファイル名を指定します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 新規画面（呼び出し側）</span>
<span class="synComment"># app/views/products/new.html.erb</span>
&lt;h1&gt;<span class="synType">New</span> product&lt;/h1&gt;

&lt;%= render <span class="synSpecial">'</span><span class="synConstant">form</span><span class="synSpecial">'</span> %&gt;

&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Back</span><span class="synSpecial">'</span>, products_path %&gt;
</pre><pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 編集画面（呼び出し側）</span>
<span class="synComment"># app/views/products/edit.html.erb</span>
&lt;h1&gt;<span class="synType">Editing</span> product&lt;/h1&gt;

&lt;%= render <span class="synSpecial">'</span><span class="synConstant">form</span><span class="synSpecial">'</span> %&gt;

&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Show</span><span class="synSpecial">'</span>, <span class="synIdentifier">@product</span> %&gt; |
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Back</span><span class="synSpecial">'</span>, products_path %&gt;
</pre><p><br />
<h3 id="render-view-object">3. 部分テンプレートにオブジェクトを渡すrenderメソッド</h3>renderメソッドは、下記のようにオブジェクトを渡すことができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 部分テンプレートを呼び出す側</span>
<span class="synComment"># app/views/products/index.html.erb</span>
...
&lt;% products.each <span class="synStatement">do</span> |<span class="synIdentifier">product</span>| %&gt;
  &lt;!-- <span class="synSpecial">&quot;</span><span class="synConstant">object:</span><span class="synSpecial">&quot;</span>の部分は任意の名前で良いです。
     部分テンプレート内ではその名前でオブジェクトにアクセスできます。--&gt;
  &lt;%= render <span class="synSpecial">'</span><span class="synConstant">product</span><span class="synSpecial">'</span>, <span class="synConstant">object</span>: product %&gt;
&lt;% <span class="synStatement">end</span> %&gt;
...
</pre><p>部分テンプレート側では、「呼び出し側で指定した名前」でオブジェクトにアクセスできます。（"object"でアクセスしている）</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 部分テンプレート側</span>
<span class="synComment"># app/views/products/_product.html.erb</span>
&lt;%= object.name %&gt; |
&lt;%= object.price %&gt; |
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Show</span><span class="synSpecial">'</span>, object %&gt;
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Edit</span><span class="synSpecial">'</span>, edit_product_path(object) %&gt;
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Destroy</span><span class="synSpecial">'</span>, object, <span class="synConstant">method</span>: <span class="synConstant">:delete</span>, <span class="synConstant">data</span>: { <span class="synConstant">confrim</span>: <span class="synSpecial">'</span><span class="synConstant">Are you sure?</span><span class="synSpecial">'</span> } %&gt;
</pre><p><br />
<h3 id="render-view-collection">4. 部分テンプレートでコレクションを表示するrenderメソッド</h3>部分テンプレートでコレクションを表示する場合、特定の条件が整っているとループ処理などを省くことができます。上記の例はコレクションを表示しているので書き直してみます。</p>

<ul>
<li>呼び出し側では、renderメソッドにコレクションを渡す（例：@products）</li>
<li>呼び出される側では、ファイル名をコレクションの単数系にする（例：_product.html.erb）。さらに、オブジェクトにはその単数系でアクセスできます。（例：product.<i>method</i>）</li>
</ul><pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 部分テンプレートを呼び出す側</span>
<span class="synComment"># app/views/products/index.html.erb</span>
...
&lt;!-- コレクションの変数を渡すとループ処理が必要なくなる。
   <span class="synType">Rails</span>は変数名の単数系の部分テンプレートを呼び出す。
   今回は、app/views/products/_product.html.erb --&gt;
&lt;%= render <span class="synIdentifier">@products</span> %&gt;
...
</pre><p>部分テンプレート側では、「変数名の単数系の名前」でオブジェクトにアクセスできます。<br />
（以下では、"product"でアクセスしています）</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># 部分テンプレート側</span>
<span class="synComment"># app/views/products/_product.html.erb</span>
&lt;%= product.name %&gt; |
&lt;%= product.price %&gt; |
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Show</span><span class="synSpecial">'</span>, product %&gt;
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Edit</span><span class="synSpecial">'</span>, edit_product_path(product) %&gt;
&lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">Destroy</span><span class="synSpecial">'</span>, product, <span class="synConstant">method</span>: <span class="synConstant">:delete</span>, <span class="synConstant">data</span>: { <span class="synConstant">confrim</span>: <span class="synSpecial">'</span><span class="synConstant">Are you sure?</span><span class="synSpecial">'</span> } %&gt;
</pre><p><br />
以上です。</p>

</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140807/1407419013.html"><time data-relative datetime="2014-08-07T13:43:33Z" title="2014-08-07T13:43:33Z" pubdate class="updated">2014-08-07 22:43</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140807/1407419013" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140807%2F1407419013" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140807/1407419013" data-count="vertical" data-text="RailsのViewでのrenderメソッドの使い方 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140807/1407419013" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
            
            <div class="google-afc-image test-google-rectangle-ads ">
              
              
                <script>
  var hatenadfp = hatenadfp || {};
  hatenadfp.adUnits = hatenadfp.adUnits || [];
  hatenadfp.adUnits.push(
    
      { unitName: 'blog_user_2nd', size: [[300, 250], [336, 280]], divId: 'google_afc_user_container_2', allowContentMatch: true }
    
  );
  hatenadfp.isNGContent = false;
  
</script>

                <div id="google_afc_user_container_2" class="google_afc_blocklink2_5 google_afc_boder"></div>
                
                  <a href="http://blog.hatena.ne.jp/guide/pro" class="open-pro-modal" data-guide-pro-modal-ad-url="http://hatenablog.com/guide/pro/modal/ad">広告を非表示にする</a>
                
                
              
            </div>
          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
            
              
                <article class="entry hentry js-entry-article date-first autopagerize_page_element chars-9200 words-800 mode-hatena entry-even" id="entry-12921228815729428910" data-keyword-campaign="" data-uuid="12921228815729428910">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date first">
        <a href="entries/2014/08/05.html" rel="nofollow">
          <time pubdate datetime="2014-08-05T01:00:00Z" title="2014-08-05T01:00:00Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">05</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140805/1407200400.html" class="entry-title-link bookmark">Railsのログイン認証gemのDeviseとOmniAuth-Twitterの連携（Twitterでログインする）</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%20gem.html">Rails gem</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p><a href="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" class="http-image" target="_blank"><img src="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" class="http-image" alt="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" width="320"></a></p><br />
<p>次のように、よく見かける<b>Twitterでユーザ登録</b>や<b>Facebookでユーザ登録</b>のように「<b>RailsでDeviseを使ってTwitterのOAuthを実装する方法</b>」について説明します。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802233738.jpg" alt="f:id:nipe880324:20140802233738j:plain" title="f:id:nipe880324:20140802233738j:plain" class="hatena-fotolife" itemprop="image"></span></p><p></p>

<ul>
<li>前々回は、「<a href="entry/20140801/1406907000.html">Deviseのインストール方法</a>」を説明しました。</li>
<li>前回は、「<a href="entry/20140804/1407168000.html">Deviseのカスタマイズ方法</a>」を説明しました。</li>
</ul><p><b>実際に試す場合は、上記の２記事を実施済みだと差分を埋め合わせる必要がなくなり簡単です。</b></p><br />
<p></p>

<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li>Rails 4.1.4</li>
<li>Devise 3.2.4</li>
<li>OmniAuth</li>
</ul>
</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li>Twitter Developer画面でAPP_IDとAPP_SECRETを取得</li>
<li>DeviseにOmniAuthのインストールと設定（初期設定とTwitterへの接続）</li>
<li>DeviseにOmniAuthのインストールと設定（コールバック処理の実装）</li>
<li>DeviseにOmniAuthのインストールと設定（プロフィール変更の修正）</li>
</ol>
</div>
<div class="section">
    <h3>Twitter Developer画面で[API key]と[API secret]を取得</h3>
    
<div class="section">
    <h5>1. <a href="https://apps.twitter.com" target="_blank">Twitter Developer画面</a>にアクセスします。（Sign inしてなかったらしてください）</h5>
    <p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803001147.png" alt="f:id:nipe880324:20140803001147p:plain:w360" title="f:id:nipe880324:20140803001147p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span></p><p></p>

</div>
<div class="section">
    <h5>2. [Create New App]を押し、各項目を入力して下さい。</h5>
    
<ul>
<li>Name: アプリ名を記載（任意）</li>
<li>Description: 説明を記載（任意）</li>
<li>Website: ホームページを記載（ユーザーが認証時に表示されるURLで、OmniAuthの動作に関与しないので任意）</li>
<li>Callback URL: コールバックURLを記載（今回はテストでローカルサーバーのため<a href="http://127.0.0.1:3000/users/omniauth_callbacks">http://127.0.0.1:3000/users/omniauth_callbacks</a>を指定）</li>
</ul><p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803001703.png" alt="f:id:nipe880324:20140803001703p:plain:w360" title="f:id:nipe880324:20140803001703p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span><br />
</p>

</div>
<div class="section">
    <h5>3. [Create your Twitter application]を押します。</h5>
    
</div>
<div class="section">
    <h5>4. 作成したアプリの[settings]タブの[Allow this application to be used to Sign in with Twitter]のチェックボックスをONにして、[Update settings]をして下さい。</h5>
    <p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803001843.png" alt="f:id:nipe880324:20140803001843p:plain:w360" title="f:id:nipe880324:20140803001843p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span><br />
</p>

</div>
<div class="section">
    <h5>5. 作成したアプリの[API Keys]タブで[API key]と[API secret]を後から使うのでコピーしておいて下さい。（下の画像では値を隠しています）</h5>
    <p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803002424.png" alt="f:id:nipe880324:20140803002424p:plain:w360" title="f:id:nipe880324:20140803002424p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span></p><br />
<p></p>

</div>
</div>
<div class="section">
    <h3>DeviseにOmniAuthのインストールと設定（初期設定とTwitterへの接続）</h3>
    <p>では、RailsにOmniAuthをインストールしていきます。<br />
まずは、<code>devise</code>と<code>omniauth-twitter</code>をGemfileに追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># Gemfile</span>
gem <span class="synSpecial">'</span><span class="synConstant">devise</span><span class="synSpecial">'</span>
gem <span class="synSpecial">'</span><span class="synConstant">omniauth-twitter</span><span class="synSpecial">'</span>
</pre><p>次に、gemをインストールします。</p>
<pre class="code" data-lang="" data-unlink>$ bundle install</pre><p>OAuthで取得する<code>provider</code>と<code>uid</code>を保持するために、Userモデルにカラムを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration add_columns_to_users provider uid
$ rake db<span class="synConstant">:migrate</span>
</pre><p>Deviseの設定ファイルに先ほど取得した[API key]と[API secret]を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/initializers/devise.rb</span>
<span class="synType">Devise</span>.setup <span class="synStatement">do</span> |<span class="synIdentifier">config</span>|
  ...
  ...
  <span class="synComment"># omniauth</span>
  <span class="synComment"># 先ほど設定した値を記載して下さい。</span>
  config.omniauth <span class="synConstant">:twitter</span>, <span class="synSpecial">&quot;</span><span class="synConstant">[API Key]</span><span class="synSpecial">&quot;</span>, <span class="synSpecial">&quot;</span><span class="synConstant">[API secret]</span><span class="synSpecial">&quot;</span>
<span class="synStatement">end</span>
</pre><p>Userモデルに<code>:omniauthable</code>を設定します。<br />
下記のケースの場合、<code>:validatable</code>の後に<code>,</code>を忘れないようにして下さい。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">class</span> <span class="synType">User</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  <span class="synComment"># Include default devise modules. Others available are:</span>
  <span class="synComment"># :confirmable, :lockable and :timeoutable</span>
  devise <span class="synConstant">:database_authenticatable</span>, <span class="synConstant">:registerable</span>,
         <span class="synConstant">:recoverable</span>, <span class="synConstant">:rememberable</span>, <span class="synConstant">:trackable</span>, <span class="synConstant">:validatable</span>,
         <span class="synConstant">:omniauthable</span>, <span class="synConstant">omniauth_providers</span>: [<span class="synConstant">:twitter</span>]

  validates <span class="synConstant">:username</span>, <span class="synConstant">presence</span>: <span class="synConstant">true</span>, <span class="synConstant">uniqueness</span>: <span class="synConstant">true</span>
<span class="synPreProc">end</span>
</pre><p><i>注意点として、現在(devise 3.2.4)では、DeviseはOmniAuthを１つのモデルでしか使えません。<br />
複数のモデルでOmniAuthを使いたい場合は<a href="https://github.com/plataformatec/devise/wiki/OmniAuth-with-multiple-models" target="_blank">ここ</a>を参照して下さい。</i></p><br />
<p><code>:omniauthable</code>をUserモデルに追加し、<code>config/routes.rb</code>に<code>devise_for :users</code>が設定されている場合、下記の2つのルートが自動で追加されます。<br />
<code>$ rake routes</code>で確認しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake routes
$ rake routes
                  <span class="synType">Prefix</span> <span class="synType">Verb</span>     <span class="synType">URI</span> <span class="synType">Pattern</span>                            <span class="synType">Controller</span><span class="synComment">#Action</span>
  ...
 user_omniauth_authorize <span class="synType">GET</span>|<span class="synType">POST</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>auth/<span class="synConstant">:provider</span>(.<span class="synConstant">:format</span>)        omniauth_callbacks<span class="synComment">#passthru {:provider=&gt;/twitter/}</span>
  user_omniauth_callback <span class="synType">GET</span>|<span class="synType">POST</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>auth/<span class="synConstant">:action</span>/callback(.<span class="synConstant">:format</span>) omniauth_callbacks<span class="synComment">#(?-mix:twitter)</span>
  ...
</pre><p><i>注意点として、Deviseは上記の2つのパスの<code>*_url</code>を作成しないことと、自分で2番目の<code>user_omniauth_callback</code>はViewなどで指定しません。</i></p><p>では、<code>application.html.erb</code>にリンクを追加しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/views/layouts/application.html.erb</span>
....
&lt;body&gt;
&lt;header&gt;
  &lt;nav&gt;
    &lt;!-- user_signed_in? はユーザがログインしているか調べるdeviseの<span class="synType">Helper</span>メソッド --&gt;
    &lt;% <span class="synStatement">if</span> user_signed_in? %&gt; 
      &lt;!-- current_user は現在ログインしている<span class="synType">User</span>オブジェクトを返すdeviseの<span class="synType">Helper</span>メソッド --&gt;
      &lt;!-- *_path は<span class="synType">User</span>モデルを作成したときに、
        deviseにより自動で作成されてますので、rake routesで確認できます --&gt;
      <span class="synType">Logged</span> <span class="synStatement">in</span> as &lt;strong&gt;&lt;%= current_user.email %&gt;&lt;/strong&gt;.
      &lt;%= link_to <span class="synSpecial">'</span><span class="synConstant">プロフィール変更</span><span class="synSpecial">'</span>, edit_user_registration_path %&gt; |
      &lt;%= link_to <span class="synSpecial">&quot;</span><span class="synConstant">ログアウト</span><span class="synSpecial">&quot;</span>, destroy_user_session_path, <span class="synConstant">method</span>: <span class="synConstant">:delete</span> %&gt;
    &lt;% <span class="synStatement">else</span> %&gt;
      &lt;%= link_to <span class="synSpecial">&quot;</span><span class="synConstant">サインイン</span><span class="synSpecial">&quot;</span>, new_user_registration_path %&gt; |
      &lt;%= link_to <span class="synSpecial">&quot;</span><span class="synConstant">ログイン</span><span class="synSpecial">&quot;</span>, new_user_session_path %&gt; |
      &lt;%= link_to <span class="synSpecial">&quot;</span><span class="synConstant">Sign in with Twitter</span><span class="synSpecial">&quot;</span>, user_omniauth_authorize_path(<span class="synConstant">:twitter</span>) %&gt;
    &lt;% <span class="synStatement">end</span> %&gt;
  &lt;/nav&gt;
&lt;/header&gt;
  
&lt;p <span class="synPreProc">class</span>=&quot;notice&quot;&gt;&lt;%= notice %&gt;&lt;/p&gt;
&lt;p <span class="synPreProc">class</span>=&quot;alert&quot;&gt;&lt;%= alert %&gt;&lt;/p&gt;

&lt;%= <span class="synStatement">yield</span> %&gt;

&lt;/body&gt;
&lt;/html&gt;
</pre><p><br />
では、サーバーを再起動し、ログイン画面を確認してみましょう。「Sign in with Twitter」リンクが追加されているはずです。<br />
これは、<code>app/views/devise/shared/_links.erb_links_erb</code>にデフォルトで<code>:omniauthable</code>が有効化されたらリンクを表示するように記載されていたためです。</p><br />
<p>では、[Sign in with Twitter]リンクを押すと、Twitter画面に遷移し、その後、Railsにリダイレクトされます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803013919.png" alt="f:id:nipe880324:20140803013919p:plain:w360" title="f:id:nipe880324:20140803013919p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span><br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803005647.png" alt="f:id:nipe880324:20140803005647p:plain:w360" title="f:id:nipe880324:20140803005647p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span></p><p>そして、コールバックコントローラーがないため、エラーになります。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803005648.png" alt="f:id:nipe880324:20140803005648p:plain:w360" title="f:id:nipe880324:20140803005648p:plain:w360" class="hatena-fotolife" style="width:360px" itemprop="image"></span></p><br />
<p></p>

</div>
<div class="section">
    <h3>DeviseにOmniAuthのインストールと設定（コールバック処理の実装）</h3>
    <p>コールバックコントローラーを作成しましょう。<br />
まず、コールバックコントローラーへのルートを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/routes.rb</span>
  ...
  devise_for <span class="synConstant">:users</span>, <span class="synConstant">path_names</span>: { <span class="synConstant">sign_in</span>: <span class="synSpecial">&quot;</span><span class="synConstant">login</span><span class="synSpecial">&quot;</span>, <span class="synConstant">sign_out</span>: <span class="synSpecial">&quot;</span><span class="synConstant">logout</span><span class="synSpecial">&quot;</span>},
    <span class="synConstant">controllers</span>: { <span class="synConstant">omniauth_callbacks</span>: <span class="synSpecial">&quot;</span><span class="synConstant">omniauth_callbacks</span><span class="synSpecial">&quot;</span> }
  ...
</pre><p>次に、<code>rails g</code>コマンドでコールバックコントローラーを作成します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g controller omniauth_callbacks
</pre><p><br />
では、コールバックコントローラーを実装しましょう。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/controllers/omniauth_callbacks_controller.rb</span>
<span class="synPreProc">class</span> <span class="synType">OmniauthCallbacksController</span> &lt; <span class="synType">Devise</span>::<span class="synType">OmniauthCallbacksController</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">all</span>
    <span class="synComment"># profiderとuidでuserレコードを検索。存在しなければ、新たに作成する</span>
    user = <span class="synType">User</span>.from_omniauth(request.env[<span class="synSpecial">&quot;</span><span class="synConstant">omniauth.auth</span><span class="synSpecial">&quot;</span>])
    <span class="synComment"># userレコードが既に保存されているか</span>
    <span class="synStatement">if</span> user.persisted?
      <span class="synComment"># ログインに成功</span>
      flash.notice = <span class="synSpecial">&quot;</span><span class="synConstant">ログインしました!!</span><span class="synSpecial">&quot;</span>
      sign_in_and_redirect user
    <span class="synStatement">else</span>
      <span class="synComment"># ログインに失敗し、サインイン画面に遷移</span>
      session[<span class="synSpecial">&quot;</span><span class="synConstant">devise.user_attributes</span><span class="synSpecial">&quot;</span>] = user.attributes
      redirect_to new_user_registration_url
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>

  <span class="synComment"># alias_methodはクラスやモジュールのメソッドに別名をつけます</span>
  <span class="synComment"># 実態がallメソッドのtwitterメソッドを定義しています</span>
  <span class="synComment"># こうすることで、様々なメソッド名で同じ処理を実装することができます。</span>
  <span class="synComment"># OAuthの処理はほとんど同じためこのようにしています。</span>
  <span class="synComment"># 例えば、Facebookに対応する場合、alias_method :facebook, :allだけですみます</span>
  alias_method <span class="synConstant">:twitter</span>, <span class="synConstant">:all</span>
<span class="synPreProc">end</span>
</pre><p>Userモデルにメソッドを実装します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/user.rb</span>
  ...
  <span class="synPreProc">def</span> <span class="synConstant">self</span>.<span class="synIdentifier">from_omniauth</span>(auth)
    <span class="synComment"># providerとuidでUserレコードを取得する</span>
    <span class="synComment"># 存在しない場合は、ブロック内のコードを実行して作成する</span>
    where(auth.slice(<span class="synConstant">:provider</span>, <span class="synConstant">:uid</span>)).first_or_create <span class="synStatement">do</span> |<span class="synIdentifier">user</span>|
      <span class="synComment"># auth.provider には &quot;twitter&quot;、</span>
      <span class="synComment"># auth.uidには twitterアカウントに基づいた個別のIDが入っている</span>
      <span class="synComment"># first_or_createメソッドが自動でproviderとuidを設定してくれるので、</span>
      <span class="synComment"># ここでは設定は必要ない</span>
      user.username = auth.info.nickname <span class="synComment"># twitterで利用している名前が入る</span>
      user.email = auth.info.email <span class="synComment"># twitterの場合入らない</span>
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
  ...
</pre><p><br />
では、画面から [Sign in with Twitter]を押してみましょう。すると、サインアップ画面が表示されます。<br />
これは、OmniauthCollbacksControllerの<code>User.from_omniauthメソッド</code>で新規にレコードを作成するので、<code>user.persisted?</code>で「false」になっているためです。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803014918.png" alt="f:id:nipe880324:20140803014918p:plain:w480" title="f:id:nipe880324:20140803014918p:plain:w480" class="hatena-fotolife" style="width:480px" itemprop="image"></span></p><br />
<p>では、サインアップ画面にリダイレクトされたときに、Twitterから取得したデータを表示するようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/user.rb</span>
  ...
  <span class="synComment"># Devise の RegistrationsController はリソースを生成する前に self.new_sith_session を呼ぶ</span>
  <span class="synComment"># つまり、self.new_with_sessionを実装することで、サインアップ前のuserオブジェクトを初期化する</span>
  <span class="synComment"># ときに session からデータをコピーすることができます。</span>
  <span class="synComment"># OmniauthCallbacksControllerでsessionに値を設定したので、それをuserオブジェクトにコピーします。</span>
  <span class="synPreProc">def</span> <span class="synConstant">self</span>.<span class="synIdentifier">new_with_session</span>(params, session)
    <span class="synStatement">if</span> session[<span class="synSpecial">&quot;</span><span class="synConstant">devise.user_attributes</span><span class="synSpecial">&quot;</span>]
      new(session[<span class="synSpecial">&quot;</span><span class="synConstant">devise.user_attributes</span><span class="synSpecial">&quot;</span>], <span class="synConstant">without_protection</span>: <span class="synConstant">true</span>) <span class="synStatement">do</span> |<span class="synIdentifier">user</span>|
        user.attributes = params
        user.valid?
      <span class="synStatement">end</span>
    <span class="synStatement">else</span>
      <span class="synStatement">super</span>
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
  ...
</pre><p>データがコピーされていることを確認するため、 画面で[Sign in with Twitter]を押してましょう。<br />
EmailとPasswordのエラーが表示されています。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803023726.png" alt="f:id:nipe880324:20140803023726p:plain:w480" title="f:id:nipe880324:20140803023726p:plain:w480" class="hatena-fotolife" style="width:480px" itemprop="image"></span></p><br />
<p>Twitter経由で認証した場合、パスワードを入力しなくてもログインをできるようにする<br />
TwitterではEmailは取得できないため入力しないといけません、PasswordはTwitterで認証されているため入力はいりません。そのため、パスワードを入力しなくてもログインできるようにしましょう。<br />
ちなみに、<a href="https://github.com/arunagw/omniauth-twitter#user-content-authentication-hash" blank="_blank">omniauth-twitter 公式ドキュメント</a>に取得できる値が記載されています。</p><p>まずは、Userモデルがproviderが存在する場合にパスワードを要求しないようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/user.rb</span>
  ...
  <span class="synComment"># providerがある場合（Twitter経由で認証した）は、</span>
  <span class="synComment"># passwordは要求しないようにする。</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">password_required?</span>
    <span class="synStatement">super</span> &amp;&amp; provider.blank?
  <span class="synPreProc">end</span>
  ..
</pre><p>また、Viewではパスワードが要求されていない場合は、<code>f.object.password_required?</code>を追加して、passwordの入力フィールドを表示しないようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/views/devise/registrations/new.html.erb</span>
&lt;h2&gt;<span class="synType">Sign</span> up&lt;/h2&gt;

&lt;%= form_for(resource, <span class="synConstant">as</span>: resource_name, <span class="synConstant">url</span>: registration_path(resource_name)) <span class="synStatement">do</span> |<span class="synIdentifier">f</span>| %&gt;
  &lt;%= devise_error_messages! %&gt;

  &lt;div&gt;&lt;%= f.label <span class="synConstant">:username</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">  &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">text_field :username, autofocus: true %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;

  &lt;div&gt;&lt;%= f.label <span class="synConstant">:email</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">  &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">email_field :email %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;

  &lt;% <span class="synStatement">if</span> f.object.password_required? %&gt;
    &lt;div&gt;&lt;%= f.label <span class="synConstant">:password</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">      &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">password_field :password, autocomplete: &quot;off&quot; %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;

    &lt;div&gt;&lt;%= f.label <span class="synConstant">:password_confirmation</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">      &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">password_field :password_confirmation, autocomplete: &quot;off&quot; %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;
  &lt;% <span class="synStatement">end</span> %&gt;

  &lt;div&gt;&lt;%= f.submit <span class="synSpecial">&quot;</span><span class="synConstant">Sign up</span><span class="synSpecial">&quot;</span> %&gt;&lt;/div&gt;
&lt;% <span class="synStatement">end</span> %&gt;

&lt;%= render <span class="synSpecial">&quot;</span><span class="synConstant">devise/shared/links</span><span class="synSpecial">&quot;</span> %&gt;
</pre><p><br />
では、画面を開いて、 [Sign in with Twitter]リンクを押しましょう。<br />
エラーがEmailの未入力だけになっていますね。Emailを入力して、ユーザ登録しましょう。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803025926.png" alt="f:id:nipe880324:20140803025926p:plain:w320" title="f:id:nipe880324:20140803025926p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>ユーザ登録できました。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803030035.png" alt="f:id:nipe880324:20140803030035p:plain:w320" title="f:id:nipe880324:20140803030035p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>ログアウトして、[Sign in with Twitter]リンクをするとログインができます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803030045.png" alt="f:id:nipe880324:20140803030045p:plain:w320" title="f:id:nipe880324:20140803030045p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p></p>

</div>
<div class="section">
    <h3>DeviseにOmniAuthのインストールと設定（プロフィール変更の修正）</h3>
    <p>ほぼほぼ完成ですが１つ問題があります。<br />
パスワードが存在しないためプロフィール変更ができません。</p><p>まず、パスワードがなくても更新できるように、Userモデルにメソッドを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/user.rb</span>
  ...
  <span class="synComment"># プロフィールを変更するときによばれる</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">update_with_password</span>(params, *options)
    <span class="synComment"># パスワードが空の場合</span>
    <span class="synStatement">if</span> encrypted_password.blank?
      <span class="synComment"># パスワードがなくても更新できる</span>
      update_attributes(params, *options)
    <span class="synStatement">else</span>
      <span class="synStatement">super</span>
    <span class="synStatement">end</span>
  <span class="synPreProc">end</span>
  ...
</pre><p><br />
Viewで現在のパスワードフィールドを表示しないようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/views/devise/registrations/edit.html.erb</span>
&lt;h2&gt;<span class="synType">Edit</span> &lt;%= resource_name.to_s.humanize %&gt;&lt;/h2&gt;

&lt;%= form_for(resource, <span class="synConstant">as</span>: resource_name, <span class="synConstant">url</span>: registration_path(resource_name), <span class="synConstant">html</span>: { <span class="synConstant">method</span>: <span class="synConstant">:put</span> }) <span class="synStatement">do</span> |<span class="synIdentifier">f</span>| %&gt;
  &lt;%= devise_error_messages! %&gt;

  &lt;div&gt;&lt;%= f.label <span class="synConstant">:username</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">  &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">email_field :username, autofocus: true %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;

  &lt;div&gt;&lt;%= f.label <span class="synConstant">:email</span> %&gt;&lt;br <span class="synSpecial">/</span><span class="synConstant">&gt;</span>
<span class="synConstant">  &lt;%= f</span><span class="synSpecial">.</span><span class="synConstant">email_field :email %&gt;&lt;</span><span class="synSpecial">/</span>div&gt;

  &lt;% <span class="synStatement">if</span> devise_mapping.confirmable? &amp;&amp; resource.pending_reconfirmation? %&gt;
    &lt;div&gt;<span class="synType">Currently</span> waiting confirmation <span class="synStatement">for</span>: &lt;%= resource.unconfirmed_email %&gt;&lt;/div&gt;
  &lt;% <span class="synStatement">end</span> %&gt;

  &lt;div&gt;&lt;%= f.label <span class="synConstant">:password</span> %&gt; &lt;i&gt;(leave blank <span class="synStatement">if</span> you don<span class="synSpecial">'</span><span class="synConstant">t want to change it)&lt;/i&gt;&lt;br /&gt;</span>
<span class="synConstant">    &lt;%= f.password_field :password, autocomplete: &quot;off&quot; %&gt;&lt;/div&gt;</span>

<span class="synConstant">  &lt;div&gt;&lt;%= f.label :password_confirmation %&gt;&lt;br /&gt;</span>
<span class="synConstant">    &lt;%= f.password_field :password_confirmation, autocomplete: &quot;off&quot; %&gt;&lt;/div&gt;</span>

<span class="synConstant">  &lt;% if f.object.encrypted_password.present? %&gt;</span>
<span class="synConstant">    &lt;div&gt;&lt;%= f.label :current_password %&gt; &lt;i&gt;(we need your current password to confirm your changes)&lt;/i&gt;&lt;br /&gt;</span>
<span class="synConstant">      &lt;%= f.password_field :current_password, autocomplete: &quot;off&quot; %&gt;&lt;/div&gt;</span>
<span class="synConstant">  &lt;% end %&gt;</span>

<span class="synConstant">  &lt;div&gt;&lt;%= f.submit &quot;Update&quot; %&gt;&lt;/div&gt;</span>
<span class="synConstant">&lt;% end %&gt;</span>

<span class="synConstant">&lt;h3&gt;Cancel my account&lt;/h3&gt;</span>

<span class="synConstant">&lt;p&gt;Unhappy? &lt;%= button_to &quot;Cancel my account&quot;, registration_path(resource_name), data: { confirm: &quot;Are you sure?&quot; }, method: :delete %&gt;&lt;/p&gt;</span>

<span class="synConstant">&lt;%= link_to &quot;Back&quot;, :back %&gt;</span>
</pre><p>では、画面でプロフィール更新画面で現在のパスワードフィールドが表示されません。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803031905.png" alt="f:id:nipe880324:20140803031905p:plain:w320" title="f:id:nipe880324:20140803031905p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p>そして、プロフィールが更新できました。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140803/20140803031907.png" alt="f:id:nipe880324:20140803031907p:plain:w320" title="f:id:nipe880324:20140803031907p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p>とっても長くなりましたが以上です。<br />
<br />
</p>

</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li><a href="https://github.com/plataformatec/devise/wiki/OmniAuth:-Overview">OmniAuth Official Wiki</a></li>
<li><a href="https://github.com/intridea/omniauth/wiki/List-of-Strategies">OmniAuthの対応しているOAuthプロバイダ</a></li>
</ul>
</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140805/1407200400.html"><time data-relative datetime="2014-08-05T01:00:00Z" title="2014-08-05T01:00:00Z" pubdate class="updated">2014-08-05 10:00</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140805/1407200400" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140805%2F1407200400" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140805/1407200400" data-count="vertical" data-text="Railsのログイン認証gemのDeviseとOmniAuth-Twitterの連携（Twitterでログインする） - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140805/1407200400" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
          <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-4438296558807254"
     data-ad-slot="4370884664"
     data-ad-format="horizontal"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>


          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
                <article class="entry hentry js-entry-article date-last autopagerize_page_element chars-13200 words-1000 mode-hatena entry-odd" id="entry-12921228815729298218" data-keyword-campaign="" data-uuid="12921228815729298218">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date last">
        <a href="entries/2014/08/05.html" rel="nofollow">
          <time pubdate datetime="2014-08-04T16:00:00Z" title="2014-08-04T16:00:00Z">
            <span class="date-year">2014</span><span class="hyphen">-</span><span class="date-month">08</span><span class="hyphen">-</span><span class="date-day">05</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="entry/20140804/1407168000.html" class="entry-title-link bookmark">Railsのログイン認証gemのDeviseのカスタマイズ方法</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="archive/category/Rails%20gem.html">Rails gem</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p><a href="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" class="http-image" target="_blank"><img src="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" class="http-image" alt="https://camo.githubusercontent.com/b1c21cc10f2f94857dea5135fe55f2e4d451e028/68747470733a2f2f7261772e6769746875622e636f6d2f706c617461666f726d617465632f6465766973652f6d61737465722f6465766973652e706e67" width="320"></a></p><p>Deviseで認証機能を使う、Viewの編集、日本語化、<code>sign_in</code>や<code>sign_out</code>のURLの変更などdeviseのカスタマイズについて説明します。</p><p><b>実際に試す場合は、前記事を実施済みだと差分を埋め合わせる必要がなくなり簡単です。</b><br />
</p>

<ol>
<li><a href="index-page=1407915718.html#devise-control-access">Deviseでのアクセス制限をする</a></li>
<li><a href="index-page=1407915718.html#devise-customize-view">DeviseのViewをカスタマイズする</a></li>
<li><a href="index-page=1407915718.html#devise-i18n-ja">Deviseで出力される文字列の日本語化</a></li>
<li><a href="index-page=1407915718.html#devise-root-devise">デバイスの画面をルートに設定</a></li>
<li><a href="index-page=1407915718.html#devise-customize-url">URL(Route)のカスタマイズ</a></li>
<li><a href="index-page=1407915718.html#devise-add-column-to-model">Userモデルにusernameカラムを追加</a></li>
<li><a href="index-page=1407915718.html#devise-test-helper">Deviseのテストヘルパー</a></li>
</ol>
<ul>
<li>前回は、「<a href="entry/20140801/1406907000.html">RailsでDeviseのインストール方法</a>」を説明しました。</li>
<li>今回はその「Deviseのカスタマイズ方法」について説明します。</li>
<li>次回は、「<a href="entry/20140805/1407200400.html">DeviseとOmniAuth-Twitter連携（Twitterでログインする）</a>」です。</li>
</ul>
<div class="section">
    <h3>動作確認</h3>
    <p>・Rails 4.1.4<br />
・Devise 3.2.4<br />
<br />
<br />
</p>

</div>
<div class="section">
    <h3>目次</h3>
    
<ol>
<li><a href="index-page=1407915718.html#devise-control-access">Deviseでのアクセス制限をする</a></li>
<li><a href="index-page=1407915718.html#devise-customize-view">DeviseのViewをカスタマイズする</a></li>
<li><a href="index-page=1407915718.html#devise-i18n-ja">Deviseで出力される文字列の日本語化</a></li>
<li><a href="index-page=1407915718.html#devise-root-devise">デバイスの画面をルートに設定</a></li>
<li><a href="index-page=1407915718.html#devise-customize-url">URL(Route)のカスタマイズ</a></li>
<li><a href="index-page=1407915718.html#devise-add-column-to-model">Userモデルにusernameカラムを追加</a></li>
<li><a href="index-page=1407915718.html#devise-test-helper">Deviseのテストヘルパー</a></li>
</ol><p></p><p><h3 id="devise-control-access">Deviseでのアクセス制限をする</h3>Homeのshow画面へのアクセス制限を追加してみます。<br />
ログインしてない状態でも、<code>http://localhost:3000/home/show</code>にアクセスできます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802220516.png" alt="f:id:nipe880324:20140802220516p:plain:w320" title="f:id:nipe880324:20140802220516p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>Controllerに次のようにアクセス制限を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">class</span> <span class="synType">HomeController</span> &lt; <span class="synType">ApplicationController</span>
  <span class="synComment"># ユーザがログインしていないと&quot;show&quot;にアクセスできない</span>
  before_action <span class="synConstant">:authenticate_user!</span>, <span class="synConstant">only</span>: <span class="synConstant">:show</span>

  <span class="synPreProc">def</span> <span class="synIdentifier">index</span>
  <span class="synPreProc">end</span>

  <span class="synPreProc">def</span> <span class="synIdentifier">show</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>では、ログインしていない状態のまま、<code>http://localhost:3000/home/show</code>にアクセスしてみましょう。<br />
アクセスすると、「You need to sign in or sigh up before continuing.」と表示され「Sign in画面」にリダイレクトされます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802220816.png" alt="f:id:nipe880324:20140802220816p:plain:w320" title="f:id:nipe880324:20140802220816p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>このように、アクセス制限を追加できます。<br />
ちなみに、異なるユーザの場合表示させないわけではないので、そこは実装が必要です。</p><br />
<p><h3 id="devise-customize-view">DeviseのViewをカスタマイズする</h3>Sign in画面などdeviseのViewの見た目を変えたいというときがあると思います。<br />
ここでは、Viewの変え方について説明します。</p><p>次のコマンドを実施することにより、<code>app/views/devise配下</code>にdeviseのViewが作成されます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g devise<span class="synConstant">:views</span>
     invoke  <span class="synType">Devise</span>::<span class="synType">Generators</span>::<span class="synType">SharedViewsGenerator</span>
      create    app/views/devise/shared
      create    app/views/devise/shared/_links.erb
      invoke  form_for
      create    app/views/devise/confirmations
      create    app/views/devise/confirmations/new.html.erb
      create    app/views/devise/passwords
      create    app/views/devise/passwords/edit.html.erb
      create    app/views/devise/passwords/new.html.erb
      create    app/views/devise/registrations
      create    app/views/devise/registrations/edit.html.erb
      create    app/views/devise/registrations/new.html.erb
      create    app/views/devise/sessions
      create    app/views/devise/sessions/new.html.erb
      create    app/views/devise/unlocks
      create    app/views/devise/unlocks/new.html.erb
      invoke  erb
      create    app/views/devise/mailer
      create    app/views/devise/mailer/confirmation_instructions.html.erb
      create    app/views/devise/mailer/reset_password_instructions.html.erb
      create    app/views/devise/mailer/unlock_instructions.html.erb
</pre><p>この作成されたファイルを編集することにより、deviseのViewの表示をカスタマイズすることができます。<br />
ちなみに各フォルダの対応は次のようになっています。</p>

<ul>
<li>app/views/devise/sessions/new.html.erb ... ログイン画面</li>
<li>app/views/devise/registrations/new.html.erb ... ユーザ登録画面</li>
<li>app/views/devise/registrations/edit.html.erb ... ユーザ情報変更画面</li>
<li>app/views/devise/passwords/new.html.erb ... パスワードを変更するためのメールを送信する画面</li>
<li>app/views/devise/passwords/edit.html.erb ... パスワードを変更する画面</li>
<li>app/views/devise/confirmations/new.html.erb ... メールによるConfirmをする画面</li>
<li>app/views/devise/unlocks/new.html.erb ... アカウントのアンロック画面</li>
</ul><p><br />
試しに、「Sign in画面」の<code>h2タグのSign inを日本語に変更</code>してみましょう。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/devise/sessions/new.html.erb
<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>ログイン<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_for(resource,</span><span class="synIdentifier"> as: resource_name, </span><span class="synType">url</span><span class="synIdentifier">: session_path(resource_name)) do |f| %&gt;</span>
...
...
</pre><p>では、変更後の画面を見てましょう。ページ上部が「ログイン」と表示されているでしょうか。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802221957.png" alt="f:id:nipe880324:20140802221957p:plain:w320" title="f:id:nipe880324:20140802221957p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>今回は小さな変更でしたが、HTMLやCSSをいじることにより、自分の好きなログイン画面やユーザ登録画面を表示することが可能です。</p><br />
<p><h3 id="devise-i18n-ja">Deviseで出力される文字列の日本語化</h3>日本語化する箇所は２つあります。</p>

<ul>
<li>上記で行った「DeviseのViewをカスタマイズする」で作成した、Viewファイルのハードコーディングされた英語の文字列を日本語に変更する</li>
<li>コントローラーやモデルが出力するメッセージを日本語化するために、<code>ja.yml</code>と<code>devise.ja.yml</code>を作成する</li>
</ul><p>です。</p><p>２番目の日本語化について実施していきます。</p>

<div class="section">
    <h5><code>ja.yml</code>と<code>devise.ja.yml</code>を作成</h5>
    <p>幸いなことに、他の方が作った<code>ja.yml</code>と<code>devise.ja.yml</code>がありますのでその内容をコピーします。</p>

<ul>
<li><a href="https://github.com/svenfuchs/rails-i18n/blob/master/rails/locale/ja.yml" target="_blank">ja.yaml</a> => <code>config/locales/ja.yml</code></li>
<li><a href="https://gist.github.com/yanagi0324/f63499851fa638690e09" target="_blank">devise.ja.yml (Rails 4 / devise 3.2.2 対応)</a> => <code>config/locales/devise.ja.yml</code></li>
</ul>
</div>
<div class="section">
    <h4>Railsの<code>defaul_locale</code>を日本語に設定</h4>
    <p>アプリケーションのデフォルトのロケールを"日本語"に設定します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/application.rb</span>
...
  <span class="synPreProc">class</span> <span class="synType">Application</span> &lt; <span class="synType">Rails</span>::<span class="synType">Application</span>
  	...
    <span class="synComment"># config.i18n.default_locale = :de</span>
    config.i18n.default_locale = <span class="synConstant">:ja</span>
  <span class="synPreProc">end</span>
end
</pre><p>サーバを再起動して、画面を確認するとログイン時などの文字列が日本語になっていると思います。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802223537.png" alt="f:id:nipe880324:20140802223537p:plain:w320" title="f:id:nipe880324:20140802223537p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p><h3 id="devise-root-devise">デバイスの画面をルートに設定</h3>デバイスの画面をホーム画面(<code>root :to</code>)に設定するには次のように記載します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/route.rb</span>
  ...
  <span class="synComment"># ログイン画面をホームにする</span>
  devise_scope <span class="synConstant">:user</span> <span class="synStatement">do</span>
    root <span class="synConstant">:to</span> =&gt; <span class="synSpecial">&quot;</span><span class="synConstant">devise/sessions#new</span><span class="synSpecial">&quot;</span>
  <span class="synStatement">end</span>
  ...
</pre><p>ちなみに、<code>rake routes</code>コマンドで「デバイスの画面」と「コントローラーとアクション」の対応付けを確認できます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake routes
                  <span class="synType">Prefix</span> <span class="synType">Verb</span>   <span class="synType">URI</span> <span class="synType">Pattern</span>                    <span class="synType">Controller</span><span class="synComment">#Action</span>
                    root <span class="synType">GET</span>    /                              devise/sessions<span class="synComment">#new</span>
        new_user_session <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_in(.<span class="synConstant">:format</span>)       devise/sessions<span class="synComment">#new</span>
            user_session <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_in(.<span class="synConstant">:format</span>)       devise/sessions<span class="synComment">#create</span>
    destroy_user_session <span class="synType">DELETE</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_out(.<span class="synConstant">:format</span>)      devise/sessions<span class="synComment">#destroy</span>
           user_password <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#create</span>
       new_user_password <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password/new(.<span class="synConstant">:format</span>)  devise/passwords<span class="synComment">#new</span>
      edit_user_password <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password/edit(.<span class="synConstant">:format</span>) devise/passwords<span class="synComment">#edit</span>
                         <span class="synType">PATCH</span>  <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#update</span>
                         <span class="synType">PUT</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#update</span>
cancel_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>cancel(.<span class="synConstant">:format</span>)        devise/registrations<span class="synComment">#cancel</span>
       user_registration <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#create</span>
   new_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_up(.<span class="synConstant">:format</span>)       devise/registrations<span class="synComment">#new</span>
  edit_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/e</span>dit(.<span class="synConstant">:format</span>)          devise/registrations<span class="synComment">#edit</span>
                         <span class="synType">PATCH</span>  <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#update</span>
                         <span class="synType">PUT</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#update</span>
                         <span class="synType">DELETE</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#destroy</span>
</pre><p><h3 id="devise-customize-url">URL(Route)のカスタマイズ</h3>deviseのデフォルトのURLが気に入らない場合、変更することが可能です。<br />
deviseのデフォルトのURLは次のようになっています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake routes
                  <span class="synType">Prefix</span> <span class="synType">Verb</span>   <span class="synType">URI</span> <span class="synType">Pattern</span>                    <span class="synType">Controller</span><span class="synComment">#Action</span>
        new_user_session <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_in(.<span class="synConstant">:format</span>)       devise/sessions<span class="synComment">#new</span>
            user_session <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_in(.<span class="synConstant">:format</span>)       devise/sessions<span class="synComment">#create</span>
    destroy_user_session <span class="synType">DELETE</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_out(.<span class="synConstant">:format</span>)      devise/sessions<span class="synComment">#destroy</span>
           user_password <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#create</span>
       new_user_password <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password/new(.<span class="synConstant">:format</span>)  devise/passwords<span class="synComment">#new</span>
      edit_user_password <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password/edit(.<span class="synConstant">:format</span>) devise/passwords<span class="synComment">#edit</span>
                         <span class="synType">PATCH</span>  <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#update</span>
                         <span class="synType">PUT</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>password(.<span class="synConstant">:format</span>)      devise/passwords<span class="synComment">#update</span>
cancel_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>cancel(.<span class="synConstant">:format</span>)        devise/registrations<span class="synComment">#cancel</span>
       user_registration <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#create</span>
   new_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/si</span>gn_up(.<span class="synConstant">:format</span>)       devise/registrations<span class="synComment">#new</span>
  edit_user_registration <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/e</span>dit(.<span class="synConstant">:format</span>)          devise/registrations<span class="synComment">#edit</span>
                         <span class="synType">PATCH</span>  <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#update</span>
                         <span class="synType">PUT</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#update</span>
                         <span class="synType">DELETE</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">(.</span><span class="synConstant">:format</span><span class="synSpecial">)</span><span class="synConstant">               devise</span><span class="synSpecial">/</span>registrations<span class="synComment">#destroy</span>
</pre><p>今回は、</p>

<ul>
<li>サインイン画面は、<code>/users/sign_in</code>から<code>/users/login</code></li>
<li>サインアウト処理は、<code>/users/sign_out</code>から<code>/users/logout</code></li>
</ul><p>に変えてみます。</p><p>変更方法は簡単で、<code>routes.rb</code>ファイルを次のように変更させるだけです。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/routes.rb</span>
  devise_for <span class="synConstant">:users</span>, <span class="synConstant">path_names</span>: { <span class="synConstant">sign_in</span>: <span class="synSpecial">&quot;</span><span class="synConstant">login</span><span class="synSpecial">&quot;</span>, <span class="synConstant">sign_out</span>: <span class="synSpecial">&quot;</span><span class="synConstant">logout</span><span class="synSpecial">&quot;</span>}
</pre><p>では、<code>$rake routes</code>コマンドでURLを確認してみましょう。<br />
「URL Pattern」が<code>login</code>と<code>logout</code>になっています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake routes
                  <span class="synType">Prefix</span> <span class="synType">Verb</span>   <span class="synType">URI</span> <span class="synType">Pattern</span>                    <span class="synType">Controller</span><span class="synComment">#Action</span>
        new_user_session <span class="synType">GET</span>    <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>login(.<span class="synConstant">:format</span>)         devise/sessions<span class="synComment">#new</span>
            user_session <span class="synType">POST</span>   <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>login(.<span class="synConstant">:format</span>)         devise/sessions<span class="synComment">#create</span>
    destroy_user_session <span class="synType">DELETE</span> <span class="synSpecial">/</span><span class="synConstant">users</span><span class="synSpecial">/</span>logout(.<span class="synConstant">:format</span>)        devise/sessions<span class="synComment">#destroy</span>
    ...
    ...
</pre><p><br />
<h3 id="devise-add-column-to-model">Userモデルにusernameカラムを追加</h3>deviseは<code>email</code>と<code>password</code>を使ってログインをします。<br />
これを、<code>username</code>と<code>password</code>に変える方法を説明します。</p><p>まず、テーブルに<code>username</code>を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails g migration add_username_to_users username<span class="synConstant">:string</span>
</pre><p><code>username</code>は、ログイン時のキーとなるので、indexの追加と一意制約を追加しておきます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/migrate/20140802133822_add_username_to_users.rb</span>
<span class="synPreProc">class</span> <span class="synType">AddUsernameToUsers</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Migration</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">change</span>
    add_column <span class="synConstant">:users</span>, <span class="synConstant">:username</span>, <span class="synConstant">:string</span>
    add_index <span class="synConstant">:users</span>, <span class="synConstant">:username</span>, <span class="synConstant">unique</span>: <span class="synConstant">true</span>
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>では、マイグレートを実施します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rake db<span class="synConstant">:migrate</span>
</pre><p>次に、deviseの設定ファイルで認証キーを<code>email</code>から<code>username</code>に変えます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/initializers/devise.rb</span>
  ...
  <span class="synComment"># ==&gt; Configuration for any authentication mechanism</span>
  <span class="synComment"># Configure which keys are used when authenticating a user. The default is</span>
  <span class="synComment"># just :email. You can configure it to use [:username, :subdomain], so for</span>
  <span class="synComment"># authenticating a user, both parameters are required. Remember that those</span>
  <span class="synComment"># parameters are used only when authenticating and not when retrieving from</span>
  <span class="synComment"># session. If you need permissions, you should implement that in a before filter.</span>
  <span class="synComment"># You can also supply a hash where the value is a boolean determining whether</span>
  <span class="synComment"># or not authentication should be aborted when the value is not present.</span>
  <span class="synComment"># config.authentication_keys = [ :email ]</span>
  config.authentication_keys = [ <span class="synConstant">:username</span> ]
  ...
</pre><p>UserモデルにValidateを追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">class</span> <span class="synType">User</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  ...

  validates <span class="synConstant">:username</span>, <span class="synConstant">presence</span>: <span class="synConstant">true</span>, <span class="synConstant">uniqueness</span>: <span class="synConstant">true</span>
<span class="synPreProc">end</span>
</pre><p><br />
ログイン画面の<code>email</code>を<code>username</code>の入力フィールドに変更します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/devise/sessions/new.html.erb
<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>ログイン<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_for(resource,</span><span class="synIdentifier"> as: resource_name, </span><span class="synType">url</span><span class="synIdentifier">: session_path(resource_name)) do |f| %&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :username %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.text_field</span><span class="synIdentifier"> :username, autofocus: true %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :password %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :password, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;% if devise_mapping.rememberable? -%&gt;</span>
    <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.check_box</span><span class="synIdentifier"> :remember_me %&gt;</span> <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :remember_me %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;% end -%&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.submit</span><span class="synIdentifier"> </span><span class="synConstant">&quot;Sign in&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> render</span><span class="synIdentifier"> </span><span class="synConstant">&quot;devise/shared/links&quot;</span><span class="synIdentifier"> %&gt;</span>
</pre><p>サインアップ画面も対応しておきましょう。"username" のフィールドを追加します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/devise/registrations/new.html.erb
<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>Sign up<span class="synIdentifier">&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_for(resource,</span><span class="synIdentifier"> as: resource_name, </span><span class="synType">url</span><span class="synIdentifier">: registration_path(resource_name)) do |f| %&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> devise_error_messages!</span><span class="synIdentifier"> %&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :username %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.text_field</span><span class="synIdentifier"> :username, autofocus: true %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :email %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.email_field</span><span class="synIdentifier"> :email %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :password %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :password, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :password_confirmation %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :password_confirmation, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.submit</span><span class="synIdentifier"> </span><span class="synConstant">&quot;Sign up&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> render</span><span class="synIdentifier"> </span><span class="synConstant">&quot;devise/shared/links&quot;</span><span class="synIdentifier"> %&gt;</span>
</pre><p>同じく、プロフィール変更画面も、"username"を追加します。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/devise/registrations/edit.html.erb
<span class="synIdentifier">&lt;</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>Edit <span class="synIdentifier">&lt;%=</span><span class="synConstant"> resource_name.to_s.humanize</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">h2</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_for(resource,</span><span class="synIdentifier"> as: resource_name, </span><span class="synType">url</span><span class="synIdentifier">: registration_path(resource_name), html: { </span><span class="synType">method</span><span class="synIdentifier">: :put }) do |f| %&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> devise_error_messages!</span><span class="synIdentifier"> %&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :username %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.text_field</span><span class="synIdentifier"> :username, autofocus: true %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :email %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.email_field</span><span class="synIdentifier"> :email %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;% if devise_mapping.confirmable? &amp;&amp; resource.pending_reconfirmation? %&gt;</span>
    <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>Currently waiting confirmation for: <span class="synIdentifier">&lt;%=</span><span class="synConstant"> resource.unconfirmed_email</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;% end %&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :password %&gt;</span> <span class="synIdentifier">&lt;</span><span class="synStatement">i</span><span class="synIdentifier">&gt;</span>(leave blank if you don't want to change it)<span class="synIdentifier">&lt;/</span><span class="synStatement">i</span><span class="synIdentifier">&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :password, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :password_confirmation %&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :password_confirmation, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.label</span><span class="synIdentifier"> :current_password %&gt;</span> <span class="synIdentifier">&lt;</span><span class="synStatement">i</span><span class="synIdentifier">&gt;</span>(we need your current password to confirm your changes)<span class="synIdentifier">&lt;/</span><span class="synStatement">i</span><span class="synIdentifier">&gt;&lt;</span><span class="synStatement">br</span><span class="synIdentifier"> /&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> f.password_field</span><span class="synIdentifier"> :current_password, autocomplete: </span><span class="synConstant">&quot;off&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> f.submit</span><span class="synIdentifier"> </span><span class="synConstant">&quot;Update&quot;</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>

<span class="synIdentifier">&lt;</span><span class="synStatement">h3</span><span class="synIdentifier">&gt;</span>Cancel my account<span class="synIdentifier">&lt;/</span><span class="synStatement">h3</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;</span><span class="synStatement">p</span><span class="synIdentifier">&gt;</span>Unhappy? <span class="synIdentifier">&lt;%=</span><span class="synConstant"> button_to</span><span class="synIdentifier"> </span><span class="synConstant">&quot;Cancel my account&quot;</span><span class="synIdentifier">, registration_path(resource_name), </span><span class="synType">data</span><span class="synIdentifier">: { confirm: </span><span class="synConstant">&quot;Are you sure?&quot;</span><span class="synIdentifier"> }, </span><span class="synType">method</span><span class="synIdentifier">: :delete %&gt;&lt;/</span><span class="synStatement">p</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;%=</span><span class="synConstant"> link_to</span><span class="synIdentifier"> </span><span class="synConstant">&quot;Back&quot;</span><span class="synIdentifier">, :back %&gt;</span>
</pre><p>既にユーザが登録されているため、<code>username</code>に"testuser"という値をコンソールから入力します。<br />
もちろん、実際に変更するときは、サインインやプロフィール変更などの画面の修正は忘れずに修正してください。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>$ rails c
<span class="synType">Loading</span> development environment (<span class="synType">Rails</span> <span class="synConstant">4.1</span>.<span class="synConstant">4</span>)
irb(main):<span class="synConstant">001</span>:<span class="synConstant">0</span>&gt; <span class="synType">User</span>.first
=&gt; <span class="synComment">#&lt;User id: 2, email: &quot;test@example.com&quot;, encrypted_password: &quot;$2a$10$Oabg0hmZDismBJ2pxtfIxO9MK04/KQ7QtjnITlWXL83...&quot;, reset_password_token: nil, reset_password_sent_at: nil, remember_created_at: nil, sign_in_count: 6, current_sign_in_at: &quot;2014-07-31 08:51:22&quot;, last_sign_in_at: &quot;2014-07-31 08:50:50&quot;, current_sign_in_ip: &quot;127.0.0.1&quot;, last_sign_in_ip: &quot;127.0.0.1&quot;, created_at: &quot;2014-07-31 08:18:45&quot;, updated_at: &quot;2014-07-31 08:51:22&quot;, username: nil&gt;</span>
&gt; <span class="synType">User</span>.first.update_attribute(<span class="synConstant">:username</span>, <span class="synSpecial">&quot;</span><span class="synConstant">testuser</span><span class="synSpecial">&quot;</span>)
=&gt; <span class="synConstant">true</span>
</pre><p>では、ログイン画面を開いてログインしましょう。<br />
"Username"が表示されていると思います。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802230848.png" alt="f:id:nipe880324:20140802230848p:plain:w320" title="f:id:nipe880324:20140802230848p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span><br />
そして、ログインができます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20140802/20140802230853.png" alt="f:id:nipe880324:20140802230853p:plain:w320" title="f:id:nipe880324:20140802230853p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p>もし<code>development.log</code>に<code>Unpermitted parameters</code>が出た場合は、"Strong Parameter"のエラーのため、下記のコードを追加して下さい。<br />
":username"の箇所は、エラー内容で表示されている変数名に変えて下さい。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/controllers/application_controller.rb</span>
<span class="synPreProc">class</span> <span class="synType">ApplicationController</span> &lt; <span class="synType">ActionController</span>::<span class="synType">Base</span>
  <span class="synComment"># Prevent CSRF attacks by raising an exception.</span>
  <span class="synComment"># For APIs, you may want to use :null_session instead.</span>
  protect_from_forgery <span class="synConstant">with</span>: <span class="synConstant">:exception</span>

  <span class="synComment"># deviceのコントローラーのときに、下記のメソッドを呼ぶ</span>
  before_action <span class="synConstant">:configure_permitted_parameters</span>, <span class="synStatement">if</span>: <span class="synConstant">:devise_controller?</span>

  <span class="synStatement">protected</span>

    <span class="synPreProc">def</span> <span class="synIdentifier">configure_permitted_parameters</span>
      <span class="synComment"># sign_inのときに、usernameも許可する</span>
      devise_parameter_sanitizer.for(<span class="synConstant">:sign_in</span>) &lt;&lt; <span class="synConstant">:username</span>
      <span class="synComment"># sign_upのときに、usernameも許可する</span>
      devise_parameter_sanitizer.for(<span class="synConstant">:sign_up</span>) &lt;&lt; <span class="synConstant">:username</span>
      <span class="synComment">#  account_updateのときに、usernameも許可する</span>
      devise_parameter_sanitizer.for(<span class="synConstant">:account_update</span>) &lt;&lt; <span class="synConstant">:username</span>
    <span class="synPreProc">end</span>
<span class="synStatement">end</span>
</pre><p></p><p><h3 id="devise-test-helper">Deviseのテストヘルパー</h3>deviseは、テストで有用なテストヘルパーを提供しています。<br />
それの簡単な使い方について説明します。</p><p>まず、テストにdeviseのテストヘルパーを追加します。</p>

</div>
<div class="section">
    <h4>デフォルトのTestフレームワークを使っている場合</h4>
    <pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># test/test_helper.rb </span>
<span class="synPreProc">class</span> <span class="synType">ActiveSupport</span>::<span class="synType">TestCase</span>
  ...
  <span class="synPreProc">include</span> <span class="synType">Devise</span>::<span class="synType">TestHelpers</span>
  ...
<span class="synPreProc">end</span>
</pre>
<div class="section">
    <h5>RSpecを使っている場合</h5>
    <pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># spec/spec_helper.rb </span>
<span class="synType">RSpec</span>.configure <span class="synStatement">do</span> |<span class="synIdentifier">config</span>|
  ...
  config.include <span class="synType">Devise</span>::<span class="synType">TestHelpers</span>, <span class="synConstant">type</span>: <span class="synConstant">:controller</span>
  ...
<span class="synStatement">end</span>
</pre><p>これで、以下のメソッドがControllerの中で利用ができます</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>sign_in <span class="synConstant">:user</span>, <span class="synIdentifier">@user</span>   <span class="synComment"># sign_in(scope, resource)</span>
sign_in <span class="synIdentifier">@user</span>          <span class="synComment"># sign_in(resource)</span>

sign_out <span class="synConstant">:user</span>         <span class="synComment"># sign_out(scope)</span>
sign_out <span class="synIdentifier">@user</span>         <span class="synComment"># sign_out(resource)</span>
</pre><p>テストにおいて、以下の２点ほど注意点があります。</p>

<ol>
<li><code>Capybara</code>や<code>Webrat</code>などで実行されるインテグレーションテストでは動作しません。機能テストのみでしか使えません。フォーム入力やセッションに値を設定することで代替して下さい。</li>
<li>Deviseの内部のテストやDeviseのコントローラを継承したコントローラの機能テストをする場合、リクエストをする前に、mapping情報を記載しなければなりません。これは、Deviseはrouteからmapping情報を取得しますが、機能テストではrouteを通らないのでmapping情報を知るすべがないからです。例として、user scopeのテストをする場合は、次のように記載します。</li>
</ol><pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synIdentifier">@request</span>.env[<span class="synSpecial">&quot;</span><span class="synConstant">devise.mapping</span><span class="synSpecial">&quot;</span>] = <span class="synType">Devise</span>.mappings[<span class="synConstant">:user</span>]
get <span class="synConstant">:new</span>
</pre>
</div>
</div>
</div>
<div class="section">
    <h3>まとめ</h3>
    <p>Deviseの一通りのカスタマイズ方法について学べたと思います。これで、Deviseを使って何かするときはほぼ問題ないと思います。<br />
次は、「<a href="entry/20140805/1407200400.html">DeviseとOmniAuth-Twitter連携（Twitterでログインする）</a>」です。</p>

</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li><a href="https://github.com/plataformatec/devise">plataformatec/devise &middot; GitHub</a></li>
</ul>
</div>
        
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="entry/20140804/1407168000.html"><time data-relative datetime="2014-08-04T16:00:00Z" title="2014-08-04T16:00:00Z" pubdate class="updated">2014-08-05 01:00</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20140804/1407168000" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20140804%2F1407168000" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20140804/1407168000" data-count="vertical" data-text="Railsのログイン認証gemのDeviseのカスタマイズ方法 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20140804/1407168000" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
            
            <div class="google-afc-image test-google-rectangle-ads ">
              
              
                <script>
  var hatenadfp = hatenadfp || {};
  hatenadfp.adUnits = hatenadfp.adUnits || [];
  hatenadfp.adUnits.push(
    
      { unitName: 'blog_user_2nd', size: [[300, 250], [336, 280]], divId: 'google_afc_user_container_3', allowContentMatch: true }
    
  );
  hatenadfp.isNGContent = false;
  
</script>

                <div id="google_afc_user_container_3" class="google_afc_blocklink2_5 google_afc_boder"></div>
                
                  <a href="http://blog.hatena.ne.jp/guide/pro" class="open-pro-modal" data-guide-pro-modal-ad-url="http://hatenablog.com/guide/pro/modal/ad">広告を非表示にする</a>
                
                
              
            </div>
          
        
      

      <div class="customized-footer">

        

      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
             <li class="read-more-comments" style="display: none;"><a>もっと読む (0)</a></li>
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                

              
            
            <!-- rakuten_ad_target_end -->
            <!-- google_ad_section_end -->

            
              <div class="pager autopagerize_insert_before">
                <span class="pager-next">
                  <a href="index-page=1407168000.html" rel="next">次のページ</a>
                </span>
              </div>
            
          
        </div>
      </div>

      
      <aside id="box1">
        <div id="box1-inner">
        </div>
      </aside>

    </div><!-- #wrapper -->

    <aside id="box2">
  
  <div id="box2-inner">
    
      
<div class="hatena-module hatena-module-html">
  <div class="hatena-module-body">
    <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-2736751992834286"
     data-ad-slot="8116686456"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
</div>

      
      
    
      

<div class="hatena-module hatena-module-profile">
  <div class="hatena-module-title">
    プロフィール
  </div>
  <div class="hatena-module-body">
    
    <a href="about.html" class="profile-icon-link">
      <img src="http://cdn1.www.st-hatena.com/users/ni/nipe880324/profile.gif?1406435422"
      alt="id:nipe880324" class="profile-icon" />
    </a>
    

    
    <span class="id">
      <a href="about.html" class="hatena-id-link"><span data-load-nickname="1" data-user-name="nipe880324">id:nipe880324</span></a>
      
  
    
    
  


    </span>
    

    

    
      <div class="hatena-follow-button-box btn-subscribe js-hatena-follow-button-box"
  
  >

  <a href="index-page=1407915718.html#" class="hatena-follow-button js-hatena-follow-button">
    <span class="subscribing">
      <span class="foreground">読者です</span>
      <span class="background">読者をやめる</span>
    </span>
    <span class="unsubscribing" data-track-name="profile-widget-subscribe-button" data-track-once>
      <span class="foreground">読者になる</span>
      <span class="background">読者になる</span>
    </span>
  </a>
  <div class="subscription-count-box js-subscription-count-box">
    <i></i>
    <u></u>
    <span class="subscription-count js-subscription-count">
    </span>
  </div>
</div>

    

    

    

    
  </div>
</div>

      
      
    
      
<div class="hatena-module hatena-module-entries-access-ranking"
     data-count="4"
     data-display_entry_category="1"
     data-display_entry_image="0"
     data-display_entry_image_size_width="100"
     data-display_entry_image_size_height="100"
     data-display_entry_body_length="0"
     data-display_entry_date="1"
     data-display_bookmark_count="0"
     data-source="access"
>
  <div class="hatena-module-title">
    
      最近のアクセス
    
  </div>
  <div class="hatena-module-body">
    
  </div>
</div>

      
      
    
      
<div class="hatena-module hatena-module-html">
    <div class="hatena-module-title">    </div>
  <div class="hatena-module-body">
    <nav>
  <div class="side-category">
    <span class="side-category-title">Rails 入門</span>
    <ul class="side-category-list">
      <li><a href="entry/20140713/1405251091.html">RailsのためのRuby基礎</a></li>
      <li><a href="entry/20140813/1407915718.html">Rails入門者向け ブログ開発</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Railsコマンド</span>
    <ul class="side-category-list">
      <li><a href="entry/20140713/1405251709.html">rails new / server / console</a></li>
      <li><a href="entry/20150204/1423055537.html">rails new時の有用な6つの設定</a></li>
      <li><a href="entry/20150208/1423391199.html">rails new時のテンプレート</a></li>
      <li><a href="entry/20140802/1406948695.html">rails generate</a></li>
      <li><a href="entry/20141116/1416115266.html">rakeコマンド一覧</a></li>
      <li><a href="entry/20141117/1416225563.html">自前rakeコマンド</a></li>
      <li><a href="entry/20141110/1415623670.html">productionモードで起動</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Route / Controller</span>
    <ul class="side-category-list">
      <li><a href="entry/20140716/1405451238.html">Routing</a></li>
      <li><a href="entry/20140810/1407603600.html">レイアウトファイルを指定</a></li>
      <li><a href="entry/20141125/1416918957.html">ビューを返す(render)</a></li>
      <li><a href="entry/20140808/1407427457.html">リダイレクトする(redirect_to)</a></li>
      <li><a href="entry/20141126/1417012848.html">Strong Parameters</a></li>
      <li><a href="entry/20141129/1417223453.html">フィルタ(before_action, after_action)</a></li>
      <li><a href="entry/20141127/1417086075.html">簡易なメッセージ表示(Flash)</a></li>
      <li><a href="entry/20141130/1417334030.html">セッション(session)</a></li>
      <li><a href="entry/20141201/1417432408.html">リクエストヘッダ、レスポンスヘッダ(request, response)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Model, Migration</span>
    <ul class="side-category-list">
      <li><a href="entry/20140724/1406142120.html">CRUD</a></li>
      <li><a href="entry/20141203/1417601540.html">1対多関連</a></li>
      <li><a href="entry/20141204/1417688260.html">多対多関連</a></li>
      <li><a href="entry/20141205/1417779929.html">1対1関連</a></li>
      <li><a href="entry/20141206/1417839458.html">STI(単一継承テーブル)</a></li>
      <li><a href="entry/20141207/1417926599.html">ポリモフィック関連</a></li>
      <li><a href="entry/20141208/1418018874.html">複数の子レコードを作成/更新</a></li>
      <li><a href="entry/20140724/1406145303.html">バリデーション(validation)</a></li>
      <li><a href="entry/20140810/1407623400.html">バリデーションエラー(validation errors)</a></li>
      <li><a href="entry/20140814/1407994568.html">スコープ(scope)</a></li>
      <li><a href="entry/20141211/1418301640.html">コールバック(callback)</a></li>
      <li><a href="entry/20150428/1430154446.html">複雑なSELECT文のまとめ</a></li>
      <li><a href="entry/20150710/1436461745.html">enum (Rails 4.1以上)</a></li>
      <li><a href="entry/20141209/1418123425.html">楽観的ロック</a></li>
      <li><a href="entry/20141210/1418207618.html">悲観的ロック</a></li>
      <li><a href="entry/20140810/1407634200.html">Migration(マイグレーション)</a></li>
      <li><a href="entry/20150607/1433606267.html">Postgresとマイグレーション</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">API</span>
    <ul class="side-category-list">
      <li><a href="entry/20150708/1436284476.html">Roar</a></li>
      <li>ActiveSerializer</li>
      <li>Versioning</li>
      <li>CORS</li>
    </ul>
  </div>

  <div class="side-category">
    <span class="side-category-title">View, Helper, Presenter</span>
    <ul class="side-category-list">
      <li><a href="entry/20140810/1407603600.html">レイアウトファイルを指定</a></li>
      <li><a href="entry/20140807/1407419013.html">部分テンプレート</a></li>
      <li><a href="entry/20140727/1406448610.html">フォーム周りのMVC連携フロー</a></li>
      <li><a href="entry/20150113/1421149061.html">ビューヘルパーまとめ(View Helper)</a></li>
      <li><a href="entry/20140802/1406969793.html">フォーマットヘルパー</a></li>
      <li><a href="entry/20140803/1407049200.html">独自ヘルパー作成</a></li>
      <li><a href="entry/20141208/1418018874.html">複数の子レコード(has_many)を作成/更新するフォーム</a></li>
      <li><a href="entry/20141225/1419515057.html">1フォームに複数のSubmitボタンを配置</a></li>
      <li><a href="entry/20140730/1406700205.html">simple_form</a></li>
      <li><a href="entry/20150415/1429031791.html">Draper</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">テンプレートエンジン</span>
    <ul class="side-category-list">
      <li><a href="entry/20140929/1411997071.html">HTMLテンプレートエンジンまとめ</a></li>
      <li><a href="entry/20140929/1411997071.html">Slim</a></li>
      <li><a href="entry/20141001/1412097051.html">Haml</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ActionSupport / ActionMailer / ActiveJob / i18n</span>
    <ul class="side-category-list">
      <li><a href="entry/20141217/1418817120.html">タイムゾーン、時刻処理</a></li>
      <li><a href="entry/20141218/1418901424.html">Timecop 時刻処理のテスト</a></li>
      <li><a href="entry/20141216/1418729961.html">クラス名,DB名,ファイル名の変換</a></li>
      <li><a href="entry/20141230/1419936984.html">JSON, XML, YAMLの読み書き</a></li>
      <li><a href="entry/20141030/1414599853.html">文字コード/エンコード</a></li>
      <li><a href="entry/20140828/1409236436.html">メール送信</a></li>
      <li><a href="entry/20150304/1425396671.html">DelayedJob バックグラウンド処理</a></li>
      <li><a href="entry/20150110/1420863998.html">ログ・ログレベル・ログフォーマット(log, logger)</a></li>
      <li><a href="entry/20150226/1424937175.html">i18nまとめ</a></li>
      <li><a href="entry/20141111/1415707101.html">エラーハンドリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">テスト</span>
    <ul class="side-category-list">
      <li><a href="entry/20150101/1420093487.html">RSpec/Capybaraの導入方法</a></li>
      <li><a href="entry/20150103/1420280252.html">RSpec/Capybaraのレシピ集</a></li>
      <li><a href="entry/20150101/1420093487.html">FactoryGirlのレシピ集</a></li>
      <li><a href="entry/20150105/1420465062.html">Jasmine(Javascriptの単体テスト)</a></li>
      <li><a href="entry/20150108/1420675366.html">APIの作成とテスト</a></li>
      <li><a href="entry/20150106/1420545920.html">RSpecテストを速くする</a></li>
      <li><a href="entry/20150108/1420721205.html">デバッグ(debug)</a></li>
      <li><a href="entry/20150420/1429462755.html">Seleniumでスタンドアローンなテスト</a></li>
      <li><a href="entry/20140719/1405708234.html">Cucumber+RSpec+Capybara インストール</a></li>
      <li><a href="entry/20140719/1405777918.html">Cucumber+RSpec+Capybara BDD/TDD開発例</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Security</span>
    <ul class="side-category-list">
      <li><a href="entry/20141215/1418641291.html">ログ上での秘密情報のフィルタリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">パフォーマンス</span>
    <ul class="side-category-list">
      <li><a href="entry/20141109/1415522242.html">Bullet</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">設定</span>
    <ul class="side-category-list">
      <li><a href="entry/20141224/1419414316.html">新しいEnvironmentを追加</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">UI/UX</span>
    <ul class="side-category-list">
      <li><a href="entry/20140801/1406818800.html">Twitter Bootstrap 3</a></li>
      <li><a href="entry/20141112/1415804076.html">select2</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Gemの基礎</span>
    <ul class="side-category-list">
      <li><a href="entry/20140715/1405361727.html">RubyGemsの選び方</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ログイン/認証機能</span>
    <ul class="side-category-list">
      <li><a href="entry/20140801/1406907000.html">devise1 インストール</a></li>
      <li><a href="entry/20140804/1407168000.html">devise2 カスタマイズ</a></li>
      <li><a href="entry/20140805/1407200400.html">devise3 Twitterでログイン(OAuth連携)</a></li>
      <li><a href="entry/20141212/1418380288.html">devise4 ゲストユーザー(Guest)作成</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ファイルアップロード機能</span>
    <ul class="side-category-list">
      <li><a href="entry/20140716/1405443484.html">PaperClip</a></li>
      <li><a href="entry/20141015/1413300088.html">CarrierWave1 インストール</a></li>
      <li><a href="entry/20141022/1413907332.html">CarrierWave2 カスタマイズ</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">検索機能・Elasticsearch</span>
    <ul class="side-category-list">
      <li><a href="entry/20141008/1412774436.html">Ransack 検索機能</a></li>
      <li><a href="entry/20150224/1424776132.html">Sunspot 全文検索</a></li>
      <li><a href="entry/20151018/1445142266.html">Elasticsearch 1: 全文検索・フィルタ</a></li>
      <li><a href="entry/20151019/1445265581.html">Elasticsearch 2: ページネーション</a></li>
      <li><a href="entry/20151021/1445353566.html">Elasticsearch 3: ソート</a></li>
      <li><a href="entry/20151022/1445439798.html">Elasticsearch 4: アグリゲーション（ファセット）・post_filter</a></li>
      <li><a href="20151025/1445703231.html">Elasticsearch 5: ハイライト</a></li>
      <li><a href="entry/20151027/1445957667.html">Elasticsearch 6: サジェスト</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ページネーション</span>
    <ul class="side-category-list">
      <li><a href="entry/20141118/1416314608.html">ページネーションまとめ</a></li>
      <li><a href="entry/20141113/1415874683.html">kaminari</a></li>
      <li><a href="entry/20141114/1415967206.html">will_paginate</a></li>
      <li><a href="entry/20141115/1416021886.html">動的ページロード</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">CSV</span>
    <ul class="side-category-list">
      <li><a href="entry/20141119/1416398472.html">CSVダウンロード</a></li>
      <li><a href="entry/20141120/1416483136.html">CSVアップロード</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">PDFファイル作成機能</span>
    <ul class="side-category-list">
      <li><a href="entry/20140906/1409995011.html">PDF作成Gem まとめ</a></li>
      <li><a href="entry/20140907/1410078997.html">コードのみでPDF作成 Prawn</a></li>
      <li><a href="entry/20140908/1410176894.html">HTMLを変換してPDF作成 PDFKit + wkhtmltopdf</a></li>
      <li><a href="entry/20140909/1410241835.html">GUIツールでPDF作成 ThinReports</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発効率をあげる</span>
    <ul class="side-category-list">
      <li><a href="entry/20141026/1414289421.html">Spring</a></li>
      <li><a href="entry/20141016/1413389293.html">Guard-LiveReload</a></li>
      <li><a href="entry/20141021/1413819783.html">Guard-RSpec</a></li>
      <li><a href="entry/20141019/1413698128.html">Guard-RuboCop</a></li>
      <li><a href="entry/20141024/1414081224.html">Pry-Rails / Pry-BuyBug</a></li>
      <li><a href="entry/20141024/1414160189.html">Hirb</a></li>
      <li><a href="entry/20141028/1414505988.html">Awesome Print</a></li>
      <li><a href="entry/20141029/1414584929.html">Quiet Assets</a></li>
      <li><a href="entry/20141025/1414225490.html">Better_Errors</a></li>
      <li><a href="entry/20141027/1414409495.html">Rails-ERD</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">その他Gem</span>
    <ul class="side-category-list">
      <li><a href="entry/20150225/1424858414.html">acts-as-taggable-on タグ管理</a></li>
      <li><a href="entry/20141016/1413389293.html">wenerber Cron設定</a></li>
      <li><a href="entry/20150221/1424489524.html">friendly_id URLスラッグ</a></li>
      <li><a href="entry/20150216/1424092796.html">awesome_nested_set ツリー構造</a></li>
      <li><a href="entry/20150217/1424179269.html">awesome_nested_set にjsTreeを追加</a></li>
      <li><a href="entry/20150214/1423923524.html">PaperTrail 取り消し機能</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Tips</span>
    <ul class="side-category-list">
      <li><a href="entry/20141229/1419856433.html">Virtual Attributes(仮想属性)</a></li>
      <li><a href="entry/20141226/1419600679.html">日付/時刻のフォーマット</a></li>
      <li><a href="entry/20141225/1419515057.html">1フォームに複数のSubmitボタンを配置</a></li>
      <li><a href="entry/20141223/1419334845.html">URLのパーマリンクをID以外に変更</a></li>
      <li><a href="entry/20141220/1419058040.html">CSSスタイリングのコントローラー単位で分割</a></li>
      <li><a href="entry/20141219/1418990626.html">ページタイトルの変更</a></li>
      <li><a href="entry/20150101/1420049679.html">Ruby/Railsの便利なメソッド(useful methods)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Rubyテクニック</span>
    <ul class="side-category-list">
      <li><a href="entry/20150921/1442839934.html">キーワード引数</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">良い設計/リファクタリング</span>
    <ul class="side-category-list">
      <li><a href="entry/20150922/1442923521.html">デメテルの法則(Law of Demeter)</a></li>
      <li><a href="entry/20150312/1426141352.html">HTML/CSS/JSを疎結合にする方法</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">JavaScript</span>
    <ul class="side-category-list">
      <li><a href="entry/20150311/1426062668.html">オブジェクト指向</a></li>
      <li><a href="entry/20150313/1426238835.html">thisの参照先</a></li>
      <li><a href="entry/20150317/1426599220.html">設定データを分離</a></li>
      <li><a href="entry/20150607/1433652441.html">ページを離れる時にアラートを出す</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">jQuery</span>
    <ul class="side-category-list">
      <li><a href="entry/20150325/1427291741.html">Ajax</a></li>
      <li><a href="entry/20150326/1427379215.html">イベント処理(Event)</a></li>
      <li><a href="entry/20150331/1427809820.html">DOM操作</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">React.js</span>
    <ul class="side-category-list">
      <li><a href="entry/20151122/1448118932.html">React.jsチュートリアル: メッセージボックス</a></li>
      <li><a href="entry/20151124/1448300267.html">サーバーレンダリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">AngularJS</span>
    <ul class="side-category-list">
      <li><a href="entry/20150114/1421235346.html">AngularJSのインストール</a></li>
      <li><a href="entry/20150115/1421316461.html">UI Bootstrapのインストール</a></li>
      <li><a href="entry/20150116/1421407124.html">AngularJS Controller</a>
      <li><a href="entry/20150119/1421666497.html">ngResource + RailsでAPI作成</a></li>
      <li><a href="entry/20150120/1421761471.html">ngRoute</a></li>
      <li><a href="entry/20150126/1422276839.html">編集可能(Editable)</a></li>
      <li><a href="entry/20150127/1422357163.html">ソート可能(Sortable)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発手法</span>
    <ul class="side-category-list">
      <li><a href="entry/20140917/1410963376.html">スクラム開発</a></li>
      <li><a href="entry/20141010/1412867452.html">カイゼンフレームワークKPT</a>
      <li><a href="entry/20140816/1408126999.html">GitHubを使ったチーム開発フロー</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発ツール</span>
    <ul class="side-category-list">
      <li><a href="entry/20141103/1414940400.html">git - 初期設定と便利なエイリアス</a></li>
      <li><a href="entry/20140713/1405248403.html">git - よく使うコマンド</a></li>
      <li><a href="entry/20140724/1406137504.html">SublimeText3 - 便利コマンドとプラグイン</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">DB</span>
    <ul class="side-category-list">
      <li><a href="entry/20140726/1406331785.html">MongoDBの基礎入門 CRUD操作</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">インフラ</span>
    <ul class="side-category-list">
      <li><a href="entry/20150719/1437249020.html">Vagrant</a></li>
      <li><a href="entry/20150721/1437404524.html">Chef(Rails環境構築)</a></li>
      <li><a href="entry/20150314/1426332751.html">Herokuの準備とデプロイ</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">リファレンス</span>
    <ul class="side-category-list">
      <li><a href="https://github.com/" target="_blank">GitHub</a></li>
      <li><a href="http://guides.rubyonrails.org/index.html" target="_blank">RailsGuides</a></li>
      <li><a href="http://railscasts.com/" target="_blank">RailsCast</a></li>
      <li><a href="https://rubygems.org/" target="_blank">RubyGems</a></li>
      <li><a href="https://www.ruby-toolbox.com/" target="_blank">RubyToolbox</a></li>
      <li><a href="http://rubular.com/" target="_blank">正規表現 Rubular</a></li>
      <li><a href="http://ruby-doc.org/core-2.1/" target="_blank">Ruby API (2.1)</a></li>
      <li><a href="http://api.rubyonrails.org/" target="_blank">Ruby on Rails API (4.1)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Phoenix</span>
    <ul class="side-category-list">
      <li><a href="entry/20151011/1444560106.html">Phoenix環境設定(Phoenix入門1)</a></li>
      <li><a href="entry/20151013/1444662887.html">基本的な認証機能(Phoenix入門2)</a></li>
      <li><a href="entry/20151016/1444930756.html">基本的なチャット機能(Phoenix入門3)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">その他</span>
    <ul class="side-category-list">
      <li><a href="entry/20150401/1427898898.html">広告収入向上</a></li>
      <li><a href="entry/20140830/1409361710.html">著者が読んだ本</a></li>
    </ul>
  </div>
</nav>

  </div>
</div>

      
      
    
      

<div class="hatena-module hatena-module-archive" data-archive-type="default" data-archive-url="http://ruby-rails.hatenadiary.com/archive">
  <div class="hatena-module-title">
    <a href="archive.html">月別アーカイブ</a>
  </div>
  <div class="hatena-module-body">
  </div>
</div>

      
      
    
    
  </div>
</aside>

  </div>
</div>




        
        
          <script type="text/javascript" src="http://b.hatena.ne.jp/js/hatena_dfp2.js"></script>
        
        
          <div id="bottom-editarea">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
$('.unsubscribing').on('click', function() {
    ga('send', 'event', 'button', 'click', 'hatenaReader');  
});
</script>
          </div>
        
      </div>
    </div>

    
      <footer id="footer" data-brand="hatenablog">
  <div id="footer-inner">
    <address>
      
      <a href="about.html"><img src="http://cdn1.www.st-hatena.com/users/ni/nipe880324/profile.gif" width="16" height="16" alt=""/>
        <span data-load-nickname="1" data-user-name="nipe880324">nipe880324</span>
      </a>
    </address>
    <p class="services">Powered by <a href="http://hatenablog.com/">Hatena Blog</a></p>
  </div>
</footer>

    

    
  <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>


    

    <script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js">
  {"parsetags": "explicit"}
</script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>



  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.min.js"></script>


<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery-ui.1.10.0.custom.min.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery.flot.0.8.3.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery.flot.time.0.8.3.js"></script>



<script id="hatenablog-js" data-env="production"
  type="text/javascript" src="https://blog.st-hatena.com/js/hatenablog.js?version=228df9a6e5a3ae04fdb53d33befa3556" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://blog.st-hatena.com/js/texts-ja.js?version=228df9a6e5a3ae04fdb53d33befa3556"></script>


  <script type="text/javascript">Hatena.Diary.GlobalHeader.init()</script>


<script src="https://www.google.com/recaptcha/api.js" async defer></script>




    


    
       

  <script id="hatena-counter-script" type="text/javascript"><!--
      hatena_counter_name = "nipe880324";
      hatena_counter_id = "102";
      hatena_counter_ref = document.referrer+"";
      hatena_counter_screen = screen.width + "x" + screen.height+","+screen.colorDepth;
  //--></script>
  <script type="text/javascript" src="http://counter.hatena.ne.jp/js/counter.js"></script>
  <noscript><img src="http://counter.hatena.ne.jp/nipe880324/102" border="0" alt="counter"></noscript>


    

  </body>
</html>
