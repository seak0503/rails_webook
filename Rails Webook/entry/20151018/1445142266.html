<!DOCTYPE html>
<html
  lang="ja"
data-avail-langs="ja en"

data-page="entry"
data-static-domain="https://blog.st-hatena.com"
data-blog="ruby-rails.hatenadiary.com"
data-blog-name="Rails Webook"
data-blogs-uri-base="http://ruby-rails.hatenadiary.com"
data-globalheader-color="b"
data-author="nipe880324"
data-version="228df9a6e5a3ae04fdb53d33befa3556"
data-blog-comments-top-is-new=""
data-plus-available=""



data-admin-domain="http://blog.hatena.ne.jp"

data-brand="hatenablog"

data-has-touch-view="1"


itemscope
itemtype="http://schema.org/Article"


  data-device="pc"
  data-globalheader-type="pc"
  >
  <head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    
    
    

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=7; IE=9; IE=10; IE=11" />
    <title>RailsでElasticsearch: 全文検索を実装 - Rails Webook</title>

    

    
      <link rel="canonical" href="1445142266.html"/>
    

    
    

<meta itemprop="name" content="RailsでElasticsearch: 全文検索を実装 - Rails Webook"/>

  <meta itemprop="image" content="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170217.png"/>


    <meta property="og:title" content="RailsでElasticsearch: 全文検索を実装 - Rails Webook"/>
<meta property="og:type" content="article"/>
<meta property="og:url" content="http://ruby-rails.hatenadiary.com/entry/20151018/1445142266"/>

  <meta property="og:image" content="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170217.png"/>

    <meta property="og:description" content="RailsでElasticsearchを使ってレストラン検索アプリを作成、店名、住所、カテゴリなどからレストランを全文検索できるようにします。また、フィルタ(filter)(filter)も使って検索条件を指定することで、閉店している店舗も含めて検索できるようにします。" />
<meta property="og:site_name" content="http://ruby-rails.hatenadiary.com/"/>

  <meta property="article:published_time" content="1445142266" />

    <meta property="article:tag" content="検索" />
    <meta property="article:tag" content="elasticsearch" />
        <meta name="twitter:card"  content="summary_large_image" />
    <meta name="twitter:image" content="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170217.png" />
  <meta name="twitter:title" content="RailsでElasticsearch: 全文検索を実装 - Rails Webook" />    <meta name="twitter:description" content="RailsでElasticsearchを使ってレストラン検索アプリを作成、店名、住所、カテゴリなどからレストランを全文検索できるようにします。また、フィルタ(filter)(filter)も使って検索条件を指定することで、閉店している店舗も含めて検索できるようにします。" />  <meta name="twitter:app:name:iphone" content="はてなブログアプリ" />
  <meta name="twitter:app:id:iphone" content="583299321" />
  <meta name="twitter:app:url:iphone" content="hatenablog:///open?uri=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20151018%2F1445142266" />  <meta name="twitter:site" content="@nipe032488" />
    
    <meta name="google-site-verification" content="OyOieuLgSrQckqbACTn_Q3G1dPq6LMlTqBRHa6V1XsA">    <meta name="keywords" content="Rails,Ruby on Rails,gem,Webアプリケーション,開発,構築,運用,インフラ">    <meta name="description" content="RailsでElasticsearchを使ってレストラン検索アプリを作成、店名、住所、カテゴリなどからレストランを全文検索できるようにします。また、フィルタ(filter)(filter)も使って検索条件を指定することで、閉店している店舗も含めて検索できるようにします。" />

    
<script type="text/javascript">
// <!--

if (~navigator.userAgent.indexOf('Mac OS X')) {
  document.write('<style type="text/css">html, body { font-family: \x27Helvetica\x27, \x27Arial\x27, \x27ヒラギノ角ゴ Pro W3\x27, \x27Hiragino Kaku Gothic Pro\x27, sans-serif; } </style>');
} else {
  document.write('<style type="text/css">html, body { font-family: \x27Helvetica\x27, \x27Arial\x27, \x27メイリオ\x27, \x27Meiryo\x27, \x27MS PGothic\x27, sans-serif; } </style>');
}

// -->
</script>

<!--[if lt IE 9]>
<script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->




    <link rel="shortcut icon" href="https://blog.st-hatena.com/images/favicon.ico">
<link rel="icon" sizes="192x192" href="https://blog.st-hatena.com/images/common/meta-icon-global.png">

    
<link rel="alternate" type="application/atom+xml" title="Atom" href="../../feed"/>
<link rel="alternate" type="application/rss+xml" title="RSS2.0" href="../../rss.rss"/>
<link rel="alternate" type="application/json+oembed" href="http://hatenablog.com/oembed?url=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20151018%2F1445142266&amp;format=json" title="oEmbed Profile of RailsでElasticsearch: 全文検索を実装"/>
<link rel="alternate" type="text/xml+oembed" href="http://hatenablog.com/oembed?url=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20151018%2F1445142266&amp;format=xml" title="oEmbed Profile of RailsでElasticsearch: 全文検索を実装"/>

      <link rel="author" href="http://www.hatena.ne.jp/nipe880324/">

    <link rel="stylesheet" type="text/css" href="https://blog.st-hatena.com/css/blog.css?version=228df9a6e5a3ae04fdb53d33befa3556"/>

    
  <link rel="stylesheet" type="text/css" href="http://blog.hatena.ne.jp/-/blog_style/12921228815727789780/a052dbbef76fd4380abc811c11814f2d9f990b9a"/>

    <script></script>

    
<style>div#google_afc_user,
  div#google_afc_user_container_0,
  div#google_afc_user_container_1,
  div#google_afc_user_container_2,
  div#google_afc_user_container_3,
  div#google_afc_user_container_4,
  div#google_afc_user_container_5,
  div.google_afc_image,
  div.google_afc_blocklink {
      display: block !important;
  }
</style>


    
  </head>

  <body class="page-entry enable-top-editarea enable-bottom-editarea category-検索 category-elasticsearch">
    <!-- Google Universal Analytics -->
<script id="google-analytics-script">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-29716941-6', 'auto', {'name': 'HatenaBlogTracker', 'sampleRate': 1});
  ga('HatenaBlogTracker.require', 'displayfeatures');
  ga('HatenaBlogTracker.send', 'pageview');
  ga('create', 'UA-29716941-26', 'auto', {'name': 'HatenaBlogSeparatedTracker', 'sampleRate': 10});
  ga('HatenaBlogSeparatedTracker.require', 'displayfeatures');
  ga('HatenaBlogSeparatedTracker.send', 'pageview');

    
      ga('create', 'UA-45988509-6', 'auto', {'name': 'HatenaBlogUserTracker'});
      ga('HatenaBlogUserTracker.require', 'displayfeatures');
      ga('HatenaBlogUserTracker.send', 'pageview');
    
  
  ga('create', 'UA-7855606-1', 'auto', {'name': 'HatenaGlobalTracker', 'sampleRate': 1});
  ga('HatenaGlobalTracker.require', 'displayfeatures');
  ga('HatenaGlobalTracker.send', 'pageview');
</script>
<!-- End Google Universal Analytics -->

    
    <div id="header-container">
     <div id="sp-suggest" style="display: none;"><a id="sp-suggest-link" href="1445142266.html#">スマートフォン用の表示で見る</a></div>
    </div>

    

<div class="quote-box">
  <div class="tooltip-quote tooltip-quote-star">
    <i class="blogicon-star" title="引用スターをつける"></i>
  </div>
  <div class="tooltip-quote tooltip-quote-stock">
    <i class="blogicon-quote" title="引用をストック"></i>
  </div>
</div>

<div class="message-box" id="quote-star-message-box" style="display: none; position: absolute;">
  スターをつけました
</div>

<div class="quote-stock-panel" id="quote-stock-message-box" style="position: absolute; z-index: 3000">
  <div class="message-box" id="quote-stock-succeeded-message" style="display: none">
    <p>引用をストックしました</p>
    <button class="btn btn-primary" id="quote-stock-show-editor-button" data-track-name="curation-quote-edit-button">ストック一覧を見る</button>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="message-box" id="quote-login-required-message" style="display: none">
    <p>引用するにはまずログインしてください</p>
    <button class="btn btn-primary" id="quote-login-button">ログイン</button>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="error-box" id="quote-stock-failed-message" style="display: none">
    <p>引用をストックできませんでした。再度お試しください</p>
    <button class="btn quote-stock-close-message-button">閉じる</button>
  </div>

  <div class="error-box" id="unstockable-quote-message-box" style="display: none; position: absolute; z-index: 3000;">
    <p>限定公開記事のため引用できません。</p>
  </div>
</div>

<script type="x-underscore-template" id="js-requote-button-template">
  <div class="requote-button js-requote-button">
    <button class="requote-button-btn tipsy-top" title="引用する"><i class="blogicon-quote"></i></button>
  </div>
</script>


    <div id="globalheader-container" >
  <iframe id="globalheader" height="37" frameborder="0" allowTransparency="true"></iframe>
</div>


    
    <div id="hidden-subscribe-button">
      <div class="hatena-follow-button-box btn-subscribe js-hatena-follow-button-box"
  
  >

  <a href="1445142266.html#" class="hatena-follow-button js-hatena-follow-button">
    <span class="subscribing">
      <span class="foreground">読者です</span>
      <span class="background">読者をやめる</span>
    </span>
    <span class="unsubscribing" data-track-name="profile-widget-subscribe-button" data-track-once>
      <span class="foreground">読者になる</span>
      <span class="background">読者になる</span>
    </span>
  </a>
  <div class="subscription-count-box js-subscription-count-box">
    <i></i>
    <u></u>
    <span class="subscription-count js-subscription-count">
    </span>
  </div>
</div>

    </div>

    <div id="container">
      <div id="container-inner">
        <header id="blog-title" data-brand="hatenablog">
  <div id="blog-title-inner" >
    <div id="blog-title-content">
      <h1 id="title"><a href="../../index.html">Rails Webook</a></h1>
      
        <h2 id="blog-description">自社のECを開発している会社で働いています。Rails情報やサービスを成長させる方法を書いていきます</h2>
      
    </div>
  </div>
</header>

        
          <div id="top-editarea">
            <!-- start Mixpanel --><script type="text/javascript">(function(e,b){if(!b.__SV){var a,f,i,g;window.mixpanel=b;b._i=[];b.init=function(a,e,d){function f(b,h){var a=h.split(".");2==a.length&&(b=b[a[0]],h=a[1]);b[h]=function(){b.push([h].concat(Array.prototype.slice.call(arguments,0)))}}var c=b;"undefined"!==typeof d?c=b[d]=[]:d="mixpanel";c.people=c.people||[];c.toString=function(b){var a="mixpanel";"mixpanel"!==d&&(a+="."+d);b||(a+=" (stub)");return a};c.people.toString=function(){return c.toString(1)+".people (stub)"};i="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
for(g=0;g<i.length;g++)f(c,i[g]);b._i.push([a,e,d])};b.__SV=1.2;a=e.createElement("script");a.type="text/javascript";a.async=!0;a.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";f=e.getElementsByTagName("script")[0];f.parentNode.insertBefore(a,f)}})(document,window.mixpanel||[]);
mixpanel.init("16db652100dca0a23c6a55a9205f0824");</script><!-- end Mixpanel -->
<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- rails top bar 728 x 90 -->
<ins class="adsbygoogle"
     style="display:inline-block;width:728px;height:90px"
     data-ad-client="ca-pub-2736751992834286"
     data-ad-slot="6687328050"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>

          </div>
        
        
        



<div id="content" class="hfeed"
  
  >
  <div id="content-inner">
    <div id="wrapper">
      <div id="main">
        <div id="main-inner">
          
            
            <!-- google_ad_section_start -->
            <!-- rakuten_ad_target_begin -->
            
              
                <article class="entry hentry js-entry-article date-first autopagerize_page_element chars-400 words-100 mode-hatena entry-odd" id="entry-6653458415124899634" data-keyword-campaign="" data-uuid="6653458415124899634">
  <div class="entry-inner">
    <header class="entry-header">
      <div class="entry-date date first">
        <a href="../../entries/2015/10/18.html" rel="nofollow">
          <time pubdate datetime="2015-10-18T04:24:26Z" title="2015-10-18T04:24:26Z">
            <span class="date-year">2015</span><span class="hyphen">-</span><span class="date-month">10</span><span class="hyphen">-</span><span class="date-day">18</span>
          </time>
        </a>
      </div>
      <h1 class="entry-title">
        <a href="1445142266.html" class="entry-title-link bookmark">RailsでElasticsearch: 全文検索を実装</a>
      </h1>
      
      
        <div class="entry-categories categories">
          
          <a href="../../archive/category/%E6%A4%9C%E7%B4%A2.html">検索</a>
          
          <a href="../../archive/category/elasticsearch.html">elasticsearch</a>
          
        </div>
      
      

      
    </header>
        
    <div class="entry-content">

      
        <p><span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170217.png" alt="f:id:nipe880324:20151017170217p:plain:w420" title="f:id:nipe880324:20151017170217p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span><br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>でElasticsearchを使ってレストラン検索アプリを作成、店名、住所、カテゴリなどからレストランを<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C1%B4%CA%B8%B8%A1%BA%F7">全文検索</a>できるようにします。また、フィルタ(filter)も使って検索条件を指定することで、閉店している店舗も含めて検索できるようにします。</p><p>今後、Elasticsearchのページネーション・ページあたりの表示件数、ソート、ファセット・post_filter、ハイライト、サジェスト機能などをより実践的な機能を実装していきます。<br />
<br />
</p>

<div class="section">
    <h3>目次</h3>
    
<ol>
<li><a href="1445142266.html#rails-elasticsearch-1-setup">ElasticsearchのMacへのインストール</a></li>
<li><a href="1445142266.html#rails-elasticsearch-1-rails-new">Railsプロジェクト作成とテストデータ作成</a></li>
<li><a href="1445142266.html#rails-elasticsearch-1-freetext-keyword">RailsとElasticsearchで全文検索を実装</a></li>
<li><a href="1445142266.html#rails-elasticsearch-1-filter">検索条件を指定する</a></li>
</ol>
</div>
<div class="section">
    <h3>動作確認</h3>
    
<ul>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac%20OS%20X">Mac OS X</a> 10.11 El Capitan</li>
<li>elasticsearch 1.7.2</li>
<li><a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a> 4.2.3</li>
<li>elasticsearch-<a class="keyword" href="http://d.hatena.ne.jp/keyword/dsl">dsl</a> 0.1.2</li>
<li>elasticsearch-model 0.1.8</li>
<li>elasticsearch-<a class="keyword" href="http://d.hatena.ne.jp/keyword/rails">rails</a> 0.1.8</li>
</ul><p><br />
<h3 id="rails-elasticsearch-1-setup">1. Elasticsearchの<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>へのインストール</h3>Homvebrewを使って<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>にElasticsearchインストールします。<br />
Elasticsearchを使うためには<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>が必要なので<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>もインストールします。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/Mac">Mac</a>以外で実行する場合は適宜<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>とElasticsearchをインストールしてください。</p><p><h4>Homebrewのインストール</h4>Homebrewが入っていない場合は、<a href="http://qiita.com/_daisuke/items/d3b2477d15ed2611a058" target="_blank">MacにHomebrewをインストールする</a>を参照してインストールしてください。</p><br />
<p><h4>JDK8のインストール</h4>Elasticsearchは<a class="keyword" href="http://d.hatena.ne.jp/keyword/Java">Java</a>を利用しているのでインストールします。</p>
<pre class="code" data-lang="" data-unlink>brew install caskroom/cask/brew-cask
brew tap caskroom/versions
brew cask install java
java -version #=&gt; 「java version &#34;1.8.0_60&#34;」のように表示される</pre><p><br />
<h4>Elasticsearchのインストール</h4></p>
<pre class="code" data-lang="" data-unlink>brew install elasticsearch
elasticsearch -v #=&gt; 「Version: 1.7.2, ...」と表示されること</pre><p><br />
<h4>Elasticsearch Pluginのインストール</h4>ElasticsearchはPluginをインストールすることで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B7%C1%C2%D6%C1%C7%B2%F2%C0%CF">形態素解析</a>や管理画面など拡張することができます。</p>
<pre class="code" data-lang="" data-unlink>which elasticsearch
/usr/local/bin/elasticsearch

# 日本語の形態素解析プラグイン kuromoji のインストール
# https://github.com/elastic/elasticsearch-analysis-kuromoji
/usr/local/bin/plugin install elasticsearch/elasticsearch-analysis-kuromoji/2.7.0

# Elasticsearchの管理プラグイン mervel のインストール
# https://www.elastic.co/guide/en/marvel/current/_installation.html
/usr/local/bin/plugin install elasticsearch/marvel/latest</pre><p><br />
<h4>Elasticsearchの起動</h4><code>elasticsearch</code>コマンドでElasticsearchを起動させます。</p>
<pre class="code" data-lang="" data-unlink># フォアグラウンドでElasticsearchが起動します
elasticsearch
# バックグラウンドでElasticsearchを起動させる
# elasticsearch -d</pre><p><br />
<h4>Elasticsearchの確認</h4><a href="http://localhost:9200/_plugin/marvel/" target="_blank">http://localhost:9200/_plugin/marvel/</a>にアクセスするとMarvel<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%D7%A5%E9%A5%B0%A5%A4%A5%F3">プラグイン</a>をいれたので、Elasticsearchの管理画面が見れます。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%AF%A5%E9%A5%B9%A5%BF">クラスタ</a>ー、インデックスやキャッシュのヒット、ドキュメント数などが見れます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170605.png" alt="f:id:nipe880324:20151017170605p:plain:w420" title="f:id:nipe880324:20151017170605p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><p>また、右上の「<a class="keyword" href="http://d.hatena.ne.jp/keyword/Dashboard">Dashboard</a> -> Sense」をクリックすると、次のようにクエリを実行できる画面を表示できます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170622.png" alt="f:id:nipe880324:20151017170622p:plain:w420" title="f:id:nipe880324:20151017170622p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><br />
<br />
<p><h3 id="rails-elasticsearch-1-rails-new">2. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>プロジェクト作成とテストデータ作成</h3><h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>プロジェクトの作成</h4><code>rails new</code>コマンドで<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>プロジェクトを作成します。</p>
<pre class="code" data-lang="" data-unlink>rails new elasticsearch_test</pre><p><br />
<h4>モデル作成</h4>次のようなシンプルなER図を作成します。</p>
<pre class="code" data-lang="" data-unlink>restaurants - (N-1) - categories (カテゴリ)
            - (N-1) - prefs (都道府県)</pre><p>モデルと<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>ファイルを作成します。</p>
<pre class="code" data-lang="" data-unlink>rails g model Restaurant name name_kana pref_id:integer zip address category_id:integer closed:boolean
rails g model Pref name
rails g model Category name name_kana</pre><p>アソシエーションを定義します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>
<span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  belongs_to <span class="synConstant">:category</span>
  belongs_to <span class="synConstant">:pref</span>
<span class="synPreProc">end</span>

<span class="synComment"># app/models/category.rb</span>
<span class="synPreProc">class</span> <span class="synType">Category</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  has_many <span class="synConstant">:restaurants</span>
<span class="synPreProc">end</span>

<span class="synComment"># app/models/pref.rb</span>
<span class="synPreProc">class</span> <span class="synType">Pref</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  has_many <span class="synConstant">:restaurants</span>
<span class="synPreProc">end</span>
</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%A4%A5%B0%A5%EC%A1%BC%A5%B7%A5%E7%A5%F3">マイグレーション</a>を実行します。</p>
<pre class="code" data-lang="" data-unlink>rake db:migrate</pre><p><br />
<h4>シードデータの作成</h4>検索のテスト用に少量のシードデータを作成しておきます。<br />
後ほど、大量のデータで行いますが、はじめのうちはElasticsearchのクエリ結果が正しいか確認しやすいように5件程度のデータで行います。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># db/seeds.rb</span>
<span class="synType">ActiveRecord</span>::<span class="synType">Base</span>.transaction <span class="synStatement">do</span>
  <span class="synComment"># すべてのレコードを削除する</span>
  [<span class="synType">Category</span>, <span class="synType">Pref</span>, <span class="synType">Restaurant</span>].each(&amp;<span class="synConstant">:delete_all</span>)

  <span class="synComment"># カテゴリの作成(3件)</span>
  teisyoku = <span class="synType">Category</span>.create!(<span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">定食</span><span class="synSpecial">'</span>,      <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">ていしょく</span><span class="synSpecial">'</span>)
  italian = <span class="synType">Category</span>.create!(<span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">イタリアン</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">いたりあん</span><span class="synSpecial">'</span>)
  izakaya = <span class="synType">Category</span>.create!(<span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">居酒屋</span><span class="synSpecial">'</span>,    <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">いざかや</span><span class="synSpecial">'</span>)

  <span class="synComment"># 都道府県の作成(2件)</span>
  tokyo = <span class="synType">Pref</span>.create!(<span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">東京都</span><span class="synSpecial">'</span>)
  kanagawa = <span class="synType">Pref</span>.create!(<span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">神奈川県</span><span class="synSpecial">'</span>)

  <span class="synComment"># レストラン作成(各カテゴリ, 都道府県の掛け算で6件)</span>
  <span class="synType">Restaurant</span>.create!([
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">松屋</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">まつや</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">240-0113</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">三浦郡葉山町堀内24-3</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: tokyo, <span class="synConstant">category</span>: teisyoku, <span class="synConstant">closed</span>: <span class="synConstant">false</span>
    },
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">ラ・マーレ・ド・茶屋</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">らまーれどちゃや</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">142-0111</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">港区六本木1-1-1</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: kanagawa, <span class="synConstant">category</span>: teisyoku, <span class="synConstant">closed</span>: <span class="synConstant">false</span>
    },
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">レストラン シェ・リュイ</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">しぇりゅい</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">150-0033</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">渋谷区猿楽町11-11</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: tokyo, <span class="synConstant">category</span>: italian, <span class="synConstant">closed</span>: <span class="synConstant">false</span>
    },
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">スパゲティ　ハシヤ</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">はしや</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">162-0023</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">三浦1-11</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: kanagawa, <span class="synConstant">category</span>: italian, <span class="synConstant">closed</span>: <span class="synConstant">true</span>
    },
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">牛角</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">ぎゅうかく</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">130-0033</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">池袋3-33</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: tokyo, <span class="synConstant">category</span>: izakaya, <span class="synConstant">closed</span>: <span class="synConstant">false</span>
    },
    {
      <span class="synConstant">name</span>: <span class="synSpecial">'</span><span class="synConstant">沖縄そば やんばる</span><span class="synSpecial">'</span>, <span class="synConstant">name_kana</span>: <span class="synSpecial">'</span><span class="synConstant">おきなわそばやんばる</span><span class="synSpecial">'</span>, <span class="synConstant">zip</span>: <span class="synSpecial">'</span><span class="synConstant">231-0011</span><span class="synSpecial">'</span>, <span class="synConstant">address</span>: <span class="synSpecial">'</span><span class="synConstant">西区横浜1-11</span><span class="synSpecial">'</span>,
      <span class="synConstant">pref</span>: kanagawa, <span class="synConstant">category</span>: izakaya, <span class="synConstant">closed</span>: <span class="synConstant">true</span>
    }
  ])
<span class="synStatement">end</span>
</pre><p>シードデータを投入します。</p>
<pre class="code" data-lang="" data-unlink>rake db:seed</pre><p><h4>検索画面を作成</h4>シンプルな検索画面を作成します。</p>
<pre class="code" data-lang="" data-unlink>rails g controller top index</pre><p>パスを修正します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/routes.rb</span>
<span class="synType">Rails</span>.application.routes.draw <span class="synStatement">do</span>
  root <span class="synSpecial">'</span><span class="synConstant">top#index</span><span class="synSpecial">'</span>
<span class="synStatement">end</span>
</pre><p>レストランをすべて表示するようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/controllers/top_controller.rb</span>
<span class="synPreProc">class</span> <span class="synType">TopController</span> &lt; <span class="synType">ApplicationController</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">index</span>
    <span class="synIdentifier">@restaurants</span> = <span class="synType">Restaurant</span>.all.includes(<span class="synConstant">:pref</span>, <span class="synConstant">:category</span>)
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>レイアウトファイルにBootstrapを読み込むようにしておきます。</p>
<pre class="code lang-html" data-lang="html" data-unlink><span class="synComment">&lt;!DOCTYPE html&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>ElasticsearchTest<span class="synIdentifier">&lt;/</span><span class="synStatement">title</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> stylesheet_link_tag</span><span class="synIdentifier">    </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synType">media</span><span class="synIdentifier">: </span><span class="synConstant">'all'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> javascript_include_tag</span><span class="synIdentifier"> </span><span class="synConstant">'application'</span><span class="synIdentifier">, </span><span class="synConstant">'data-turbolinks-track'</span><span class="synIdentifier"> =&gt;</span><span class="synPreProc"> true %&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;%=</span><span class="synConstant"> csrf_meta_tags</span><span class="synIdentifier"> %&gt;</span>
<span class="synPreProc">  </span><span class="synComment">&lt;!-- headにcssとscriptを追加 --&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;</span><span class="synStatement">link</span><span class="synIdentifier"> </span><span class="synType">rel</span><span class="synIdentifier">=</span><span class="synConstant">&quot;stylesheet&quot;</span><span class="synIdentifier"> </span><span class="synType">href</span><span class="synIdentifier">=</span><span class="synConstant">&quot;//netdna.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css&quot;</span><span class="synIdentifier">&gt;</span>
<span class="synPreProc">  </span><span class="synIdentifier">&lt;</span><span class="synStatement">script</span><span class="synIdentifier"> </span><span class="synType">src</span><span class="synIdentifier">=</span><span class="synConstant">&quot;//netdna.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js&quot;</span><span class="synIdentifier">&gt;&lt;/</span><span class="synStatement">script</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">head</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>

<span class="synComment">&lt;!-- headにcssとscriptを追加 --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;container&quot;</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;%=</span><span class="synConstant"> yield</span><span class="synIdentifier"> %&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;/</span><span class="synStatement">body</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">html</span><span class="synIdentifier">&gt;</span>
</pre><p>シンプルにすべてのレストランを表示するようにします。</p>
<pre class="code lang-html" data-lang="html" data-unlink><span class="synComment">&lt;!-- app/views/top/index.html.erb --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>レストラン検索<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>

<span class="synIdentifier">&lt;</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;% @restaurants.each do |r| %&gt;</span>
    <span class="synIdentifier">&lt;</span><span class="synStatement">li</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> r.name</span><span class="synIdentifier"> %&gt;</span>　（都道府県: <span class="synIdentifier">&lt;%=</span><span class="synConstant"> r.pref.name</span><span class="synIdentifier"> %&gt;</span>、カテゴリ: <span class="synIdentifier">&lt;%=</span><span class="synConstant"> r.category.name</span><span class="synIdentifier"> %&gt;</span>）<span class="synIdentifier">&lt;/</span><span class="synStatement">li</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;% end %&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">ul</span><span class="synIdentifier">&gt;</span>
</pre><p><br />
<h4>動作確認</h4><code>rails s</code>でサーバを起動し、<a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a>にアクセスすると次のように表示されると思います。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170800.png" alt="f:id:nipe880324:20151017170800p:plain:w420" title="f:id:nipe880324:20151017170800p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><br />
<br />
<p><h3 id="rails-elasticsearch-1-freetext-keyword">3. <a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>とElasticsearchで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%C1%B4%CA%B8%B8%A1%BA%F7">全文検索</a>を実装</h3>Elasticsearchのセットアップと<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>で検索できるようにしたのでElasticsearchの基礎をまじえながらRilsで使う方法を説明します。</p><br />
<p><h4>ElsticSearchの起動</h4>フロントエンドで起動しておきます。</p>
<pre class="code" data-lang="" data-unlink>elasticsearch</pre><p>また、<a href="http://localhost:9200/_plugin/marvel/" target="_blank">http://localhost:9200/_plugin/marvel/</a>にアクセスし、Marvel(管理画面)も開いておきます。</p><br />
<p><h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>でElasticsearchを使った検索の流れ</h4><a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>でElasticsearchを使ったときの検索の流れは次のようになります。</p>

<ol>
<li>[前準備] Elasticsearchにインデックス(RDSでいうとデータベース)を作成</li>
<li>[前準備] 作成したインデックスにドキュメントタイプ(RDSでいうとテーブル)を作成</li>
<li>[前準備] DBからデータを取得し、ドキュメント(RDSでいうレコード)を作成</li>
<li>検索画面を作成する（画面から検索ボタンを押すと、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>が検索パラメータを受け取る）</li>
<li>検索パラメータからElasticsearchのクエリを作成し、検索する</li>
<li>Elasticsearchのレスポンスを画面に表示する</li>
<li>定期的にドキュメントを追加/更新/削除する</li>
</ol><p>次からはこの流れにしたがって、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>とElasticsearchを使って「フリーキーワード検索」を実装していきます。</p><p><h4>Elasticsearchのgemをインストール</h4>まずは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>からElasticsearchを便利に使えるgemをインストールします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># Gemfile</span>

gem <span class="synSpecial">'</span><span class="synConstant">elasticsearch</span><span class="synSpecial">'</span>, <span class="synConstant">git</span>: <span class="synSpecial">'</span><span class="synConstant">git://github.com/elasticsearch/elasticsearch-ruby.git</span><span class="synSpecial">'</span>
gem <span class="synSpecial">'</span><span class="synConstant">elasticsearch-dsl</span><span class="synSpecial">'</span>, <span class="synConstant">git</span>: <span class="synSpecial">'</span><span class="synConstant">git://github.com/elasticsearch/elasticsearch-ruby.git</span><span class="synSpecial">'</span>
gem <span class="synSpecial">'</span><span class="synConstant">elasticsearch-model</span><span class="synSpecial">'</span>, <span class="synConstant">git</span>: <span class="synSpecial">'</span><span class="synConstant">git://github.com/elasticsearch/elasticsearch-rails.git</span><span class="synSpecial">'</span>
gem <span class="synSpecial">'</span><span class="synConstant">elasticsearch-rails</span><span class="synSpecial">'</span>, <span class="synConstant">git</span>: <span class="synSpecial">'</span><span class="synConstant">git://github.com/elasticsearch/elasticsearch-rails.git</span><span class="synSpecial">'</span>
</pre><p>gemをインストールします。</p>
<pre class="code" data-lang="" data-unlink>bundle</pre><p>それぞれのgemが提供する機能は次のとおりです。</p>

<ul>
<li><a href="https://github.com/elastic/elasticsearch-ruby" target="_blank">elasticsearch</a>: Elasticsearch用の<a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>クライアントと<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a>を提供</li>
<li><a href="https://github.com/elastic/elasticsearch-ruby/tree/master/elasticsearch-dsl" target="_blank">elasticsearch-dsl</a>: Elasticsearchのクエリを書きやすくするための<a class="keyword" href="http://d.hatena.ne.jp/keyword/DSL">DSL</a>(<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C9%A5%E1%A5%A4%A5%F3%C6%C3%B2%BD%B8%C0%B8%EC">ドメイン特化言語</a>)を提供</li>
<li><a href="https://github.com/elastic/elasticsearch-rails" target="_blank">elasticsearch-modelとelasticsearch-rails</a>: <a class="keyword" href="http://d.hatena.ne.jp/keyword/ActiveRecord">ActiveRecord</a>、ActiveModel、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>からElasticsearchを使えるようにする</li>
</ul><p><br />
<h4>[前準備] Elasticsearchにインデックス(RDSでいうとデータベース)を作成</h4>インデックスとはRDSでいうデータベースのようなものです。<br />
インデックスを作るには、<a class="keyword" href="http://d.hatena.ne.jp/keyword/ActiveRecord">ActiveRecord</a>に<code>Elasticsearch::Model</code>をインクルードし、Elasticsearchクライアントの<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を呼び出すことでインデックスを作成できます。</p><p>Restaurantに<code>Elasticsearch::Model</code>をインクルードします。<br />
そして、<code>index_name</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>にインデックス名を指定します。デフォルトはモデル名になりますが、環境ごとにインデックスを分けたほうが都合が良いので、<code>Rails.env</code>を追加します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>
<span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  belongs_to <span class="synConstant">:category</span>
  belongs_to <span class="synConstant">:pref</span>

  <span class="synPreProc">include</span> <span class="synType">Elasticsearch</span>::<span class="synType">Model</span>

  index_name <span class="synSpecial">&quot;</span><span class="synConstant">restaurant_</span><span class="synSpecial">#{</span><span class="synType">Rails</span>.env<span class="synSpecial">}&quot;</span> <span class="synComment"># インデックス名を指定(RDBでいうデータベース)</span>
<span class="synPreProc">end</span>
</pre><p>そして、下記コマンドを実行することで、インデックスの作成ができます。<br />
既にインデックスがある場合は削除もできます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># rails console</span>

<span class="synComment"># インデックスの作成。index:にはインデックス名、settingsにはインデックスの設定、mappingsにはマッピングの設定を記載</span>
<span class="synType">Restaurant</span>.__elasticsearch__.client.indices.create \
  <span class="synConstant">index</span>: <span class="synType">Restaurant</span>.index_name,
  <span class="synConstant">body</span>: { <span class="synConstant">settings</span>: <span class="synType">Restaurant</span>.settings.to_hash, <span class="synConstant">mappings</span>: <span class="synType">Restaurant</span>.mappings.to_hash }

<span class="synComment"># インデックスの削除</span>
<span class="synType">Restaurant</span>.__elasticsearch__.client.indices.delete <span class="synConstant">index</span>: <span class="synType">Restaurant</span>.index_name <span class="synStatement">rescue</span> <span class="synConstant">nil</span>
</pre><p>これらのコマンドは結構長いので、下記コマンドで強制的インデックスの削除/作成ができます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># rails console</span>
<span class="synType">Restaurant</span>.__elasticsearch__.create_index! <span class="synConstant">force</span>: <span class="synConstant">true</span>
<span class="synType">Restaurant</span>.__elasticsearch__.refresh_index!
</pre><p>これで、<code>restaurant_development</code>というインデックスを作成できました。</p><br />
<p><h4>[前準備] 作成したインデックスにドキュメントタイプ(RDSでいうとテーブル)を作成</h4>ドキュメントタイプはRDSでいうテーブルのようなもので、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>（RDSでいう<a class="keyword" href="http://d.hatena.ne.jp/keyword/DDL">DDL</a>）というもので作成します。</p><p>では、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>を定義し作成します。<br />
Elasticsearch:Modelの<code>settings</code>の<code>mappings</code>を定義することで<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>を定義します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>
<span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  ...

  index_name <span class="synSpecial">&quot;</span><span class="synConstant">restaurant_</span><span class="synSpecial">#{</span><span class="synType">Rails</span>.env<span class="synSpecial">}&quot;</span> <span class="synComment"># インデックス名を指定(RDBでいうデータベース)</span>
  <span class="synComment"># document_type # ドキュメントタイプを指定(RDBでいうテーブル)。デフォルトでクラス名</span>

  <span class="synComment"># インデックス設定とマッピング(RDBでいうスキーマ)を設定</span>
  settings <span class="synStatement">do</span>
    mappings <span class="synConstant">dynamic</span>: <span class="synSpecial">'</span><span class="synConstant">false</span><span class="synSpecial">'</span> <span class="synStatement">do</span> <span class="synComment"># デフォルトでマッピングが自動作成されるがそれを無効にする</span>
      <span class="synComment"># マッピングの公式ドキュメント</span>
      <span class="synComment"># https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-core-types.html</span>

      <span class="synComment"># indexesメソッドでインデックスする値を定義します。</span>
      <span class="synComment"># analyzer: インデクシング時、検索時に使用するアナライザーを指定します。指定しない場合、グローバルで設定されているアナライザーが利用されます。</span>
      <span class="synComment"># kuromojiは日本語のアナライザーです。</span>
      indexes <span class="synConstant">:name</span>,      <span class="synConstant">analyzer</span>: <span class="synSpecial">'</span><span class="synConstant">kuromoji</span><span class="synSpecial">'</span>
      indexes <span class="synConstant">:name_kana</span>, <span class="synConstant">analyzer</span>: <span class="synSpecial">'</span><span class="synConstant">kuromoji</span><span class="synSpecial">'</span>

      indexes <span class="synConstant">:zip</span>
      indexes <span class="synConstant">:address</span>, <span class="synConstant">analyzer</span>: <span class="synSpecial">'</span><span class="synConstant">kuromoji</span><span class="synSpecial">'</span>

      <span class="synComment"># type: booleanでclosedはboolean型として定義します</span>
      indexes <span class="synConstant">:closed</span>, <span class="synConstant">type</span>: <span class="synSpecial">'</span><span class="synConstant">boolean</span><span class="synSpecial">'</span>

      <span class="synComment"># date型として定義</span>
      <span class="synComment"># formatは日付のフォーマットを指定(2015-10-16T19:26:03.679Z)</span>
      <span class="synComment"># 詳細: https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html</span>
      indexes <span class="synConstant">:created_at</span>, <span class="synConstant">type</span>: <span class="synSpecial">'</span><span class="synConstant">date</span><span class="synSpecial">'</span>, <span class="synConstant">format</span>: <span class="synSpecial">'</span><span class="synConstant">date_time</span><span class="synSpecial">'</span>

      <span class="synComment"># 階層化してインデクシングできます。pref.nameとして検索できます。</span>
      indexes <span class="synConstant">:pref</span> <span class="synStatement">do</span>
        indexes <span class="synConstant">:name</span>, <span class="synConstant">analyzer</span>: <span class="synSpecial">'</span><span class="synConstant">keyword</span><span class="synSpecial">'</span>, <span class="synConstant">index</span>: <span class="synSpecial">'</span><span class="synConstant">not_analyzed</span><span class="synSpecial">'</span>
      <span class="synStatement">end</span>

      indexes <span class="synConstant">:category</span> <span class="synStatement">do</span>
        indexes <span class="synConstant">:name</span>, <span class="synConstant">analyzer</span>: <span class="synSpecial">'</span><span class="synConstant">keyword</span><span class="synSpecial">'</span>, <span class="synConstant">index</span>: <span class="synSpecial">'</span><span class="synConstant">not_analyzed</span><span class="synSpecial">'</span>
      <span class="synStatement">end</span>
    <span class="synStatement">end</span>
  <span class="synStatement">end</span>
<span class="synPreProc">end</span>
</pre><p>インデックスを作成し直します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># rails console</span>
<span class="synType">Restaurant</span>.__elasticsearch__.create_index! <span class="synConstant">force</span>: <span class="synConstant">true</span>
<span class="synType">Restaurant</span>.__elasticsearch__.refresh_index!
</pre><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/curl">curl</a>コマンドで定義した<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DE%A5%C3%A5%D4%A5%F3%A5%B0">マッピング</a>を確認できます。</p>
<pre class="code lang-javascript" data-lang="javascript" data-unlink>curl -XGET <span class="synConstant">'localhost:9200/restaurant_development/_mapping/restaurant?pretty=true'</span>
<span class="synIdentifier">{</span>
  <span class="synConstant">&quot;restaurant_development&quot;</span> : <span class="synIdentifier">{</span>
    <span class="synConstant">&quot;mappings&quot;</span> : <span class="synIdentifier">{</span>
      <span class="synConstant">&quot;restaurant&quot;</span> : <span class="synIdentifier">{</span>
        <span class="synConstant">&quot;dynamic&quot;</span> : <span class="synConstant">&quot;false&quot;</span>,
        <span class="synConstant">&quot;properties&quot;</span> : <span class="synIdentifier">{</span>
          <span class="synConstant">&quot;address&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>,
            <span class="synConstant">&quot;analyzer&quot;</span> : <span class="synConstant">&quot;kuromoji&quot;</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;category&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;properties&quot;</span> : <span class="synIdentifier">{</span>
              <span class="synConstant">&quot;name&quot;</span> : <span class="synIdentifier">{</span>
                <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>,
                <span class="synConstant">&quot;index&quot;</span> : <span class="synConstant">&quot;not_analyzed&quot;</span>,
                <span class="synConstant">&quot;analyzer&quot;</span> : <span class="synConstant">&quot;keyword&quot;</span>
              <span class="synIdentifier">}</span>
            <span class="synIdentifier">}</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;closed&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;boolean&quot;</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;created_at&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;date&quot;</span>,
            <span class="synConstant">&quot;format&quot;</span> : <span class="synConstant">&quot;date_time&quot;</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;name&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>,
            <span class="synConstant">&quot;analyzer&quot;</span> : <span class="synConstant">&quot;kuromoji&quot;</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;name_kana&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>,
            <span class="synConstant">&quot;analyzer&quot;</span> : <span class="synConstant">&quot;kuromoji&quot;</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;pref&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;properties&quot;</span> : <span class="synIdentifier">{</span>
              <span class="synConstant">&quot;name&quot;</span> : <span class="synIdentifier">{</span>
                <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>,
                <span class="synConstant">&quot;index&quot;</span> : <span class="synConstant">&quot;not_analyzed&quot;</span>,
                <span class="synConstant">&quot;analyzer&quot;</span> : <span class="synConstant">&quot;keyword&quot;</span>
              <span class="synIdentifier">}</span>
            <span class="synIdentifier">}</span>
          <span class="synIdentifier">}</span>,
          <span class="synConstant">&quot;zip&quot;</span> : <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;type&quot;</span> : <span class="synConstant">&quot;string&quot;</span>
          <span class="synIdentifier">}</span>
        <span class="synIdentifier">}</span>
      <span class="synIdentifier">}</span>
    <span class="synIdentifier">}</span>
  <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>
</pre><p><br />
<h4>[前準備] DBからデータを取得し、ドキュメントタイプにドキュメント(RDSでいうレコード)を作成</h4>ドキュメントをインポートするときに呼ばれる<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>の<code>as_indexed_json</code>を定義します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>
<span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  ...

  <span class="synComment"># インデクシング時に呼び出されるメソッド</span>
  <span class="synComment"># マッピングのデータを返すようにする</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">as_indexed_json</span>(options = {})
    attributes
      .symbolize_keys
      .slice(<span class="synConstant">:name</span>, <span class="synConstant">:name_kana</span>, <span class="synConstant">:zip</span>, <span class="synConstant">:address</span>, <span class="synConstant">:closed</span>, <span class="synConstant">:created_at</span>)
      .merge(<span class="synConstant">pref</span>: { <span class="synConstant">name</span>: pref.name })
      .merge(<span class="synConstant">category</span>: { <span class="synConstant">name</span>: category.name })
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>

<span class="synComment"># 次のような出力になります</span>
<span class="synType">Restaurant</span>.first.as_indexed_json
<span class="synComment"># =&gt; {:name=&gt;&quot;松屋&quot;, :name_kana=&gt;&quot;まつや&quot;, :zip=&gt;&quot;240-0113&quot;, :address=&gt;&quot;三浦郡葉山町堀内24-3&quot;, :closed=&gt;false, :created_at=&gt;Fri, 16 Oct 2015 19:26:03 UTC +00:00, :pref=&gt;{:name=&gt;&quot;東京都&quot;}, :category=&gt;{:name=&gt;&quot;定食&quot;}}</span>
</pre><p>そして、<code>import</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>でインデクシングを行います。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synType">Restaurant</span>.import
<span class="synComment">#=&gt; 0</span>
</pre><p>これで、インデクシングされたので、<a href="http://localhost:9200/_plugin/marvel/" target="_blank">Marvel</a>のINDICESの<code>restaurant_development</code>のDocuments数が「6」になっています。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170915.png" alt="f:id:nipe880324:20151017170915p:plain:w420" title="f:id:nipe880324:20151017170915p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><p><a href="http://localhost:9200/_plugin/marvel/sense/index.html" target="_blank">Marvel Sense</a>からクエリを実行すると、次のように結果が返ってきます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170931.png" alt="f:id:nipe880324:20151017170931p:plain:w420" title="f:id:nipe880324:20151017170931p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><br />
<p><h4>検索フォームを作成する</h4>フリーキーワードを入力できる検索フォームを作成します。<br />
検索/検索結果表示画面(<code>index.html.erb</code>)にフォームを追加します。<br />
検索結果の表示も変えています。</p>
<pre class="code lang-html" data-lang="html" data-unlink><span class="synComment">&lt;!-- app/views/top/index.html.erb --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>レストラン検索<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>

<span class="synComment">&lt;!-- 検索フォーム --&gt;</span>
<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_tag</span><span class="synIdentifier"> root_path, </span><span class="synType">method</span><span class="synIdentifier">: :get, enforce_utf8: false do %&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;form-group&quot;</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;%=</span><span class="synConstant"> search_field_tag</span><span class="synIdentifier"> :q, params[:q], </span><span class="synType">class</span><span class="synIdentifier">: </span><span class="synConstant">'form-control'</span><span class="synIdentifier">, placeholder: </span><span class="synConstant">'店名、場所、カテゴリ'</span><span class="synIdentifier"> %&gt;</span>
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">button</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">&quot;submit&quot;</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;btn btn-default&quot;</span><span class="synIdentifier">&gt;</span>検索<span class="synIdentifier">&lt;/</span><span class="synStatement">button</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>

<span class="synIdentifier">&lt;</span><span class="synStatement">br</span><span class="synIdentifier">&gt;</span>

<span class="synComment">&lt;!-- 検索結果の表示 --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;col-xs-9&quot;</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;results&quot;</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;% @restaurants.each do |r| %&gt;</span>
      <span class="synIdentifier">&lt;</span><span class="synStatement">hr</span><span class="synIdentifier"> /&gt;</span>
      <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;result&quot;</span><span class="synIdentifier">&gt;</span>
        <span class="synIdentifier">&lt;</span><span class="synStatement">h4</span><span class="synIdentifier">&gt;&lt;%=</span><span class="synConstant"> r.name</span><span class="synIdentifier"> %&gt;</span>（<span class="synIdentifier">&lt;%=</span><span class="synConstant"> r.name_kana</span><span class="synIdentifier"> %&gt;</span>）<span class="synIdentifier">&lt;/</span><span class="synStatement">h4</span><span class="synIdentifier">&gt;</span>
        <span class="synIdentifier">&lt;</span><span class="synStatement">p</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;text-muted&quot;</span><span class="synIdentifier">&gt;</span>
          <span class="synIdentifier">&lt;</span><span class="synStatement">small</span><span class="synIdentifier">&gt;</span>都道府県: <span class="synIdentifier">&lt;%=</span><span class="synConstant"> r.pref.name</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">small</span><span class="synIdentifier">&gt;</span>
          <span class="synIdentifier">&lt;</span><span class="synStatement">small</span><span class="synIdentifier">&gt;</span>カテゴリ: <span class="synIdentifier">&lt;%=</span><span class="synConstant"> r.category.name</span><span class="synIdentifier"> %&gt;&lt;/</span><span class="synStatement">small</span><span class="synIdentifier">&gt;</span>
        <span class="synIdentifier">&lt;/</span><span class="synStatement">p</span><span class="synIdentifier">&gt;</span>
      <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;% end %&gt;</span>
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
</pre><p>画面を表示すると次のようになります。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017170957.png" alt="f:id:nipe880324:20151017170957p:plain:w420" title="f:id:nipe880324:20151017170957p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><br />
<p><h4>検索パラメータからElasticsearchのクエリを作成し、検索する</h4>まずは、Elasticsearchのクエリを作成し、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>からElasticsearchにどのようなクエリを投げればよいか確認します。<br />
<a href="http://localhost:9200/_plugin/marvel/sense/index.html" target="_target">Marvel Sense</a>を開き、クエリを試します。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のフィールドからクエリ文字列にマッチするドキュメントを取得するには<code>multi_match</code>を使用します。<br />
参考: <a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.7/query-dsl-multi-match-query.html" target="_blank">Multi Matchクエリ</a></p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/Ruby">Ruby</a>から次のクエリを作成するようにします。<br />
<code>query</code>にはユーザが入力した検索キーワード、<code>fields</code>には検索を行うフィールド名を指定します。<br />
下記の例では、<code>name</code>、<code>name_kana</code>、<code>address</code>、<code>pref.name</code>、<code>category.name</code>に「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B5%ED%B3%D1">牛角</a>」という文字列が入っているドキュメントを取得します。<br />
※<code>pref.name</code>と<code>category.name</code>は"keyword"アナライザーを使用しているので全文マッチしないとヒットしません。例：「東京」ではヒットせず、「東京都」でヒットする。ここらへんの検索のチューニングは専門的なので省きます。</p>
<pre class="code lang-javascript" data-lang="javascript" data-unlink>GET restaurant_development/_search
<span class="synIdentifier">{</span>
  <span class="synConstant">&quot;query&quot;</span>: <span class="synIdentifier">{</span>
    <span class="synConstant">&quot;multi_match&quot;</span>: <span class="synIdentifier">{</span>
      <span class="synConstant">&quot;query&quot;</span>:    <span class="synConstant">&quot;牛角&quot;</span>,
      <span class="synConstant">&quot;fields&quot;</span>: <span class="synIdentifier">[</span><span class="synConstant">&quot;name&quot;</span>, <span class="synConstant">&quot;name_kana&quot;</span>, <span class="synConstant">&quot;address&quot;</span>, <span class="synConstant">&quot;pref.name&quot;</span>, <span class="synConstant">&quot;category.name&quot;</span><span class="synIdentifier">]</span>
    <span class="synIdentifier">}</span>
  <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>

<span class="synComment">// 結果</span>
<span class="synIdentifier">{</span>
   <span class="synConstant">&quot;took&quot;</span>: 3,
   <span class="synConstant">&quot;timed_out&quot;</span>: <span class="synConstant">false</span>,
   <span class="synConstant">&quot;_shards&quot;</span>: <span class="synIdentifier">{</span>
      <span class="synConstant">&quot;total&quot;</span>: 5,
      <span class="synConstant">&quot;successful&quot;</span>: 5,
      <span class="synConstant">&quot;failed&quot;</span>: 0
   <span class="synIdentifier">}</span>,
   <span class="synConstant">&quot;hits&quot;</span>: <span class="synIdentifier">{</span>
      <span class="synConstant">&quot;total&quot;</span>: 1, <span class="synComment">// ヒットしたドキュメント数</span>
      <span class="synConstant">&quot;max_score&quot;</span>: 0.08322528, <span class="synComment">// 最大の関連度</span>
      <span class="synConstant">&quot;hits&quot;</span>: <span class="synIdentifier">[</span>
         <span class="synIdentifier">{</span>
            <span class="synConstant">&quot;_index&quot;</span>: <span class="synConstant">&quot;restaurant_development&quot;</span>, <span class="synComment">// インデックス</span>
            <span class="synConstant">&quot;_type&quot;</span>: <span class="synConstant">&quot;restaurant&quot;</span>,  <span class="synComment">// ドキュメントタイプ</span>
            <span class="synConstant">&quot;_id&quot;</span>: <span class="synConstant">&quot;5&quot;</span>,
            <span class="synConstant">&quot;_score&quot;</span>: 0.08322528, <span class="synComment">// 関連度</span>
            <span class="synConstant">&quot;_source&quot;</span>: <span class="synIdentifier">{</span>  <span class="synComment">// データ</span>
               <span class="synConstant">&quot;name&quot;</span>: <span class="synConstant">&quot;牛角&quot;</span>,
               <span class="synConstant">&quot;name_kana&quot;</span>: <span class="synConstant">&quot;ぎゅうかく&quot;</span>,
               <span class="synConstant">&quot;zip&quot;</span>: <span class="synConstant">&quot;130-0033&quot;</span>,
               <span class="synConstant">&quot;address&quot;</span>: <span class="synConstant">&quot;池袋3-33&quot;</span>,
               <span class="synConstant">&quot;closed&quot;</span>: <span class="synConstant">false</span>,
               <span class="synConstant">&quot;created_at&quot;</span>: <span class="synConstant">&quot;2015-10-16T19:26:03.683Z&quot;</span>,
               <span class="synConstant">&quot;pref&quot;</span>: <span class="synIdentifier">{</span>
                  <span class="synConstant">&quot;name&quot;</span>: <span class="synConstant">&quot;東京都&quot;</span>
               <span class="synIdentifier">}</span>,
               <span class="synConstant">&quot;category&quot;</span>: <span class="synIdentifier">{</span>
                  <span class="synConstant">&quot;name&quot;</span>: <span class="synConstant">&quot;居酒屋&quot;</span>
               <span class="synIdentifier">}</span>
            <span class="synIdentifier">}</span>
         <span class="synIdentifier">}</span>
      <span class="synIdentifier">]</span>
   <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>
</pre><p>上記のクエリを作成するには、ユーザの検索キーワードが必要になります。<br />
そのため、コントローラーで検索フォームの<code>q</code>パラメータを<code>search</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>に渡すようにします。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/controller/top_controller.rb</span>
<span class="synPreProc">class</span> <span class="synType">TopController</span> &lt; <span class="synType">ApplicationController</span>
  <span class="synPreProc">def</span> <span class="synIdentifier">index</span>
    <span class="synIdentifier">@restaurants</span> = <span class="synType">Restaurant</span>.search(params)
  <span class="synPreProc">end</span>
<span class="synPreProc">end</span>
</pre><p>そして、Restaurantモデルに<code>search</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>を定義します。<br />
<code>search</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>は、Elasticsearchのクエリを作成し、検索を実施、Elasticsearchからのレスポンスを返します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>
<span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  ...

  <span class="synComment"># Elasticsearchのクエリを作成し、検索を実施する</span>
  <span class="synComment"># Elasticsearchからのレスポンスを返す</span>
  <span class="synPreProc">def</span> <span class="synConstant">self</span>.<span class="synIdentifier">search</span>(params = {})
    <span class="synComment"># 検索パラメータを取得</span>
    keyword = params[<span class="synConstant">:q</span>]

    <span class="synComment"># 検索クエリを作成（Elasticsearch::DSLを利用）</span>
    <span class="synComment"># 参考: https://github.com/elastic/elasticsearch-ruby/tree/master/elasticsearch-dsl</span>
    <span class="synComment">#</span>
    <span class="synComment"># 検索キーワードが入力されたときは、下記クエリを作成</span>
    <span class="synComment"># &quot;query&quot;: {</span>
    <span class="synComment">#   &quot;multi_match&quot;: {</span>
    <span class="synComment">#     &quot;query&quot;:    &quot;牛角&quot;, // 検索キーワード</span>
    <span class="synComment">#     &quot;fields&quot;: [&quot;name&quot;, &quot;name_kana&quot;, &quot;address&quot;, &quot;pref.name&quot;, &quot;category.name&quot;]</span>
    <span class="synComment">#   }</span>
    <span class="synComment"># }</span>
    <span class="synComment">#</span>
    <span class="synComment"># 検索キーワードが入力されてない時は、下記クエリを作成（すべてのドキュメントを取得）</span>
    <span class="synComment"># &quot;query&quot;: {</span>
    <span class="synComment">#   &quot;match_all&quot;: {}</span>
    <span class="synComment"># }</span>
    search_definition = <span class="synType">Elasticsearch</span>::<span class="synType">DSL</span>::<span class="synType">Search</span>.search {
      query {
        <span class="synStatement">if</span> keyword.present?
          multi_match {
            query keyword
            fields <span class="synSpecial">%w{</span><span class="synConstant"> name name_kana address pref.name category.name </span><span class="synSpecial">}</span>
          }
        <span class="synStatement">else</span>
          match_all
        <span class="synStatement">end</span>
      }
    }

    <span class="synComment"># 検索クエリをなげて結果を表示</span>
    <span class="synComment"># __elasticsearch__にElasticsearchを操作するたくさんのメソッドが定義されている</span>
    __elasticsearch__.search(search_definition)
  <span class="synPreProc">end</span>

  ...
<span class="synPreProc">end</span>
</pre><p>最後に<cocd>application.rb</code>に<code>require 'elasticsearch/rails/instrumentation'</code>を追加します。<br />
こうすることで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>ログにElasticsearchの実行時間やは発行したクエリが表示されるようになります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># config/application.rb</span>

<span class="synComment"># Require the gems listed in Gemfile, including any gems</span>
<span class="synComment"># you've limited to :test, :development, or :production.</span>
<span class="synType">Bundler</span>.require(*<span class="synType">Rails</span>.groups)
<span class="synPreProc">require</span> <span class="synSpecial">'</span><span class="synConstant">elasticsearch/rails/instrumentation</span><span class="synSpecial">'</span>
</pre><p><br />
これで画面から「<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B5%ED%B3%D1">牛角</a>」と検索すると<a class="keyword" href="http://d.hatena.ne.jp/keyword/%B5%ED%B3%D1">牛角</a>が表示されます。「東京都」と検索すると東京都の店が表示されます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151017/20151017171045.png" alt="f:id:nipe880324:20151017171045p:plain:w420" title="f:id:nipe880324:20151017171045p:plain:w420" class="hatena-fotolife" style="width:420px" itemprop="image"></span></p><br />
<p>このとき<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>ログで注目してもらいたいのが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/SQL">SQL</a>の実行がないこと(AcriveRecord: 0.0ms)です。代わりに、Elasticsearchへの実行時間が記載されています。さらに、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C7%A5%D0%A5%C3%A5%B0">デバッグ</a>用でElasticsearchに送られたクエリも表示されています。</p>
<pre class="code" data-lang="" data-unlink>Started GET &#34;/?q=%E6%9D%B1%E4%BA%AC%E9%83%BD&#34; for ::1 at 2015-10-17 16:05:19 +0900
Processing by TopController#index as HTML
  Parameters: {&#34;q&#34;=&gt;&#34;東京都&#34;}
  Restaurant Search (9.1ms) {index: &#34;restaurant_development&#34;, type: &#34;restaurant&#34;, body: {query: {multi_match: {query: &#34;東京都&#34;, fields: [&#34;name&#34;, &#34;name_kana&#34;, &#34;address&#34;, &#34;pref.name&#34;, &#34;category.name&#34;]}}}}
  Rendered top/index.html.erb within layouts/application (10.2ms)
Completed 200 OK in 44ms (Views: 34.0ms | ActiveRecord: 0.0ms | Elasticsearch: 9.1ms)</pre><p><br />
<h4>Elasticsearchのレスポンスを画面に表示する</h4>既に画面に表示されてレストランの表示がされてしまっていますが、<code>__elasticsearch__.search</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>の帰り値について説明することでうまく表示されている理由を説明します。</p><p>Elasticsearchはヒットするドキュメントを<a class="keyword" href="http://d.hatena.ne.jp/keyword/JSON">JSON</a>形式で返します。Elasticsearch::Modelによりそれをインスタン化して扱いやすいものにしています。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink>response = __elasticsearch__.search(search_definition)

<span class="synComment"># レスポンスのクラス名はElasticsearch::Model::Response::Response</span>
response.class <span class="synComment">#=&gt; Elasticsearch::Model::Response::Response</span>

<span class="synComment"># ヒットしたドキュメント数を取得</span>
response.results.total <span class="synComment">#=&gt; 3</span>

<span class="synComment"># ヒットしたドキュメントの最初のドキュメントを取得</span>
response.results.first
<span class="synComment"># =&gt; #&lt;Elasticsearch::Model::Response::Result:0x007fc0c6dc28a8</span>
<span class="synComment">#  @result=</span>
<span class="synComment">#   {&quot;_index&quot;=&gt;&quot;restaurant_development&quot;,</span>
<span class="synComment">#    &quot;_type&quot;=&gt;&quot;restaurant&quot;,</span>
<span class="synComment">#    &quot;_id&quot;=&gt;&quot;1&quot;,</span>
<span class="synComment">#    &quot;_score&quot;=&gt;0.41762865,</span>
<span class="synComment">#    &quot;_source&quot;=&gt;</span>
<span class="synComment">#     {&quot;name&quot;=&gt;&quot;松屋&quot;,</span>
<span class="synComment">#      &quot;name_kana&quot;=&gt;&quot;まつや&quot;,</span>
<span class="synComment">#      &quot;zip&quot;=&gt;&quot;240-0113&quot;,</span>
<span class="synComment">#      &quot;address&quot;=&gt;&quot;三浦郡葉山町堀内24-3&quot;,</span>
<span class="synComment">#      &quot;closed&quot;=&gt;false,</span>
<span class="synComment">#      &quot;created_at&quot;=&gt;&quot;2015-10-16T19:26:03.679Z&quot;,</span>
<span class="synComment">#      &quot;pref&quot;=&gt;{&quot;name&quot;=&gt;&quot;東京都&quot;},</span>
<span class="synComment">#      &quot;category&quot;=&gt;{&quot;name&quot;=&gt;&quot;定食&quot;}}}&gt;</span>

<span class="synComment"># response.first でも同じ結果が返ってきます</span>
<span class="synComment"># これは、responseオブジェクトがEnumerableモジュールのメソッドをresultsにデリゲートしているためです。</span>
result = response.first

<span class="synComment"># 関連度を取得</span>
result._score <span class="synComment">#=&gt; 0.41762865</span>

<span class="synComment"># ドキュメント(_source)の内容を取得</span>
result._source.name <span class="synComment">#=&gt; &quot;松屋&quot;</span>
<span class="synComment"># _sourceを省略できる</span>
result.name <span class="synComment">#=&gt; &quot;松屋&quot;</span>

<span class="synComment"># 入れ子になっている値は.(ドット)でアクセスできる</span>
result.pref <span class="synComment">#=&gt; {&quot;name&quot;=&gt;&quot;東京都&quot;}</span>
result.pref.name <span class="synComment">#=&gt; &quot;東京都&quot;</span>

<span class="synComment"># データベースからヒットしたドキュメントのActiveRecordのインスタンスの配列を取得</span>
response.records.to_a
<span class="synComment">#=&gt; [#&lt;Restaurant:xxxx&gt;, #&lt;Restaurant:yyyy&gt;, ...]</span>
</pre><p>このようにレスポンスが<a class="keyword" href="http://d.hatena.ne.jp/keyword/ActiveRecord">ActiveRecord</a>と同じように扱えるため、<code>each</code>や<code>pref.name</code>などと記載したままでも問題なく表示されていたということです。<br />
せっかくなので、ヒットしたドキュメント数を表示するように追加しています。</p>
<pre class="code lang-html" data-lang="html" data-unlink># app/views/top/index.html.erb
...

<span class="synComment">&lt;!-- 検索結果の表示 --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;col-xs-9&quot;</span><span class="synIdentifier">&gt;</span>
  <span class="synComment">&lt;!-- 検索結果の数を表示する --&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>検索結果: 約<span class="synIdentifier">&lt;%=</span><span class="synConstant"> @restaurants.results.total</span><span class="synIdentifier"> %&gt;</span>件<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>

  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">id</span><span class="synIdentifier">=</span><span class="synConstant">&quot;results&quot;</span><span class="synIdentifier">&gt;</span>
    ...
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
</pre><p><br />
<h4>ドキュメントも追加/更新/削除する</h4>これで、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>とElasticsearchを使って、検索キーワードで検索をできるようにできました。<br />
最後に、ドキュメントの取得元のDBのレコードの追加/更新/削除があった場合、ドキュメントも追加/更新/削除するようにします。<br />
そうしないと、レコードが更新されたのに、検索結果の内容が正しくないものになってしまいます。</p><p>DBを更新しても、Elasticsearchのドキュメントを更新しないと以下のようになってしまいます。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># DBの変更前にクエリを実行</span>
response = <span class="synType">Restaurant</span>.search(<span class="synConstant">q</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
response.first.address <span class="synComment">#=&gt; &quot;池袋3-33&quot;</span>

<span class="synComment"># DBを更新</span>
record = <span class="synType">Restaurant</span>.find_by(<span class="synConstant">name</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
record.update(<span class="synConstant">address</span>: <span class="synSpecial">&quot;</span><span class="synConstant">池袋9-99</span><span class="synSpecial">&quot;</span>) <span class="synComment">#=&gt; true</span>

<span class="synComment"># DBの更新後にクエリ実行。住所が変わっていない</span>
response = <span class="synType">Restaurant</span>.search(<span class="synConstant">q</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
response.first.address <span class="synComment">#=&gt; &quot;池袋3-33&quot;</span>
</pre><p>一番シンプルな方法は、<code>Elasticsearch::Model::Callbacks</code>をインクルードします。<br />
これをインクルードすることで、<code>after_commit</code>後にドキュメントを作成/更新/削除する処理が走るようになります。（<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%BD%A1%BC%A5%B9%A5%B3%A1%BC%A5%C9">ソースコード</a>: <a href="https://github.com/elastic/elasticsearch-rails/blob/master/elasticsearch-model/lib/elasticsearch/model/adapters/active_record.rb#L65" target="_blank">コールバックの実装</a>）</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synPreProc">class</span> <span class="synType">Restaurant</span> &lt; <span class="synType">ActiveRecord</span>::<span class="synType">Base</span>
  ...

  <span class="synPreProc">include</span> <span class="synType">Elasticsearch</span>::<span class="synType">Model</span>
  <span class="synPreProc">include</span> <span class="synType">Elasticsearch</span>::<span class="synType">Model</span>::<span class="synType">Callbacks</span>

  ...
</pre><p>DBを更新するとドキュメントも更新されるようになります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># DBの変更前にクエリを実行</span>
response = <span class="synType">Restaurant</span>.search(<span class="synConstant">q</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
response.first.address <span class="synComment">#=&gt; &quot;池袋3-33&quot;</span>

<span class="synComment"># DBを更新。コールバックでドキュメントも更新される</span>
record = <span class="synType">Restaurant</span>.find_by(<span class="synConstant">name</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
record.update(<span class="synConstant">address</span>: <span class="synSpecial">&quot;</span><span class="synConstant">池袋5-55</span><span class="synSpecial">&quot;</span>) <span class="synComment">#=&gt; true</span>

<span class="synComment"># DBの更新後にクエリ実行。住所が変わっている</span>
response = <span class="synType">Restaurant</span>.search(<span class="synConstant">q</span>: <span class="synSpecial">&quot;</span><span class="synConstant">牛角</span><span class="synSpecial">&quot;</span>)
response.first.address <span class="synComment">#=&gt; &quot;池袋5-55&quot;</span>
</pre><p>これはシンプルなのですが、大量にレコード追加/更新/削除があると、Elasticsearchのドキュメントの追加/更新/削除が溜まっていき、溜まっている場合、それが<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%DC%A5%C8%A5%EB%A5%CD%A5%C3%A5%AF">ボトルネック</a>となり、パフォーマンスが悪くなってしまいます。<br />
そのため、一般的には、非同期で行うのが普通です。非同期で行うので検索結果の内容がDBの内容と少しの時間ずれが発生します。<br />
非同期でドキュメントを更新する方法は次のとおりです。<br />
<a href="https://github.com/elastic/elasticsearch-rails/tree/master/elasticsearch-model#asynchronous-callbacks" target="_blank">elasticsearch-model - 非同期コールバック</a>を参照ください。</p><br />
<br />
<br />
<p><h3 id="rails-elasticsearch-1-filter">4. 検索条件を指定する</h3>Restaurantモデルの<code>closed</code>は、レストランが閉店したかどうかをboolean値で保持しています。<br />
次のような<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>を表示し、デフォルトでは、閉店したレストランを除外して検索できるようにします。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151018/20151018035057.png" alt="f:id:nipe880324:20151018035057p:plain:w320" title="f:id:nipe880324:20151018035057p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>をクリックすることで、閉店したレストランも含めて検索できるようにします。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151018/20151018035115.png" alt="f:id:nipe880324:20151018035115p:plain:w320" title="f:id:nipe880324:20151018035115p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><br />
<p><h4>検索条件を指定するfilterクエリ</h4><a href="http://localhost:9200/_plugin/marvel/sense/index.html" target="_blank">Marvel Sense</a>を開きます。</p><p>下記のように、<code>filtered</code>を指定し、<code>filter</code>内でフィルタを指定します。<br />
<code>term</code>は、termフィルタで、「"closed"フィールドがfalseのものを取得する」という検索条件になります。</p>
<pre class="code lang-javascript" data-lang="javascript" data-unlink>GET restaurant_development/_search
<span class="synIdentifier">{</span>
  <span class="synConstant">&quot;query&quot;</span>: <span class="synIdentifier">{</span>
    <span class="synConstant">&quot;filtered&quot;</span>: <span class="synIdentifier">{</span>
      <span class="synConstant">&quot;query&quot;</span>: <span class="synIdentifier">{</span>
        <span class="synConstant">&quot;match_all&quot;</span>: <span class="synIdentifier">{}</span>
      <span class="synIdentifier">}</span>,
      <span class="synConstant">&quot;filter&quot;</span>: <span class="synIdentifier">{</span>
        <span class="synConstant">&quot;term&quot;</span>: <span class="synIdentifier">{</span> <span class="synConstant">&quot;closed&quot;</span>: <span class="synConstant">false</span> <span class="synIdentifier">}</span>
      <span class="synIdentifier">}</span>
    <span class="synIdentifier">}</span>
  <span class="synIdentifier">}</span>
<span class="synIdentifier">}</span>
</pre><p>フィルターにはさまざまなものがあり、<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-filters.html" target="_blank">query-dsl-filter</a>を参照ください。<br />
よく使うのは、<a class="keyword" href="http://d.hatena.ne.jp/keyword/%CA%A3%BF%F4">複数</a>のフィルタをANDやORで指定できる「boolフィルタ」や日付や数値の範囲で検索できる「rangeフィルタ」、termsフィルタやtermフィルタです。</p><br />
<p><h4>検索条件を実装</h4>まず、画面に<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>を追加します。</p>
<pre class="code lang-html" data-lang="html" data-unlink><span class="synComment">&lt;!-- app/views/top/index.html.erb --&gt;</span>
<span class="synIdentifier">&lt;</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>レストラン検索<span class="synIdentifier">&lt;/</span><span class="synStatement">h1</span><span class="synIdentifier">&gt;</span>

<span class="synComment">&lt;!-- 検索フォーム --&gt;</span>
<span class="synIdentifier">&lt;%=</span><span class="synConstant"> form_tag</span><span class="synIdentifier"> root_path, </span><span class="synType">method</span><span class="synIdentifier">: :get, enforce_utf8: false do %&gt;</span>
  ...
  
  <span class="synComment">&lt;!-- チェックボックスのフィールドを追加 --&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">div</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;checkbox&quot;</span><span class="synIdentifier">&gt;</span>
    <span class="synIdentifier">&lt;</span><span class="synStatement">label</span><span class="synIdentifier">&gt;</span>
      <span class="synIdentifier">&lt;%=</span><span class="synConstant"> check_box_tag</span><span class="synIdentifier"> :closed, </span><span class="synConstant">'t'</span><span class="synIdentifier">, params[:closed].present? %&gt;</span> 閉店しているレストランも検索結果に含める
    <span class="synIdentifier">&lt;/</span><span class="synStatement">label</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;/</span><span class="synStatement">div</span><span class="synIdentifier">&gt;</span>
  <span class="synIdentifier">&lt;</span><span class="synStatement">button</span><span class="synIdentifier"> </span><span class="synType">type</span><span class="synIdentifier">=</span><span class="synConstant">&quot;submit&quot;</span><span class="synIdentifier"> </span><span class="synType">class</span><span class="synIdentifier">=</span><span class="synConstant">&quot;btn btn-default&quot;</span><span class="synIdentifier">&gt;</span>検索<span class="synIdentifier">&lt;/</span><span class="synStatement">button</span><span class="synIdentifier">&gt;</span>
<span class="synIdentifier">&lt;% end %&gt;</span>
...
</pre><p><br />
次に、<code>search</code><a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%E1%A5%BD%A5%C3%A5%C9">メソッド</a>で<code>closed</code>の<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>が押されているかどうかを取得します。<br />
「閉店しているレストランも検索結果に含める」<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>が押されている場合のみ、<code>params[:closed]</code>に値が設定されるので、closed変数は<code>true</code>になります。<br />
<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>が押されていない場合は、blankになるので、closed変数は<code>false</code>になります。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>

<span class="synPreProc">def</span> <span class="synConstant">self</span>.<span class="synIdentifier">search</span>(params = {})
  <span class="synComment"># 検索パラメータを取得</span>
  keyword = params[<span class="synConstant">:q</span>]
  closed  = params[<span class="synConstant">:closed</span>].present?
  ...
</pre><p>次にフィルタを利用した<a class="keyword" href="http://d.hatena.ne.jp/keyword/DSL">DSL</a>を作成します。<br />
Elasticsearch::<a class="keyword" href="http://d.hatena.ne.jp/keyword/DSL">DSL</a>でのtermフィルタの使い方は、<a href="https://github.com/elastic/elasticsearch-ruby/blob/master/elasticsearch-dsl/lib/elasticsearch/dsl/search/filters/term.rb" target="_blank">elasticsearch-ruby/elasticsearch-dsl/lib/elasticsearch/dsl/search/filters/term.rb</a>に記載されているので参考にしてクエリを記載します。</p>
<pre class="code lang-ruby" data-lang="ruby" data-unlink><span class="synComment"># app/models/restaurant.rb</span>

search_definition = <span class="synType">Elasticsearch</span>::<span class="synType">DSL</span>::<span class="synType">Search</span>.search {
  query {
    filtered {
      query {
        <span class="synStatement">if</span> keyword.present?
          multi_match {
            query keyword
            fields <span class="synSpecial">%w{</span><span class="synConstant"> name name_kana address pref.name category.name </span><span class="synSpecial">}</span>
          }
        <span class="synStatement">else</span>
          match_all
        <span class="synStatement">end</span>
      }

      <span class="synComment"># 開店しているレストランのみ表示する条件(closed: false)</span>
      <span class="synComment"># closed=trueの場合は、この検索条件を実施しない</span>
      filter {
        term <span class="synConstant">closed</span>: <span class="synSpecial">'</span><span class="synConstant">false</span><span class="synSpecial">'</span>
      } <span class="synStatement">unless</span> closed
    }
  }
}
</pre><p><br />
<h4>フィルタの動作確認</h4><a href="http://localhost:3000/" target="_blank">http://localhost:3000/</a>でアクセスすると、検索結果が「開店しているレストラン4件」のみ表示されます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151018/20151018035057.png" alt="f:id:nipe880324:20151018035057p:plain:w320" title="f:id:nipe880324:20151018035057p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p>「閉店しているレストランも検索結果に含める」<a class="keyword" href="http://d.hatena.ne.jp/keyword/%A5%C1%A5%A7%A5%C3%A5%AF%A5%DC%A5%C3%A5%AF%A5%B9">チェックボックス</a>を選択し、検索ボタンを押すと、すべてのレストラン(6件)表示されます。<br />
<span itemscope itemtype="http://schema.org/Photograph"><img src="http://cdn-ak.f.st-hatena.com/images/fotolife/n/nipe880324/20151018/20151018035115.png" alt="f:id:nipe880324:20151018035115p:plain:w320" title="f:id:nipe880324:20151018035115p:plain:w320" class="hatena-fotolife" style="width:320px" itemprop="image"></span></p><p></p>

</div>
<div class="section">
    <h3>まとめ</h3>
    <p>これで、シンプルですが、<a class="keyword" href="http://d.hatena.ne.jp/keyword/Rails">Rails</a>とElasticsearchを使って、検索キーワードで検索をできるようにできました。<br />
これに、Elasticsearchの機能の「ページネーション・ページ当たりの表示数」、「ソート」、「ファセット・post_filter」、「ハイライト」、「サジェスト」などの機能を付け加えていけばより実践的な検索機能が実装できるようになります。</p><p>次は「<a href="../20151019/1445265581.html">ページネーションとページあたりの表示変更できる</a>」を実装します。</p><p>以上です。<br />
<br />
</p>

</div>
<div class="section">
    <h3>参考文献</h3>
    
<ul>
<li><a href="https://github.com/elastic/elasticsearch-rails/tree/master/elasticsearch-model">elasticsearch-rails/elasticsearch-model at master &middot; elastic/elasticsearch-rails &middot; GitHub</a> - Elasticsearchへの<a class="keyword" href="http://d.hatena.ne.jp/keyword/API">API</a></li>
<li><a href="https://github.com/elastic/elasticsearch-ruby/tree/master/elasticsearch-dsl">elasticsearch-ruby/elasticsearch-dsl at master &middot; elastic/elasticsearch-ruby &middot; GitHub</a> - クエリ作成</li>
<li><a href="https://www.elastic.co/guide/en/elasticsearch/reference/1.7/query-dsl-multi-match-query.html#type-best-fields">Multi Match Query</a> - multi matchクエリ</li>
</ul>
</div>
      
    </div>
    <footer class="entry-footer">
      <p class="entry-footer-section">
        <span class="author vcard"><span class="fn" data-load-nickname="1" data-user-name="nipe880324">nipe880324</span></span>
        <span class="entry-footer-time"><a href="1445142266.html"><time data-relative datetime="2015-10-18T04:24:26Z" title="2015-10-18T04:24:26Z" pubdate class="updated">2015-10-18 13:24</time></a></span>
      </p>

      

      
<div class="social-buttons">
  
  
    <div class="social-button-item">
      <a href="http://b.hatena.ne.jp/entry/http://ruby-rails.hatenadiary.com/entry/20151018/1445142266" class="hatena-bookmark-button" data-hatena-bookmark-layout="vertical-balloon" data-hatena-bookmark-lang="ja" title="この記事をはてなブックマークに追加"><img src="https://b.st-hatena.com/images/entry-button/button-only.gif" alt="この記事をはてなブックマークに追加" width="20" height="20" style="border: none;" /></a>
    </div>
  
  
  
    <div class="social-button-item">
      <a href="https://twitter.com/search?q=http%3A%2F%2Fruby-rails.hatenadiary.com%2Fentry%2F20151018%2F1445142266" class="social-button-twitter-balloon" target="_blank">
        <span class="social-button-twitter-balloon-list">list</span>
        <i class="social-button-twitter-balloon-arrow-border"></i>
        <u class="social-button-twitter-balloon-arrow"></u>
      </a>
      <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://ruby-rails.hatenadiary.com/entry/20151018/1445142266" data-count="vertical" data-text="RailsでElasticsearch: 全文検索を実装 - Rails Webook" data-lang="ja">Tweet</a>
    </div>
  
  
  
  
  
    <div class="social-button-item">
      <a data-pocket-label="pocket" data-save-url="http://ruby-rails.hatenadiary.com/entry/20151018/1445142266" data-pocket-count="vertical" class="pocket-btn" data-lang="en"></a>
    </div>
  
</div>


      
        
          
            
            <div class="google-afc-image test-google-rectangle-ads ">
              
              
                <script>
  var hatenadfp = hatenadfp || {};
  hatenadfp.adUnits = hatenadfp.adUnits || [];
  hatenadfp.adUnits.push(
    
      { unitName: 'blog_user', size: [[300, 250], [336, 280]], divId: 'google_afc_user_container_0', allowContentMatch: true }
    
  );
  hatenadfp.isNGContent = false;
  
</script>

                <div id="google_afc_user_container_0" class="google_afc_blocklink2_5 google_afc_boder"></div>
                
                  <a href="http://blog.hatena.ne.jp/guide/pro" class="open-pro-modal" data-guide-pro-modal-ad-url="http://hatenablog.com/guide/pro/modal/ad">広告を非表示にする</a>
                
                
              
            </div>
          
        
      

      <div class="customized-footer">

        

          

          

          
        
      </div>

      <div class="comment-box">
        
        <ul class="comment">
          
        </ul>
        
          <a class="leave-comment-title">コメントを書く</a>
        
      </div>
      <!-- enjapan ad -->
      
    </footer>
  </div>
</article>

                

                
                  
                  
                  <div class="permalink pager">
                    
                      
                      <span class="pager-prev">
                        <a href="../20151019/1445265581.html" rel="prev">
                          <span class="pager-arrow">« </span>
                          RailsでElasticsearch: ページネーション…
                        </a>
                      </span>
                    
                    
                      
                      <span class="pager-next">
                        <a href="../20151016/1444930756.html" rel="next">
                          Phoenix入門3 - WebSocketのチャット機能
                          <span class="pager-arrow"> »</span>
                        </a>
                      </span>
                    
                  </div>
                

              
            
            <!-- rakuten_ad_target_end -->
            <!-- google_ad_section_end -->

            
          
        </div>
      </div>

      
      <aside id="box1">
        <div id="box1-inner">
        </div>
      </aside>

    </div><!-- #wrapper -->

    <aside id="box2">
  
  <div id="box2-inner">
    
      
<div class="hatena-module hatena-module-html">
  <div class="hatena-module-body">
    <script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<!-- -->
<ins class="adsbygoogle"
     style="display:inline-block;width:160px;height:600px"
     data-ad-client="ca-pub-2736751992834286"
     data-ad-slot="8116686456"></ins>
<script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
  </div>
</div>

      
      
    
      

<div class="hatena-module hatena-module-profile">
  <div class="hatena-module-title">
    プロフィール
  </div>
  <div class="hatena-module-body">
    
    <a href="../../about.html" class="profile-icon-link">
      <img src="http://cdn1.www.st-hatena.com/users/ni/nipe880324/profile.gif?1406435422"
      alt="id:nipe880324" class="profile-icon" />
    </a>
    

    
    <span class="id">
      <a href="../../about.html" class="hatena-id-link"><span data-load-nickname="1" data-user-name="nipe880324">id:nipe880324</span></a>
      
  
    
    
  


    </span>
    

    

    
      <div class="hatena-follow-button-box btn-subscribe js-hatena-follow-button-box"
  
  >

  <a href="1445142266.html#" class="hatena-follow-button js-hatena-follow-button">
    <span class="subscribing">
      <span class="foreground">読者です</span>
      <span class="background">読者をやめる</span>
    </span>
    <span class="unsubscribing" data-track-name="profile-widget-subscribe-button" data-track-once>
      <span class="foreground">読者になる</span>
      <span class="background">読者になる</span>
    </span>
  </a>
  <div class="subscription-count-box js-subscription-count-box">
    <i></i>
    <u></u>
    <span class="subscription-count js-subscription-count">
    </span>
  </div>
</div>

    

    

    

    
  </div>
</div>

      
      
    
      
<div class="hatena-module hatena-module-entries-access-ranking"
     data-count="4"
     data-display_entry_category="1"
     data-display_entry_image="0"
     data-display_entry_image_size_width="100"
     data-display_entry_image_size_height="100"
     data-display_entry_body_length="0"
     data-display_entry_date="1"
     data-display_bookmark_count="0"
     data-source="access"
>
  <div class="hatena-module-title">
    
      最近のアクセス
    
  </div>
  <div class="hatena-module-body">
    
  </div>
</div>

      
      
    
      
<div class="hatena-module hatena-module-html">
    <div class="hatena-module-title">    </div>
  <div class="hatena-module-body">
    <nav>
  <div class="side-category">
    <span class="side-category-title">Rails 入門</span>
    <ul class="side-category-list">
      <li><a href="../20140713/1405251091.html">RailsのためのRuby基礎</a></li>
      <li><a href="../20140813/1407915718.html">Rails入門者向け ブログ開発</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Railsコマンド</span>
    <ul class="side-category-list">
      <li><a href="../20140713/1405251709.html">rails new / server / console</a></li>
      <li><a href="../20150204/1423055537.html">rails new時の有用な6つの設定</a></li>
      <li><a href="../20150208/1423391199.html">rails new時のテンプレート</a></li>
      <li><a href="../20140802/1406948695.html">rails generate</a></li>
      <li><a href="../20141116/1416115266.html">rakeコマンド一覧</a></li>
      <li><a href="../20141117/1416225563.html">自前rakeコマンド</a></li>
      <li><a href="../20141110/1415623670.html">productionモードで起動</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Route / Controller</span>
    <ul class="side-category-list">
      <li><a href="../20140716/1405451238.html">Routing</a></li>
      <li><a href="../20140810/1407603600.html">レイアウトファイルを指定</a></li>
      <li><a href="../20141125/1416918957.html">ビューを返す(render)</a></li>
      <li><a href="../20140808/1407427457.html">リダイレクトする(redirect_to)</a></li>
      <li><a href="../20141126/1417012848.html">Strong Parameters</a></li>
      <li><a href="../20141129/1417223453.html">フィルタ(before_action, after_action)</a></li>
      <li><a href="../20141127/1417086075.html">簡易なメッセージ表示(Flash)</a></li>
      <li><a href="../20141130/1417334030.html">セッション(session)</a></li>
      <li><a href="../20141201/1417432408.html">リクエストヘッダ、レスポンスヘッダ(request, response)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Model, Migration</span>
    <ul class="side-category-list">
      <li><a href="../20140724/1406142120.html">CRUD</a></li>
      <li><a href="../20141203/1417601540.html">1対多関連</a></li>
      <li><a href="../20141204/1417688260.html">多対多関連</a></li>
      <li><a href="../20141205/1417779929.html">1対1関連</a></li>
      <li><a href="../20141206/1417839458.html">STI(単一継承テーブル)</a></li>
      <li><a href="../20141207/1417926599.html">ポリモフィック関連</a></li>
      <li><a href="../20141208/1418018874.html">複数の子レコードを作成/更新</a></li>
      <li><a href="../20140724/1406145303.html">バリデーション(validation)</a></li>
      <li><a href="../20140810/1407623400.html">バリデーションエラー(validation errors)</a></li>
      <li><a href="../20140814/1407994568.html">スコープ(scope)</a></li>
      <li><a href="../20141211/1418301640.html">コールバック(callback)</a></li>
      <li><a href="../20150428/1430154446.html">複雑なSELECT文のまとめ</a></li>
      <li><a href="../20150710/1436461745.html">enum (Rails 4.1以上)</a></li>
      <li><a href="../20141209/1418123425.html">楽観的ロック</a></li>
      <li><a href="../20141210/1418207618.html">悲観的ロック</a></li>
      <li><a href="../20140810/1407634200.html">Migration(マイグレーション)</a></li>
      <li><a href="../20150607/1433606267.html">Postgresとマイグレーション</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">API</span>
    <ul class="side-category-list">
      <li><a href="../20150708/1436284476.html">Roar</a></li>
      <li>ActiveSerializer</li>
      <li>Versioning</li>
      <li>CORS</li>
    </ul>
  </div>

  <div class="side-category">
    <span class="side-category-title">View, Helper, Presenter</span>
    <ul class="side-category-list">
      <li><a href="../20140810/1407603600.html">レイアウトファイルを指定</a></li>
      <li><a href="../20140807/1407419013.html">部分テンプレート</a></li>
      <li><a href="../20140727/1406448610.html">フォーム周りのMVC連携フロー</a></li>
      <li><a href="../20150113/1421149061.html">ビューヘルパーまとめ(View Helper)</a></li>
      <li><a href="../20140802/1406969793.html">フォーマットヘルパー</a></li>
      <li><a href="../20140803/1407049200.html">独自ヘルパー作成</a></li>
      <li><a href="../20141208/1418018874.html">複数の子レコード(has_many)を作成/更新するフォーム</a></li>
      <li><a href="../20141225/1419515057.html">1フォームに複数のSubmitボタンを配置</a></li>
      <li><a href="../20140730/1406700205.html">simple_form</a></li>
      <li><a href="../20150415/1429031791.html">Draper</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">テンプレートエンジン</span>
    <ul class="side-category-list">
      <li><a href="../20140929/1411997071.html">HTMLテンプレートエンジンまとめ</a></li>
      <li><a href="../20140929/1411997071.html">Slim</a></li>
      <li><a href="../20141001/1412097051.html">Haml</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ActionSupport / ActionMailer / ActiveJob / i18n</span>
    <ul class="side-category-list">
      <li><a href="../20141217/1418817120.html">タイムゾーン、時刻処理</a></li>
      <li><a href="../20141218/1418901424.html">Timecop 時刻処理のテスト</a></li>
      <li><a href="../20141216/1418729961.html">クラス名,DB名,ファイル名の変換</a></li>
      <li><a href="../20141230/1419936984.html">JSON, XML, YAMLの読み書き</a></li>
      <li><a href="../20141030/1414599853.html">文字コード/エンコード</a></li>
      <li><a href="../20140828/1409236436.html">メール送信</a></li>
      <li><a href="../20150304/1425396671.html">DelayedJob バックグラウンド処理</a></li>
      <li><a href="../20150110/1420863998.html">ログ・ログレベル・ログフォーマット(log, logger)</a></li>
      <li><a href="../20150226/1424937175.html">i18nまとめ</a></li>
      <li><a href="../20141111/1415707101.html">エラーハンドリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">テスト</span>
    <ul class="side-category-list">
      <li><a href="../20150101/1420093487.html">RSpec/Capybaraの導入方法</a></li>
      <li><a href="../20150103/1420280252.html">RSpec/Capybaraのレシピ集</a></li>
      <li><a href="../20150101/1420093487.html">FactoryGirlのレシピ集</a></li>
      <li><a href="../20150105/1420465062.html">Jasmine(Javascriptの単体テスト)</a></li>
      <li><a href="../20150108/1420675366.html">APIの作成とテスト</a></li>
      <li><a href="../20150106/1420545920.html">RSpecテストを速くする</a></li>
      <li><a href="../20150108/1420721205.html">デバッグ(debug)</a></li>
      <li><a href="../20150420/1429462755.html">Seleniumでスタンドアローンなテスト</a></li>
      <li><a href="../20140719/1405708234.html">Cucumber+RSpec+Capybara インストール</a></li>
      <li><a href="../20140719/1405777918.html">Cucumber+RSpec+Capybara BDD/TDD開発例</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Security</span>
    <ul class="side-category-list">
      <li><a href="../20141215/1418641291.html">ログ上での秘密情報のフィルタリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">パフォーマンス</span>
    <ul class="side-category-list">
      <li><a href="../20141109/1415522242.html">Bullet</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">設定</span>
    <ul class="side-category-list">
      <li><a href="../20141224/1419414316.html">新しいEnvironmentを追加</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">UI/UX</span>
    <ul class="side-category-list">
      <li><a href="../20140801/1406818800.html">Twitter Bootstrap 3</a></li>
      <li><a href="../20141112/1415804076.html">select2</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Gemの基礎</span>
    <ul class="side-category-list">
      <li><a href="../20140715/1405361727.html">RubyGemsの選び方</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ログイン/認証機能</span>
    <ul class="side-category-list">
      <li><a href="../20140801/1406907000.html">devise1 インストール</a></li>
      <li><a href="../20140804/1407168000.html">devise2 カスタマイズ</a></li>
      <li><a href="../20140805/1407200400.html">devise3 Twitterでログイン(OAuth連携)</a></li>
      <li><a href="../20141212/1418380288.html">devise4 ゲストユーザー(Guest)作成</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ファイルアップロード機能</span>
    <ul class="side-category-list">
      <li><a href="../20140716/1405443484.html">PaperClip</a></li>
      <li><a href="../20141015/1413300088.html">CarrierWave1 インストール</a></li>
      <li><a href="../20141022/1413907332.html">CarrierWave2 カスタマイズ</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">検索機能・Elasticsearch</span>
    <ul class="side-category-list">
      <li><a href="../20141008/1412774436.html">Ransack 検索機能</a></li>
      <li><a href="../20150224/1424776132.html">Sunspot 全文検索</a></li>
      <li><a href="1445142266.html">Elasticsearch 1: 全文検索・フィルタ</a></li>
      <li><a href="../20151019/1445265581.html">Elasticsearch 2: ページネーション</a></li>
      <li><a href="../20151021/1445353566.html">Elasticsearch 3: ソート</a></li>
      <li><a href="../20151022/1445439798.html">Elasticsearch 4: アグリゲーション（ファセット）・post_filter</a></li>
      <li><a href="../../20151025/1445703231.html">Elasticsearch 5: ハイライト</a></li>
      <li><a href="../20151027/1445957667.html">Elasticsearch 6: サジェスト</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">ページネーション</span>
    <ul class="side-category-list">
      <li><a href="../20141118/1416314608.html">ページネーションまとめ</a></li>
      <li><a href="../20141113/1415874683.html">kaminari</a></li>
      <li><a href="../20141114/1415967206.html">will_paginate</a></li>
      <li><a href="../20141115/1416021886.html">動的ページロード</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">CSV</span>
    <ul class="side-category-list">
      <li><a href="../20141119/1416398472.html">CSVダウンロード</a></li>
      <li><a href="../20141120/1416483136.html">CSVアップロード</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">PDFファイル作成機能</span>
    <ul class="side-category-list">
      <li><a href="../20140906/1409995011.html">PDF作成Gem まとめ</a></li>
      <li><a href="../20140907/1410078997.html">コードのみでPDF作成 Prawn</a></li>
      <li><a href="../20140908/1410176894.html">HTMLを変換してPDF作成 PDFKit + wkhtmltopdf</a></li>
      <li><a href="../20140909/1410241835.html">GUIツールでPDF作成 ThinReports</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発効率をあげる</span>
    <ul class="side-category-list">
      <li><a href="../20141026/1414289421.html">Spring</a></li>
      <li><a href="../20141016/1413389293.html">Guard-LiveReload</a></li>
      <li><a href="../20141021/1413819783.html">Guard-RSpec</a></li>
      <li><a href="../20141019/1413698128.html">Guard-RuboCop</a></li>
      <li><a href="../20141024/1414081224.html">Pry-Rails / Pry-BuyBug</a></li>
      <li><a href="../20141024/1414160189.html">Hirb</a></li>
      <li><a href="../20141028/1414505988.html">Awesome Print</a></li>
      <li><a href="../20141029/1414584929.html">Quiet Assets</a></li>
      <li><a href="../20141025/1414225490.html">Better_Errors</a></li>
      <li><a href="../20141027/1414409495.html">Rails-ERD</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">その他Gem</span>
    <ul class="side-category-list">
      <li><a href="../20150225/1424858414.html">acts-as-taggable-on タグ管理</a></li>
      <li><a href="../20141016/1413389293.html">wenerber Cron設定</a></li>
      <li><a href="../20150221/1424489524.html">friendly_id URLスラッグ</a></li>
      <li><a href="../20150216/1424092796.html">awesome_nested_set ツリー構造</a></li>
      <li><a href="../20150217/1424179269.html">awesome_nested_set にjsTreeを追加</a></li>
      <li><a href="../20150214/1423923524.html">PaperTrail 取り消し機能</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Tips</span>
    <ul class="side-category-list">
      <li><a href="../20141229/1419856433.html">Virtual Attributes(仮想属性)</a></li>
      <li><a href="../20141226/1419600679.html">日付/時刻のフォーマット</a></li>
      <li><a href="../20141225/1419515057.html">1フォームに複数のSubmitボタンを配置</a></li>
      <li><a href="../20141223/1419334845.html">URLのパーマリンクをID以外に変更</a></li>
      <li><a href="../20141220/1419058040.html">CSSスタイリングのコントローラー単位で分割</a></li>
      <li><a href="../20141219/1418990626.html">ページタイトルの変更</a></li>
      <li><a href="../20150101/1420049679.html">Ruby/Railsの便利なメソッド(useful methods)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Rubyテクニック</span>
    <ul class="side-category-list">
      <li><a href="../20150921/1442839934.html">キーワード引数</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">良い設計/リファクタリング</span>
    <ul class="side-category-list">
      <li><a href="../20150922/1442923521.html">デメテルの法則(Law of Demeter)</a></li>
      <li><a href="../20150312/1426141352.html">HTML/CSS/JSを疎結合にする方法</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">JavaScript</span>
    <ul class="side-category-list">
      <li><a href="../20150311/1426062668.html">オブジェクト指向</a></li>
      <li><a href="../20150313/1426238835.html">thisの参照先</a></li>
      <li><a href="../20150317/1426599220.html">設定データを分離</a></li>
      <li><a href="../20150607/1433652441.html">ページを離れる時にアラートを出す</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">jQuery</span>
    <ul class="side-category-list">
      <li><a href="../20150325/1427291741.html">Ajax</a></li>
      <li><a href="../20150326/1427379215.html">イベント処理(Event)</a></li>
      <li><a href="../20150331/1427809820.html">DOM操作</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">React.js</span>
    <ul class="side-category-list">
      <li><a href="../20151122/1448118932.html">React.jsチュートリアル: メッセージボックス</a></li>
      <li><a href="../20151124/1448300267.html">サーバーレンダリング</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">AngularJS</span>
    <ul class="side-category-list">
      <li><a href="../20150114/1421235346.html">AngularJSのインストール</a></li>
      <li><a href="../20150115/1421316461.html">UI Bootstrapのインストール</a></li>
      <li><a href="../20150116/1421407124.html">AngularJS Controller</a>
      <li><a href="../20150119/1421666497.html">ngResource + RailsでAPI作成</a></li>
      <li><a href="../20150120/1421761471.html">ngRoute</a></li>
      <li><a href="../20150126/1422276839.html">編集可能(Editable)</a></li>
      <li><a href="../20150127/1422357163.html">ソート可能(Sortable)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発手法</span>
    <ul class="side-category-list">
      <li><a href="../20140917/1410963376.html">スクラム開発</a></li>
      <li><a href="../20141010/1412867452.html">カイゼンフレームワークKPT</a>
      <li><a href="../20140816/1408126999.html">GitHubを使ったチーム開発フロー</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">開発ツール</span>
    <ul class="side-category-list">
      <li><a href="../20141103/1414940400.html">git - 初期設定と便利なエイリアス</a></li>
      <li><a href="../20140713/1405248403.html">git - よく使うコマンド</a></li>
      <li><a href="../20140724/1406137504.html">SublimeText3 - 便利コマンドとプラグイン</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">DB</span>
    <ul class="side-category-list">
      <li><a href="../20140726/1406331785.html">MongoDBの基礎入門 CRUD操作</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">インフラ</span>
    <ul class="side-category-list">
      <li><a href="../20150719/1437249020.html">Vagrant</a></li>
      <li><a href="../20150721/1437404524.html">Chef(Rails環境構築)</a></li>
      <li><a href="../20150314/1426332751.html">Herokuの準備とデプロイ</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">リファレンス</span>
    <ul class="side-category-list">
      <li><a href="https://github.com/" target="_blank">GitHub</a></li>
      <li><a href="http://guides.rubyonrails.org/index.html" target="_blank">RailsGuides</a></li>
      <li><a href="http://railscasts.com/" target="_blank">RailsCast</a></li>
      <li><a href="https://rubygems.org/" target="_blank">RubyGems</a></li>
      <li><a href="https://www.ruby-toolbox.com/" target="_blank">RubyToolbox</a></li>
      <li><a href="http://rubular.com/" target="_blank">正規表現 Rubular</a></li>
      <li><a href="http://ruby-doc.org/core-2.1/" target="_blank">Ruby API (2.1)</a></li>
      <li><a href="http://api.rubyonrails.org/" target="_blank">Ruby on Rails API (4.1)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">Phoenix</span>
    <ul class="side-category-list">
      <li><a href="../20151011/1444560106.html">Phoenix環境設定(Phoenix入門1)</a></li>
      <li><a href="../20151013/1444662887.html">基本的な認証機能(Phoenix入門2)</a></li>
      <li><a href="../20151016/1444930756.html">基本的なチャット機能(Phoenix入門3)</a></li>
    </ul>
  </div>
  <div class="side-category">
    <span class="side-category-title">その他</span>
    <ul class="side-category-list">
      <li><a href="../20150401/1427898898.html">広告収入向上</a></li>
      <li><a href="../20140830/1409361710.html">著者が読んだ本</a></li>
    </ul>
  </div>
</nav>

  </div>
</div>

      
      
    
      

<div class="hatena-module hatena-module-archive" data-archive-type="default" data-archive-url="../../archive.html">
  <div class="hatena-module-title">
    <a href="../../archive.html">月別アーカイブ</a>
  </div>
  <div class="hatena-module-body">
  </div>
</div>

      
      
    
    
  </div>
</aside>

  </div>
</div>




        
        
          <script type="text/javascript" src="http://b.hatena.ne.jp/js/hatena_dfp2.js"></script>
        
        
          <div id="bottom-editarea">
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>
$('.unsubscribing').on('click', function() {
    ga('send', 'event', 'button', 'click', 'hatenaReader');  
});
</script>
          </div>
        
      </div>
    </div>

    
      <footer id="footer" data-brand="hatenablog">
  <div id="footer-inner">
    <address>
      
      <a href="../../about.html"><img src="http://cdn1.www.st-hatena.com/users/ni/nipe880324/profile.gif" width="16" height="16" alt=""/>
        <span data-load-nickname="1" data-user-name="nipe880324">nipe880324</span>
      </a>
    </address>
    <p class="services">Powered by <a href="http://hatenablog.com/">Hatena Blog</a></p>
  </div>
</footer>

    

    
  <script type="text/javascript">!function(d,i){if(!d.getElementById(i)){var j=d.createElement("script");j.id=i;j.src="https://widgets.getpocket.com/v1/j/btn.js?v=1";var w=d.getElementById(i);d.body.appendChild(j);}}(document,"pocket-btn-js");</script>


    

    <script type="text/javascript" src="https://platform.twitter.com/widgets.js"></script>
<script type="text/javascript" src="https://apis.google.com/js/plusone.js">
  {"parsetags": "explicit"}
</script>
<script type="text/javascript" src="https://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script>



  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-with-addons.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/react/0.14.7/react-dom.min.js"></script>


<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery-1.9.1.min.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery-ui.1.10.0.custom.min.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery.flot.0.8.3.js"></script>
<script type="text/javascript" src="http://cdn7.www.st-hatena.com/js/jquery/jquery.flot.time.0.8.3.js"></script>



<script id="hatenablog-js" data-env="production"
  type="text/javascript" src="https://blog.st-hatena.com/js/hatenablog.js?version=228df9a6e5a3ae04fdb53d33befa3556" crossorigin="anonymous"></script>
<script type="text/javascript" src="https://blog.st-hatena.com/js/texts-ja.js?version=228df9a6e5a3ae04fdb53d33befa3556"></script>


  <script type="text/javascript">Hatena.Diary.GlobalHeader.init()</script>


<script src="https://www.google.com/recaptcha/api.js" async defer></script>




    


    
       

  <script id="hatena-counter-script" type="text/javascript"><!--
      hatena_counter_name = "nipe880324";
      hatena_counter_id = "102";
      hatena_counter_ref = document.referrer+"";
      hatena_counter_screen = screen.width + "x" + screen.height+","+screen.colorDepth;
  //--></script>
  <script type="text/javascript" src="http://counter.hatena.ne.jp/js/counter.js"></script>
  <noscript><img src="http://counter.hatena.ne.jp/nipe880324/102" border="0" alt="counter"></noscript>


    

  </body>
</html>

